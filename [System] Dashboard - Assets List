/*
 * Template Name: System Dashboard - Assets List (V26.0 - Full Code & Child Fixed)
 * Description: 
 * - [BASE] Based STRICTLY on V22.0 provided code.
 * - [UX FIX] Bundle Child Cards can now be toggled ON/OFF freely (Removed restrictive onclick).
 * - [DATA FIX] Bundle Child Cards now show FULL details (Warranty, Claims, Repairs) identical to Single Products.
 * - [SAFETY] Added explicit variable resets in child loops to prevent data bleeding (Inactive bug).
 * - [CSS] KEPT ORIGINAL 100% (No Minification).
 * Author: Dinoco Dev Team x UX Specialist
 * Version: 26.0
 */

// [SECURITY] ห้าม Cache
if ( ! defined( 'DONOTCACHEPAGE' ) ) {
    define( 'DONOTCACHEPAGE', true );
}

// --------------------------------------------------------------------------
// 1. HELPER FUNCTION: CUSTOM LOGGER (SECURED)
// --------------------------------------------------------------------------
if ( ! function_exists( 'dinoco_security_log' ) ) {
    function dinoco_security_log( $action, $user_id, $details ) {
        $upload_dir = wp_upload_dir();
        
        // [SECURITY FIX] สร้างชื่อไฟล์แบบสุ่ม (Hash) และซ่อนด้วย . (Dotfile)
        $secure_hash = md5( 'dinoco_secret_salt_' . date('Ym') ); 
        $log_file = $upload_dir['basedir'] . '/.dinoco_audit_' . $secure_hash . '.log';
        
        // [SECURITY FIX] สร้าง .htaccess ดักการเข้าถึงไฟล์ Log (ถ้ายังไม่มี)
        $htaccess_file = $upload_dir['basedir'] . '/.htaccess_dinoco_logs'; 
        
        $timezone = new DateTimeZone('Asia/Bangkok');
        $date = new DateTime('now', $timezone);
        $timestamp = $date->format('Y-m-d H:i:s');
        
        $user_ip = '';
        if ( ! empty( $_SERVER['HTTP_CLIENT_IP'] ) ) {
            $user_ip = $_SERVER['HTTP_CLIENT_IP'];
        } elseif ( ! empty( $_SERVER['HTTP_X_FORWARDED_FOR'] ) ) {
            $user_ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
        } else {
            $user_ip = $_SERVER['REMOTE_ADDR'];
        }
        
        $log_entry = sprintf(
            "[%s] AUTH: User %s | IP: %s | Action: %s | Details: %s" . PHP_EOL,
            $timestamp,
            $user_id,
            $user_ip,
            strtoupper($action),
            $details
        );
        
        @file_put_contents( $log_file, $log_entry, FILE_APPEND | LOCK_EX );
    }
}

add_shortcode( 'dinoco_dashboard_assets', 'dinoco_dashboard_assets_func' );

function dinoco_dashboard_assets_func() {
    
    // [SECURITY] Headers Force No-Cache
    if ( ! is_admin() ) {
        nocache_headers();
        header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
        header("Pragma: no-cache");
    }

    if ( ! is_user_logged_in() ) {
        return '<div style="padding:20px; text-align:center; color:red;">กรุณาเข้าสู่ระบบก่อนใช้งาน</div>';
    }

    $current_user_id = get_current_user_id();
    $current_user = wp_get_current_user();
    $current_username = $current_user->user_login;
    
    // --------------------------------------------------------------------------
    // 2. ACTION HANDLER
    // --------------------------------------------------------------------------
    if ( $_SERVER['REQUEST_METHOD'] === 'POST' && isset( $_POST['dinoco_request_v10'] ) ) {
        
        while ( ob_get_level() ) { ob_end_clean(); }
        header('Content-Type: application/json; charset=utf-8');
        error_reporting(0); @ini_set('display_errors', 0);
        
        // [LAYER 1: Token Soft-Fail]
        $received_nonce = isset($_POST['dinoco_auth_v10']) ? $_POST['dinoco_auth_v10'] : '';
        if ( ! wp_verify_nonce( $received_nonce, 'dinoco_nonce_action' ) ) {
             dinoco_security_log('TOKEN_WARNING', $current_user_id, "Token Invalid - Proceeding to Ownership Check");
        }

        $action = $_POST['dinoco_request_v10'];

        // --- ACTION: CREATE BUNDLE ---
        if ( $action === 'create_bundle' ) {
            $target_sku = isset($_POST['target_sku']) ? sanitize_text_field($_POST['target_sku']) : '';
            $child_ids  = isset($_POST['child_ids']) ? $_POST['child_ids'] : [];
            
            if ( empty($target_sku) || empty($child_ids) || !is_array($child_ids) ) {
                echo json_encode(['success' => false, 'msg' => 'ข้อมูลไม่ครบถ้วน']);
                exit;
            }

            $safe_child_ids = array_map('intval', $child_ids);

            foreach ($safe_child_ids as $chk_id) {
                $db_owner = get_post_meta($chk_id, 'owner_product', true);
                if ( trim( (string)$db_owner ) !== trim( (string)$current_username ) ) {
                    echo json_encode(['success' => false, 'msg' => "SECURITY: สินค้า ID $chk_id ไม่ใช่ของคุณ"]);
                    exit;
                }
                
                $existing = get_post_meta($chk_id, 'current_bundle_id', true);
                if ( ! empty($existing) ) {
                    echo json_encode(['success' => false, 'msg' => "สินค้าถูกรวมชุดไปแล้ว"]);
                    exit;
                }
            }

            $first_child_id = $safe_child_ids[0];
            $owner_line_id_val = get_post_meta($first_child_id, 'owner_product', true);

            $bundle_post_data = [
                'post_title'    => 'Set ' . $target_sku . ' - ' . date('YmdHis'),
                'post_type'     => 'product_bundle',
                'post_status'   => 'publish',
                'post_author'   => $current_user_id
            ];
            $bundle_id = wp_insert_post( $bundle_post_data );

            if ( $bundle_id && ! is_wp_error( $bundle_id ) ) {
                update_post_meta($bundle_id, 'bundle_sku', $target_sku);
                update_post_meta($bundle_id, 'bundle_owner', $current_user_id);
                update_post_meta($bundle_id, 'bundle_owner_id', $owner_line_id_val);
                
                if ( function_exists('update_field') ) {
                    update_field('bundle_children', $safe_child_ids, $bundle_id);
                } else {
                    update_post_meta($bundle_id, 'bundle_children', $safe_child_ids);
                }

                foreach ($safe_child_ids as $cid) {
                    update_post_meta($cid, 'current_bundle_id', $bundle_id);
                }
                
                dinoco_security_log( 'CREATE_SUCCESS', $current_user_id, "Bundle $bundle_id Created" );
                echo json_encode(['success' => true, 'msg' => 'รวมเซ็ตสำเร็จ!']);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Create Failed']);
            }
            exit;
        }
        
        // --- ACTION: DELETE BUNDLE ---
        if ( $action === 'delete_bundle' ) {
            $bundle_id = isset($_POST['bundle_id']) ? intval($_POST['bundle_id']) : 0;
            
            if ( $bundle_id > 0 ) {
                $verify_owner = get_post_meta($bundle_id, 'bundle_owner', true);
                if ( intval($verify_owner) !== intval($current_user_id) && !current_user_can('manage_options') ) {
                     echo json_encode(['success' => false, 'msg' => 'คุณไม่มีสิทธิ์ลบรายการนี้']);
                     exit;
                }

                $children = [];
                if ( function_exists('get_field') ) {
                    $acf_c = get_field('bundle_children', $bundle_id);
                    if ( $acf_c && is_array($acf_c) ) {
                        $children = $acf_c;
                    }
                }
                if ( empty($children) ) {
                    $meta_c = get_post_meta($bundle_id, 'bundle_children', true);
                    if ( $meta_c ) {
                         $children = is_array($meta_c) ? $meta_c : [$meta_c];
                         if(isset($children[0]) && is_array($children[0])) $children = $children[0];
                    }
                }
                
                if ( !empty($children) ) {
                    foreach ( $children as $child ) {
                        $cid = is_object($child) ? $child->ID : $child;
                        $cid = intval($cid);
                        if($cid > 0) delete_post_meta($cid, 'current_bundle_id');
                    }
                }
                
                wp_delete_post($bundle_id, true);
                
                dinoco_security_log( 'DELETE_SUCCESS', $current_user_id, "Deleted Bundle $bundle_id" );
                echo json_encode(['success' => true, 'msg' => 'แยกเซ็ตเรียบร้อย']);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Invalid ID']);
            }
            exit;
        }

        // --- ACTION: SAVE TRACKING ---
        if ( $action === 'save_track' ) {
             $tid = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
             $track = isset($_POST['tracking']) ? sanitize_text_field($_POST['tracking']) : '';
             if($tid && $track) {
                 update_post_meta($tid, 'tracking_inbound', $track);
                 update_post_meta($tid, 'ticket_status', 'shipping_in');
                 echo json_encode(['success' => true]);
             } else {
                 echo json_encode(['success' => false, 'msg' => 'Error']);
             }
             exit;
        }

        // --- ACTION: CONFIRM RECEIPT ---
        if ( $action === 'confirm_receipt' ) {
            $tid = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
            if($tid) {
                update_post_meta($tid, 'ticket_status', 'completed');
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false]);
            }
            exit;
        }
        
        // --- ACTION: REPORT STOLEN ---
        if ( $action === 'report_stolen' ) {
            $pid = isset($_POST['product_id']) ? intval($_POST['product_id']) : 0;
            
            if ( $pid > 0 ) {
                $db_owner = get_post_meta($pid, 'owner_product', true);
                if ( trim( (string)$db_owner ) !== trim( (string)$current_username ) ) {
                     echo json_encode(['success' => false, 'msg' => "SECURITY: สินค้า ID $pid ไม่ใช่ของคุณ"]);
                     exit;
                }
                
                update_post_meta($pid, 'w_status', 'stolen');
                dinoco_security_log('REPORT_STOLEN', $current_user_id, "Reported Stolen Item ID: $pid");
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Invalid ID']);
            }
            exit;
        }
    }

    // --------------------------------------------------------------------------
    // 3. DISPLAY LOGIC (FRONTEND)
    // --------------------------------------------------------------------------
    $dinoco_system_notice = get_query_var('dinoco_notice_msg', '');
    $product_catalog = get_option( 'dinoco_product_catalog', [] );
    if ( ! is_array( $product_catalog ) ) { $product_catalog = []; }
    $sku_relations = get_option( 'dinoco_sku_relations', [] );
    if ( ! is_array( $sku_relations ) ) { $sku_relations = []; }

    $bundle_recipes = [];
    if ( ! empty( $sku_relations ) ) {
        foreach ( $sku_relations as $parent_sku => $child_skus ) {
            $set_info = isset( $product_catalog[$parent_sku] ) ? $product_catalog[$parent_sku] : [];
            $safe_img = !empty($set_info['img']) ? $set_info['img'] : 'https://placehold.co/150x150?text=Set';
            $bundle_recipes[$parent_sku] = [
                'name'    => !empty($set_info['name']) ? $set_info['name'] : 'Set Bundle (' . $parent_sku . ')',
                'img'     => $safe_img,
                'req_sku' => $child_skus
            ];
        }
    }

    $thai_couriers = [
        'Thailand Post' => 'ไปรษณีย์ไทย (Thailand Post)', 'Kerry Express' => 'Kerry Express', 'Flash Express' => 'Flash Express', 'J&T Express' => 'J&T Express', 'DHL' => 'DHL eCommerce', 'Best Express' => 'Best Express', 'Ninja Van' => 'Ninja Van', 'SCG Express' => 'SCG Express', 'Inter Express' => 'Inter Express', 'Nim Express' => 'Nim Express', 'GrabExpress' => 'GrabExpress (Messenger)', 'Lineman' => 'Lineman (Messenger)'
    ];

    $action_map = [ 
        'fg_10'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) 10%','fg_l_10'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างซ้าย 10%','fg_r_10'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างขวา 10%','fg_20'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) 20%','fg_l_20'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างซ้าย 20%','fg_r_20'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างขวา 20%','fg_30'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) 30%','fg_l_30'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างซ้าย 30%','fg_r_30'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างขวา 30%','fg_40'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) 40%','fg_l_40'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างซ้าย 40%','fg_r_40'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างขวา 40%','fg_50'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) 50%','fg_l_50'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างซ้าย 50%','fg_r_50'=>'ซ่อมบำรุงโครงสร้างกันล้มบน (Fairing Guard) ข้างขวา 50%','eg_10'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) 10%','eg_l_10'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างซ้าย 10%','eg_r_10'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างขวา 10%','eg_20'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) 20%','eg_l_20'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างซ้าย 20%','eg_r_20'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างขวา 20%','eg_30'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) 30%','eg_l_30'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างซ้าย 30%','eg_r_30'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างขวา 30%','eg_40'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) 40%','eg_l_40'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างซ้าย 40%','eg_r_40'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างขวา 40%','eg_50'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) 50%','eg_l_50'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างซ้าย 50%','eg_r_50'=>'ซ่อมบำรุงโครงสร้างกันล้มล่าง (Engine Guard) ข้างขวา 50%','tr_10'=>'ซ่อมบำรุงโครงสร้างแร็คหลัง (TopRack) 10%','tr_20'=>'ซ่อมบำรุงโครงสร้างแร็คหลัง (TopRack) 20%','tr_30'=>'ซ่อมบำรุงโครงสร้างแร็คหลัง (TopRack) 30%','tr_40'=>'ซ่อมบำรุงโครงสร้างแร็คหลัง (TopRack) 40%','tr_50'=>'ซ่อมบำรุงโครงสร้างแร็คหลัง (TopRack) 50%','sr_10'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) 10%','sr_l_10'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างซ้าย 10%','sr_r_10'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างขวา 10%','sr_20'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) 20%','sr_l_20'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างซ้าย 20%','sr_r_20'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างขวา 20%','sr_30'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) 30%','sr_l_30'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างซ้าย 30%','sr_r_30'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างขวา 30%','sr_40'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) 40%','sr_l_40'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างซ้าย 40%','sr_r_40'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างขวา 40%','sr_50'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) 50%','sr_l_50'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างซ้าย 50%','sr_r_50'=>'ซ่อมบำรุงโครงสร้างแร็คข้าง (SideRack) ข้างขวา 50%','repaint_minor'=>'ซ่อมบำรุงกันล้มทำสีเล็กน้อย','align_minor'=>'ซ่อมบำรุงปรับองศาซ้าย-ขวา เล็กน้อย','align_medium'=>'ซ่อมบำรุงปรับองศาซ้าย-ขวา ปานกลาง','rep_plastic'=>'ซ่อมบำรุงเปลี่ยนมุมพลาติก','rep_plastic_l'=>'ซ่อมบำรุงเปลี่ยนมุมพลาสติก ด้านซ้าย','rep_plastic_r'=>'ซ่อมบำรุงเปลี่ยนมุมพลาสติก ด้านขวา','rep_key'=>'ซ่อมบำรุงเปลี่ยนชุดกุญแจ','rep_mount'=>'ซ่อมบำรุงเปลี่ยนชุดยึดถาดกล่อง(ที่ตัวกล่อง)','rep_tray'=>'ซ่อมบำรุงเปลี่ยนชุดถาดกล่อง','rep_seal'=>'ซ่อมบำรุงซีลกันน้ำใหม่ทั้งใบ','original'=>'Original : สภาพสมบูรณ์','repaired'=>'Repainted : เก็บงานสี','minor_fix'=>'Minor Fix : ดัดจัดทรง','welded'=>'Welded : ซ่อมดัดปรับจุดยึด','modified'=>'Modified : ดัดแปลง/ซ่อมหนัก','sticker_45l_1'=>'สติกเกอร์แถบข้าง 45L 1 ชุด (2แผ่น)','sticker_38l_1'=>'สติกเกอร์แถบข้าง 38L 1 ชุด (2แผ่น)','sticker_38l_2'=>'สติกเกอร์แถบข้าง 38L 1 ชุด (4แผ่น)','sticker_hand'=>'สติกเกอร์การ์ดแฮนด์ 1 ชุด (2แผ่น)','plate_nx500'=>'ประกับหน้า NX500 แบบเว้า 1 ชิ้น','plate_dinoco_1'=>'ประกับ DINOCO 1 ชิ้น','plate_dinoco_2'=>'ประกับ DINOCO 2 ชิ้น','plate_dinoco_3'=>'ประกับ DINOCO 3 ชิ้น','plate_dinoco_4'=>'ประกับ DINOCO 4 ชิ้น','plate_dinoco_5'=>'ประกับ DINOCO 5 ชิ้น'
    ];

    $status_display_map = [ 
        'warranty_on'        => 'รับประกันสินค้าสินค้าใหม่สภาพสมบูรณ์', 
        'original'           => 'รับประกันสินค้าสินค้าใหม่สภาพสมบูรณ์', 
        'repaired'           => 'ผ่านการซ่อมบำรุง', 
        'refurbished'        => 'สภาพพร้อมใช้งาน', 
        'modified'           => 'ดัดแปลงสภาพ', 
        'repainted'          => 'เก็บงานสี', 
        'minor_fix'          => 'ดัดจัดทรง', 
        'welded'             => 'ซ่อมดัดปรับจุดยึด', 
        'claim_process'      => 'อยู่ระหว่างดำเนินการซ่อมบำรุง', 
        'warranty_pending'   => 'รอตรวจสอบประกัน ติดต่อแอดมิน', 
        'warranty_expiry'    => 'หมดอายุการรับประกัน', 
        'warranty_available' => 'สามารถลงทะเบียนรับประกันได้',
        'stolen'             => 'สินค้าถูกขโมยระงับสิทธิ์',
        'inactive'           => 'สถานะไม่ระบุ/ระงับชั่วคราว'
    ];

    // Queries Logic
    $my_bundles = new WP_Query([ 
        'post_type' => 'product_bundle', 
        'posts_per_page' => -1, 
        'meta_query' => [[ 'key' => 'bundle_owner', 'value' => $current_user_id, 'compare' => '=' ]] 
    ]);

    $my_singles = new WP_Query([ 
        'post_type' => 'serial_number', 
        'posts_per_page' => -1, 
        'meta_key' => 'owner_product', 
        'meta_value' => $current_username,
        'meta_query' => [ 
            'relation' => 'AND', 
            [ 
                'relation' => 'OR', 
                ['key' => 'current_bundle_id', 'compare' => 'NOT EXISTS'], 
                ['key' => 'current_bundle_id', 'value' => '', 'compare' => '='] 
            ] 
        ] 
    ]);
    
    // Bundle Opportunity Check Logic
    $inventory_map = []; 
    $ready_to_bundle = [];

    if ( $my_singles->have_posts() ) { 
        while ( $my_singles->have_posts() ) { 
            $my_singles->the_post(); 
            $s_id = get_the_ID(); 
            $s_sku = get_post_meta($s_id, 'product_sku', true);
            if ( $s_sku ) { 
                if ( !isset($inventory_map[$s_sku]) ) $inventory_map[$s_sku] = []; 
                $inventory_map[$s_sku][] = $s_id; 
            } 
        } 
        $my_singles->rewind_posts(); 
    }

    foreach ( $bundle_recipes as $r_sku => $recipe ) { 
        $required = $recipe['req_sku']; 
        $found_ids = []; 
        $is_possible = true; 
        $temp_inv = $inventory_map; 

        foreach ( $required as $req_sku ) { 
            if ( !empty($temp_inv[$req_sku]) && count($temp_inv[$req_sku]) > 0 ) { 
                $found_ids[] = array_shift($temp_inv[$req_sku]); 
            } else { 
                $is_possible = false; 
                $break; 
            } 
        } 
        
        if ( $is_possible ) { 
            $ready_to_bundle[] = [
                'sku' => $r_sku,
                'name' => $recipe['name'],
                'child_ids' => $found_ids
            ]; 
        } 
    }

    $total_display = $my_bundles->found_posts + $my_singles->found_posts;

    ob_start();
    ?>
    <!-- [UX] SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* CSS for Assets List - Production Grade with Design Tokens */
        .prod-list-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--dnc-space-4, 16px);
            margin-top: var(--dnc-space-4, 16px);
            align-items: start;
            grid-auto-rows: min-content;
        }

        .prod-item-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            height: auto;
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            position: relative;
            margin-top: 0;
            padding-top: 0;
            min-width: 0;
            overflow: hidden;
            box-sizing: border-box;
        }

        .prod-item-wrapper.expanded {
            grid-column: 1 / -1;
        }

        .prod-summary-card {
            background: #fff;
            border-radius: var(--dnc-radius-lg, 12px);
            overflow: hidden;
            border: 1px solid var(--dnc-border, #e2e8f0);
            cursor: pointer;
            transition: transform var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1)), box-shadow var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            display: flex;
            flex-direction: column;
            box-shadow: var(--dnc-shadow-sm, 0 1px 2px rgba(0,0,0,0.04));
            height: 100%;
            flex-grow: 1;
            position: relative;
            z-index: 2;
        }

        .prod-item-wrapper:not(.expanded) .prod-summary-card {
            min-height: 240px;
        }

        .prod-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--dnc-shadow-md, 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05));
            border-color: var(--dnc-border-hover, #cbd5e1);
        }
        
        .summary-status-header {
            position: relative;
            width: 100%;
            padding: var(--dnc-space-2, 8px) var(--dnc-space-1, 4px);
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-align: center;
            display: block;
            z-index: 10;
            letter-spacing: 0.3px;
        }

        .st-green { background: var(--dnc-primary, #06C755); }
        .st-light-green { background: #4ade80; color: #fff; }
        .st-red { background: var(--dnc-danger, #e11d48); }
        .st-orange { background: var(--dnc-warning, #f97316); }
        .st-gray { background: var(--dnc-text-muted, #64748b); }
        .st-dark { background: #1f2937; }
        
        .prod-item-wrapper.expanded .summary-status-header { 
            display: none !important; 
        }
        
        /* Card Body */
        .summary-card-body {
            position: relative;
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            align-items: center;
            justify-content: center;
        }

        .summary-icon {
            width: 100%;
            height: 140px;
            object-fit: contain;
            object-position: center;
            background: #ffffff !important;
            padding: var(--dnc-space-3, 12px);
            transition: transform var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
        }

        .summary-info {
            background: var(--dnc-bg-secondary, #f8fafc) !important;
            border-top: 1px solid #f1f5f9;
            padding: var(--dnc-space-3, 12px) var(--dnc-space-3, 12px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            width: 100%;
            flex-grow: 1;
            gap: var(--dnc-space-1, 4px);
        }

        .summary-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dnc-text, #1e293b);
            line-height: 1.4;
            width: 100%;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            display: block;
            margin-bottom: var(--dnc-space-1, 4px);
        }

        .summary-sn {
            font-size: 11px;
            color: var(--dnc-text-muted, #64748b);
            margin-top: auto;
            text-align: center !important;
            width: 100%;
            display: block;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        
        /* Expanded State Logic */
        .prod-item-wrapper.expanded .prod-summary-card {
            flex-direction: row;
            aspect-ratio: auto;
            min-height: 90px;
            height: auto;
            align-items: stretch;
            padding: 0;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            border-radius: var(--dnc-radius-lg, 12px) var(--dnc-radius-lg, 12px) 0 0;
            border: 1px solid var(--dnc-border, #e2e8f0);
            border-bottom: none;
        }

        .prod-item-wrapper.expanded .summary-card-body {
            flex-direction: row;
            padding: 0;
            width: 100%;
            height: auto;
            position: relative;
        }

        .prod-item-wrapper.expanded .summary-icon {
            width: 90px;
            height: auto;
            min-height: 90px;
            padding: 0;
            object-fit: cover;
            border-right: 1px solid #f1f5f9;
        }

        .prod-item-wrapper.expanded .summary-info {
            border-top: none;
            background: #ffffff !important;
            width: auto;
            flex-grow: 1;
            padding: var(--dnc-space-4, 16px) 60px var(--dnc-space-4, 16px) var(--dnc-space-4, 16px) !important;
            align-items: flex-start;
            justify-content: center;
            text-align: left;
        }

        .prod-item-wrapper.expanded .summary-title {
            font-size: 15px;
            margin-top: var(--dnc-space-1, 4px);
            margin-bottom: var(--dnc-space-2, 8px);
            text-align: left !important;
            width: 100%;
        }

        .prod-item-wrapper.expanded .summary-sn {
            text-align: left !important;
            margin-top: 0;
        }

        .prod-detail-wrapper {
            display: none;
            margin-top: 0;
            animation: slideDown 0.25s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .prod-detail-wrapper .prod-card {
            background: #fff;
            border-radius: 0 0 var(--dnc-radius-lg, 12px) var(--dnc-radius-lg, 12px);
            overflow: hidden;
            box-shadow: var(--dnc-shadow-md, 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05));
            border: 1px solid var(--dnc-border, #e2e8f0);
            border-top: none;
            margin-bottom: 0 !important;
        }

        .prod-status-bar {
            text-align: center;
            font-size: 13px;
            padding: var(--dnc-space-3, 12px);
            font-weight: 600;
            display: block;
            color: white;
            letter-spacing: 0.3px;
        }

        .prod-img-area {
            width: 100%;
            height: 220px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-bottom: 1px solid var(--dnc-border, #e2e8f0);
        }

        .prod-img-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .prod-body {
            padding: var(--dnc-space-5, 20px);
        }

        .prod-model {
            font-size: 14px !important;
            font-weight: 700 !important;
            color: var(--dnc-text, #1e293b) !important;
            margin: 0 0 var(--dnc-space-1, 4px) 0 !important;
            display: block !important;
        }

        .prod-sku {
            font-size: 13px;
            color: var(--dnc-text-muted, #64748b);
            margin-bottom: var(--dnc-space-4, 16px);
            font-family: var(--dnc-font, 'Noto Sans Thai', 'Prompt', sans-serif);
            display: block;
        }

        .barcode-section {
            text-align: center;
            margin: var(--dnc-space-5, 20px) 0;
            overflow-x: auto;
            white-space: nowrap;
            max-width: 100%;
        }

        .barcode-font {
            font-family: 'Libre Barcode 39 Text', cursive;
            font-size: 30px;
            color: var(--dnc-text, #1e293b);
            line-height: 1;
            display: inline-block;
            vertical-align: middle;
        }

        .warranty-new-ui {
            border: 1px solid var(--dnc-border, #e2e8f0);
            border-radius: var(--dnc-radius-lg, 12px);
            overflow: hidden;
            margin-bottom: var(--dnc-space-5, 20px);
            background: #fff;
        }

        .w-usage-section {
            padding: var(--dnc-space-4, 16px);
            text-align: center;
            border-bottom: 1px dashed #e2e8f0;
            background: var(--dnc-bg-secondary, #f8fafc);
        }

        .w-usage-label {
            font-size: 12px;
            color: var(--dnc-text-muted, #64748b);
            margin-bottom: var(--dnc-space-1, 4px);
        }

        .w-usage-val {
            font-size: 20px;
            font-weight: bold;
            color: var(--dnc-text, #1e293b);
            font-family: var(--dnc-font, 'Noto Sans Thai', 'Prompt', sans-serif);
        }

        .w-detail-section {
            padding: var(--dnc-space-4, 16px);
            font-size: 13px;
        }

        .w-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--dnc-space-2, 8px);
        }

        .w-row-label {
            color: var(--dnc-text-muted, #64748b);
        }

        .w-row-val {
            font-weight: bold;
            color: var(--dnc-text, #1e293b);
        }

        .w-status-active {
            color: var(--dnc-primary, #06C755);
            font-weight: bold;
        }

        .w-green-bar {
            background: var(--dnc-primary, #06C755);
            color: #fff;
            text-align: center;
            padding: var(--dnc-space-3, 12px);
            font-weight: 600;
            font-size: 14px;
            display: block;
        }

        .w-red-bar {
            background: var(--dnc-danger, #e11d48);
            color: #fff;
            text-align: center;
            padding: var(--dnc-space-3, 12px);
            font-weight: 600;
            font-size: 14px;
            display: block;
        }

        .status-row {
            margin-top: var(--dnc-space-4, 16px);
            background: var(--dnc-bg-secondary, #f8fafc);
            padding: var(--dnc-space-3, 12px) var(--dnc-space-4, 16px);
            border-radius: var(--dnc-radius-md, 8px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--dnc-border, #e2e8f0);
        }

        .st-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dnc-text-muted, #64748b);
        }

        .st-val {
            font-size: 12px;
            font-weight: bold;
            color: var(--dnc-text, #1e293b);
        }

        .repair-area {
            margin-top: var(--dnc-space-4, 16px);
            border-top: 1px dashed #e2e8f0;
            padding-top: var(--dnc-space-4, 16px);
        }

        .repair-head {
            font-size: 14px;
            font-weight: 600;
            color: var(--dnc-text-secondary, #475569);
            margin-bottom: var(--dnc-space-2, 8px);
            display: flex;
            align-items: center;
            gap: var(--dnc-space-1, 4px);
        }

        .repair-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .repair-item {
            font-size: 12px;
            color: var(--dnc-text-secondary, #475569);
            padding: var(--dnc-space-2, 8px);
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: background var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
        }

        .repair-item:hover {
            background: var(--dnc-bg-secondary, #f8fafc);
        }

        .repair-item:last-child {
            border-bottom: none;
        }

        .r-date {
            font-weight: 600;
            color: var(--dnc-text, #1e293b);
            min-width: 80px;
            font-size: 12px;
        }

        .r-action {
            flex-grow: 1;
            text-align: right;
            font-size: 12px;
        }
        
        /* Timeline CSS */
        .tl-wrap {
            padding: 0 var(--dnc-space-1, 4px);
            margin-top: var(--dnc-space-5, 20px);
        }

        .tl-row {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: var(--dnc-space-5, 20px);
        }

        .tl-line {
            position: absolute;
            top: 14px;
            left: 10px;
            right: 10px;
            height: 2px;
            background: var(--dnc-border, #e2e8f0);
            z-index: 0;
        }

        .tl-item {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 100%;
        }

        .tl-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #d1d5db;
            margin: 0 auto var(--dnc-space-2, 8px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #9ca3af;
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
        }

        .tl-item.active .tl-dot {
            background: var(--dnc-primary, #06C755);
            border-color: var(--dnc-primary, #06C755);
            color: #fff;
            box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.15);
        }

        .tl-txt {
            font-size: 10px;
            color: #6b7280;
            display: block;
            line-height: 1.2;
            padding: 0 2px;
        }

        .tl-item.active .tl-txt {
            color: var(--dnc-primary, #06C755);
            font-weight: 600;
        }

        .tl-tracking-box {
            background: #fff7ed;
            padding: var(--dnc-space-4, 16px);
            border-radius: var(--dnc-radius-md, 8px);
            text-align: center;
            border: 1px solid #ffedd5;
            margin-top: var(--dnc-space-5, 20px);
        }

        .outbound-track-card {
            margin-top: var(--dnc-space-4, 16px);
            background: #ffffff;
            border-radius: var(--dnc-radius-lg, 12px);
            border: 1px solid var(--dnc-border, #e2e8f0);
            overflow: hidden;
            box-shadow: var(--dnc-shadow-sm, 0 1px 2px rgba(0,0,0,0.04));
            text-align: left;
        }

        .ot-header {
            background: var(--dnc-bg-secondary, #f8fafc);
            padding: var(--dnc-space-3, 12px) var(--dnc-space-4, 16px);
            font-size: 13px;
            font-weight: 600;
            color: var(--dnc-text-secondary, #475569);
            display: flex;
            align-items: center;
            gap: var(--dnc-space-2, 8px);
            border-bottom: 1px solid var(--dnc-border, #e2e8f0);
        }

        .ot-body {
            padding: var(--dnc-space-4, 16px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ot-info {
            display: flex;
            flex-direction: column;
        }

        .ot-courier {
            font-size: 12px;
            color: var(--dnc-text-muted, #64748b);
            margin-bottom: 2px;
        }

        .ot-number {
            font-size: 16px;
            font-weight: bold;
            color: var(--dnc-text, #1e293b);
            font-family: 'SF Mono', 'Fira Code', monospace;
            letter-spacing: 0.5px;
        }

        .btn-confirm-receipt {
            display: block;
            width: 100%;
            margin-top: var(--dnc-space-3, 12px);
            background: #1e293b;
            color: #fff;
            border: none;
            padding: var(--dnc-space-3, 12px);
            border-radius: var(--dnc-radius-md, 8px);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            box-shadow: var(--dnc-shadow-sm, 0 1px 2px rgba(0,0,0,0.04));
        }

        .btn-confirm-receipt:hover {
            background: #0f172a;
            box-shadow: var(--dnc-shadow-md, 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05));
        }

        .confirm-note {
            font-size: 10px;
            color: #94a3b8;
            margin-top: var(--dnc-space-2, 8px);
            text-align: center;
            font-style: italic;
        }

        .btn-unbundle {
            background: #fff;
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-top: var(--dnc-space-1, 4px);
        }

        .btn-unbundle:hover {
            background: #ef4444;
            color: #fff;
        }

        .bundle-content {
            padding: var(--dnc-space-4, 16px);
            background: var(--dnc-bg-secondary, #f8fafc);
        }

        .bundle-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: var(--dnc-radius-md, 8px);
            border: 1px solid var(--dnc-border, #e2e8f0);
            background: #fff;
        }

        .bundle-children-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--dnc-space-4, 16px);
        }
        
        /* Bundle Child - Horizontal Row Layout */
        .child-in-bundle .prod-summary-card {
            min-height: auto !important;
            flex-direction: row;
            height: auto;
            border-radius: var(--dnc-radius-md, 8px);
            box-shadow: var(--dnc-shadow-sm, 0 1px 2px rgba(0,0,0,0.04));
            border: 1px solid var(--dnc-border, #e2e8f0);
            background: #fff;
            align-items: stretch;
        }

        .child-in-bundle .summary-status-header {
            display: none;
        }

        .child-in-bundle .summary-card-body {
            flex-direction: row;
            height: auto;
            width: 100%;
        }

        .child-in-bundle .summary-icon {
            width: 100px !important;
            height: 100px !important;
            min-width: 100px !important;
            min-height: 100px !important;
            padding: 5px;
            border-right: 1px solid #f1f5f9;
            border-bottom: none;
            object-fit: contain;
            background: #fff;
        }

        .child-in-bundle .summary-info {
            padding: var(--dnc-space-3, 12px);
            align-items: flex-start;
            text-align: left;
            border-top: none;
            background: #fff !important;
            flex-grow: 1;
        }

        .child-in-bundle .summary-title {
            font-size: 13px;
            text-align: left !important;
            margin-bottom: 2px;
        }

        .child-in-bundle .summary-sn {
            font-size: 10px;
            text-align: left !important;
            margin-top: auto;
        }

        .child-in-bundle .mini-status-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: var(--dnc-radius-sm, 6px);
            margin-top: var(--dnc-space-1, 4px);
            display: inline-block;
            font-weight: bold;
        }

        .child-in-bundle.expanded .prod-summary-card {
            border-radius: var(--dnc-radius-md, 8px) var(--dnc-radius-md, 8px) 0 0;
            background: #fff;
            border-bottom: none;
        }

        .child-in-bundle.expanded {
            grid-column: 1 / -1;
        }

        /* Ready to Bundle Notification */
        .ready-bundle-box {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border: 2px dashed var(--dnc-warning, #f97316);
            border-radius: var(--dnc-radius-lg, 12px);
            padding: var(--dnc-space-5, 20px);
            text-align: center;
            margin-bottom: 40px;
            margin-top: var(--dnc-space-3, 12px);
            animation: pulseBorder 2s infinite;
        }

        @keyframes pulseBorder {
            0% { border-color: #fb923c; box-shadow: 0 0 0 rgba(249, 115, 22, 0); }
            50% { border-color: #f97316; box-shadow: 0 0 15px rgba(249, 115, 22, 0.2); }
            100% { border-color: #fb923c; box-shadow: 0 0 0 rgba(249, 115, 22, 0); }
        }

        .btn-merge {
            background: var(--dnc-warning, #f97316);
            color: white;
            border: none;
            padding: var(--dnc-space-3, 12px) var(--dnc-space-6, 24px);
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: var(--dnc-space-3, 12px);
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            display: inline-flex;
            align-items: center;
            gap: var(--dnc-space-2, 8px);
        }

        .btn-merge:hover {
            transform: scale(1.03);
            background: #ea580c;
            box-shadow: 0 6px 14px rgba(249, 115, 22, 0.35);
        }

        /* Section Header */
        .section-header-desktop {
            display: block !important;
            font-size: 22px;
            font-weight: 700;
            color: var(--dnc-text, #1e293b);
            margin-bottom: var(--dnc-space-5, 20px);
            border-bottom: 2px solid var(--dnc-border, #e2e8f0);
            padding-bottom: var(--dnc-space-3, 12px);
        }

        .section-header-mobile {
            display: none !important;
            font-size: 18px;
            font-weight: 700;
            color: var(--dnc-text, #1e293b);
        }

        @media (max-width: 1023px) {
            .section-header-desktop { display: none !important; }
            .section-header-mobile { display: block !important; margin-bottom: var(--dnc-space-3, 12px); }
            .prod-list-container { grid-template-columns: repeat(2, 1fr) !important; }
        }

        /* Stolen Button */
        .btn-stolen {
            display: block;
            width: 100%;
            margin-top: var(--dnc-space-4, 16px);
            background: #ef4444;
            color: #fff;
            border: none;
            padding: var(--dnc-space-3, 12px);
            border-radius: var(--dnc-radius-md, 8px);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--dnc-transition, 0.2s cubic-bezier(0.4, 0, 0.2, 1));
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
            text-align: center;
        }

        .btn-stolen:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(239, 68, 68, 0.3);
        }

        /* Loader */
        .dinoco-loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .dinoco-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--dnc-primary, #06C755);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* SweetAlert2 Custom Overrides for Dinoco Theme */
        .swal2-popup {
            font-family: var(--dnc-font, 'Noto Sans Thai', 'Prompt', sans-serif) !important;
            border-radius: var(--dnc-radius-xl, 16px) !important;
        }
        .swal2-title {
            font-size: 20px !important;
            color: var(--dnc-text, #1e293b) !important;
        }
        .swal2-confirm {
            background-color: #0f172a !important;
            border-radius: var(--dnc-radius-md, 8px) !important;
        }
        .swal2-cancel {
            background-color: #94a3b8 !important;
            border-radius: var(--dnc-radius-md, 8px) !important;
        }

        /* [ULTIMATE FIX] Safety Net - Prevent Layout Explosion */
        /* 1. Hide Detail Wrapper specifically if not expanded */
        .prod-item-wrapper:not(.expanded) .prod-detail-wrapper {
            display: none !important;
        }
        /* 2. Hide any loose prod-card just in case */
        .prod-item-wrapper:not(.expanded) > .prod-card {
            display: none !important;
        }
        /* 3. Force detail card to show when inside active wrapper */
        .prod-detail-wrapper .prod-card {
            display: block; 
        }
        /* 4. Reset Grid Column */
        .prod-item-wrapper:not(.expanded) {
            grid-column: auto !important;
        }
    </style>

    <div id="dinoco-loader" class="dinoco-loader-overlay">
        <div class="dinoco-spinner"></div>
        <div style="margin-top:10px; font-weight:bold; color:#555;">กำลังประมวลผล...</div>
    </div>

    <div class="dashboard-main">
        <?php echo $dinoco_system_notice; ?>
        
        <h4 class="section-header section-header-desktop">📦 ทรัพย์สินของท่าน (<?php echo $total_display; ?>) ชิ้น</h4>
        <h4 class="section-header section-header-mobile">📦 ทรัพย์สินของท่าน (<?php echo $total_display; ?>) ชิ้น</h4>

        <?php if ( ! empty($ready_to_bundle) ) : ?>
            <?php foreach ( $ready_to_bundle as $opp ) : ?>
                <div class="ready-bundle-box">
                    <div style="font-size:18px; font-weight:bold; color:#c2410c; margin-bottom:5px;">
                        <i class="fas fa-magic"></i> ค้นพบชุดสินค้าที่สามารถรวมร่างได้!
                    </div>
                    <div style="color:#666; font-size:14px; margin-bottom:15px;">
                        คุณมีสินค้าครบตามเงื่อนไขของชุด <strong>"<?php echo esc_html($opp['name']); ?>"</strong>
                    </div>
                    <button class="btn-merge" onclick='createBundle("<?php echo $opp['sku']; ?>", <?php echo json_encode($opp['child_ids']); ?>)'>
                        รวมร่างเป็นชุดสินค้า (Merge)
                    </button>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
        
        <div id="prod-container" class="prod-list-container">
            <!-- BUNDLE LOOP: Inside the grid container now -->
            <?php if ( $my_bundles->have_posts() ) : ?>
                <?php while ( $my_bundles->have_posts() ) : $my_bundles->the_post(); 
                    $bid = get_the_ID();
                    $b_sku = get_post_meta($bid, 'bundle_sku', true);
                    
                    // Get Children IDs [CRITICAL FIX: CHECK FUNCTION EXISTS]
                    $b_children_raw = (function_exists('get_field')) ? get_field('bundle_children', $bid) : null; 
                    $b_children = [];
                    if ( $b_children_raw && is_array($b_children_raw) ) {
                        foreach($b_children_raw as $c) {
                            $b_children[] = is_object($c) ? $c->ID : $c;
                        }
                    } else {
                         $meta_children = get_post_meta($bid, 'bundle_children', true);
                         if(is_array($meta_children)) $b_children = $meta_children;
                    }
                    
                    $b_info = isset($bundle_recipes[$b_sku]) ? $bundle_recipes[$b_sku] : [];
                    $b_name = isset($b_info['name']) ? $b_info['name'] : get_the_title();
                    $b_img  = isset($b_info['img']) ? $b_info['img'] : 'https://placehold.co/150x150?text=Set';
                ?>
                    <!-- New Bundle Card: Matches Single Product Wrapper with extra class 'is-bundle' -->
                    <div class="prod-item-wrapper is-bundle" id="wrapper_bundle_<?php echo $bid; ?>">
                        <div class="prod-summary-card" onclick="toggleSmartCard('bundle_<?php echo $bid; ?>')">
                            <!-- Green Header for Bundle -->
                            <div class="summary-status-header st-green">📦 สินค้าเป็นเซ็ต (Set)</div>
                            
                            <div class="summary-card-body">
                                <img src="<?php echo esc_url($b_img); ?>" class="summary-icon">
                                <div class="summary-info">
                                    <div class="summary-title"><i class="fas fa-cubes"></i> <?php echo esc_html($b_name); ?></div>
                                    <div class="summary-sn" style="color:#15803d; font-weight:bold;">ประกอบด้วยสินค้า <?php echo count($b_children); ?> รายการ</div>
                                    
                                    <button class="btn-unbundle" onclick="event.stopPropagation(); deleteBundle(<?php echo $bid; ?>)">
                                        <i class="fas fa-unlink"></i> แยกเซ็ต
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bundle Detail View (Shows Children Grid) -->
                        <!-- [SAFETY] Added inline style display:none -->
                        <div id="detail_bundle_<?php echo $bid; ?>" class="prod-detail-wrapper" style="display:none;">
                            <div class="prod-card">
                                <div class="prod-status-bar st-green">รายการสินค้าภายในเซ็ต</div>
                                <div class="bundle-content">
                                    <div class="bundle-children-grid">
                                        <?php 
                                        if ( ! empty($b_children) ) : 
                                            foreach ( $b_children as $child_id ) : 
                                                $pid = $child_id;
                                                $sn  = get_post_meta($pid, 'serial_code', true); 
                                                $sku = get_post_meta($pid, 'product_sku', true);
                                                $w_status_raw = get_post_meta($pid, 'w_status', true);
                                                $w_status     = is_array( $w_status_raw ) ? ( isset( $w_status_raw['value'] ) ? $w_status_raw['value'] : ( isset( $w_status_raw[0] ) ? $w_status_raw[0] : '' ) ) : $w_status_raw; 
                                                $w_status     = trim( $w_status );

                                                $catalog_item = isset( $product_catalog[ $sku ] ) ? $product_catalog[ $sku ] : null;
                                                $img_url      = ( $catalog_item && ! empty( $catalog_item['img'] ) ) ? $catalog_item['img'] : 'https://placehold.co/400x300?text=No+Image';
                                                
                                                $model_name = '';
                                                if ( $catalog_item && ! empty( $catalog_item['name'] ) ) {
                                                    $model_name = $catalog_item['name'];
                                                } else {
                                                    $model_obj  = (function_exists('get_field')) ? get_field( 'product_model', $pid ) : null; 
                                                    $model_name = is_object( $model_obj ) ? $model_obj->post_title : ( is_numeric( $model_obj ) ? get_the_title( $model_obj ) : ( $model_obj ?: "(ไม่ระบุรุ่นสินค้า)" ) );
                                                }
                                                
                                                // --- [DATA FIX] Full Detail Logic Injection for Children ---
                                                // 1. Reset Variables
                                                $st_cls = 'st-green'; 
                                                $st_txt = '✅ รับประกันสินค้า';
                                                $mini_badge_bg = '#dcfce7'; 
                                                $mini_badge_col = '#166534';
                                                $is_expired_header = false;
                                                $chk_w = strtolower( $w_status );

                                                // 2. Check Expiry
                                                $header_expire_check = get_post_meta($pid, 'warranty_expiry', true);
                                                if ( ! $header_expire_check ) {
                                                    $reg_d = get_post_meta($pid, 'warranty_register_date', true);
                                                    $dur_y = (int) get_post_meta($pid, 'warranty_duration_years', true);
                                                    if ( $reg_d && $dur_y > 0 ) {
                                                        $tmp_date = DateTime::createFromFormat( 'd/m/Y', $reg_d );
                                                        if ( $tmp_date ) {
                                                            $tmp_date->modify( "+$dur_y years" );
                                                            $tmp_date->setTime( 23, 59, 59 );
                                                            if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                                                        }
                                                    }
                                                } else {
                                                    $tmp_date = DateTime::createFromFormat( 'd/m/Y', $header_expire_check );
                                                    if ( ! $tmp_date ) $tmp_date = new DateTime( $header_expire_check );
                                                    $tmp_date->setTime( 23, 59, 59 );
                                                    if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                                                }
                                                
                                                // 3. Status Logic
                                                if ( strpos( $chk_w, 'claim' ) !== false ) { 
                                                    $tks_header = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                                                    if ( $tks_header ) {
                                                        $cond_header_val = (function_exists('get_field')) ? get_field( 'claim_condition', $tks_header[0]->ID ) : '';
                                                        if ( is_array( $cond_header_val ) ) { $cond_header_val = isset( $cond_header_val['value'] ) ? $cond_header_val['value'] : $cond_header_val[0]; }
                                                        if ( trim( $cond_header_val ) === 'send_part' ) { $st_cls = 'st-light-green'; $st_txt = '📦 รอเบิกอะไหล่'; $mini_badge_bg = '#dcfce7'; $mini_badge_col = '#15803d'; } 
                                                        else { $st_cls = 'st-orange'; $st_txt = '🔧 ส่งซ่อมบำรุง'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                                                    } else { $st_cls = 'st-orange'; $st_txt = '🔧 ส่งซ่อมบำรุง'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                                                } elseif ( $is_expired_header || strpos( $chk_w, 'expire' ) !== false ) { $st_cls = 'st-red'; $st_txt = '⛔ หมดอายุรับประกัน'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; } 
                                                elseif ( $chk_w == 'warranty_pending' ) { $st_cls = 'st-red'; $st_txt = '⛔ รอตรวจสอบ'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; }
                                                
                                                if ( $chk_w === 'inactive' ) { $st_cls = 'st-gray'; $st_txt = '⚪ สถานะไม่ระบุ'; $mini_badge_bg = '#f1f5f9'; $mini_badge_col = '#64748b'; }

                                                elseif ( $chk_w === 'stolen' ) { $st_cls = 'st-dark'; $st_txt = '🚫 ถูกขโมย/ระงับสิทธิ์'; $mini_badge_bg = '#1f2937'; $mini_badge_col = '#ffffff'; }
                                                ?>
                                                
                                                <div class="prod-item-wrapper child-in-bundle" id="wrapper_<?php echo $pid; ?>">
                                                    <!-- [UX FIX] Removed logic that prevented re-toggling -->
                                                    <div class="prod-summary-card" onclick="toggleSmartCard('<?php echo $pid; ?>')">
                                                        <div class="summary-card-body">
                                                            <img src="<?php echo esc_url( $img_url ); ?>" class="summary-icon" width="100" height="100">
                                                            <div class="summary-info">
                                                                <div class="summary-title"><?php echo esc_html( $model_name ); ?></div>
                                                                <div class="summary-sn">SN: <?php echo esc_html( $sn ); ?></div>
                                                                <div class="mini-status-badge" style="background:<?php echo $mini_badge_bg; ?>; color:<?php echo $mini_badge_col; ?>;">
                                                                    <?php echo $st_txt; ?>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- [DATA FIX] Full Child Detail (Identical to Single Product) -->
                                                    <div id="detail_<?php echo $pid; ?>" class="prod-detail-wrapper" style="display:none;">
                                                        
                                                        <?php 
                                                        $show_claim_ui = false;
                                                        if ( $chk_w === 'claim_process' || $chk_w === 'claim process' ) { $show_claim_ui = true; }

                                                        $tid = 0; $st_raw = 'pending';
                                                        if ( $show_claim_ui ) { 
                                                            $tks = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                                                            $tid = ( $tks ) ? $tks[0]->ID : 0;
                                                            $t_code = $tid ? get_post_meta($tid, 'ticket_code', true) : 'N/A';
                                                            $st_val_raw = $tid ? get_post_meta($tid, 'ticket_status', true) : 'pending';
                                                            $st_raw = trim( $st_val_raw );
                                                            
                                                            if( $tid > 0 ) :
                                                                $step1_active = ($st_raw=='pending'||$st_raw=='approved_send'||$st_raw=='shipping_in')?'active':'';
                                                                $step2_active = ($st_raw=='checking'||$st_raw=='fixing')?'active':'';
                                                                $step3_active = ($st_raw=='shipping_out'||$st_raw=='completed')?'active':'';
                                                        ?>
                                                            <div class="prod-card" style="margin-bottom:10px; border-bottom:3px solid #f97316;">
                                                                <div class="prod-status-bar st-orange">🔧 อยู่ระหว่างซ่อมบำรุง (Ticket #<?php echo $t_code; ?>)</div>
                                                                <div class="prod-body" style="padding:15px;">
                                                                    <div class="tl-wrap">
                                                                        <div class="tl-row">
                                                                            <div class="tl-line"></div>
                                                                            <div class="tl-item <?php echo $step1_active; ?>"><div class="tl-dot">1</div><span class="tl-txt">ส่งสินค้า<br>เข้าระบบ</span></div>
                                                                            <div class="tl-item <?php echo $step2_active; ?>"><div class="tl-dot">2</div><span class="tl-txt">ดำเนินการ<br>ตรวจสอบ/ซ่อม</span></div>
                                                                            <div class="tl-item <?php echo $step3_active; ?>"><div class="tl-dot">3</div><span class="tl-txt">ส่งคืน<br>เสร็จสิ้น</span></div>
                                                                        </div>
                                                                    </div>
                                                                    <?php if($st_raw == 'pending' || $st_raw == 'approved_send'): ?>
                                                                        <div class="tl-tracking-box" id="form_track_<?php echo $tid; ?>">
                                                                            <div style="font-size:13px; font-weight:bold; margin-bottom:10px;">📮 กรอกเลขพัสดุที่ท่านส่งมา</div>
                                                                            <select id="courier_<?php echo $tid; ?>" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;" onchange="toggleOther(<?php echo $tid; ?>)">
                                                                                <option value="">-- เลือกขนส่ง --</option>
                                                                                <?php foreach($thai_couriers as $k=>$v){ echo "<option value='$k'>$v</option>"; } ?>
                                                                                <option value="Other">อื่นๆ (ระบุเอง)</option>
                                                                            </select>
                                                                            <div id="div_other_courier_<?php echo $tid; ?>" style="display:none; margin-bottom:10px;">
                                                                                <input type="text" id="other_courier_<?php echo $tid; ?>" placeholder="ระบุชื่อขนส่ง" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                                                                            </div>
                                                                            <input type="text" id="tr_<?php echo $tid; ?>" placeholder="เลขพัสดุ (Tracking No.)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;">
                                                                            <button id="btn_save_<?php echo $tid; ?>" onclick="svTrack(<?php echo $tid; ?>)" style="background:#0f172a; color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">บันทึกเลขพัสดุ</button>
                                                                        </div>
                                                                    <?php elseif($st_raw == 'shipping_in'): $tr_in = get_post_meta($tid, 'tracking_inbound', true); ?>
                                                                        <div class="tl-tracking-box">
                                                                            <div>📦 ท่านส่งสินค้าเข้ามาแล้ว</div>
                                                                            <div style="font-weight:bold; color:#2563eb; font-family:monospace; margin-top:5px;"><?php echo esc_html($tr_in); ?></div>
                                                                        </div>
                                                                    <?php endif; ?>
                                                                    
                                                                    <?php if($st_raw == 'shipping_out' || $st_raw == 'completed'): $tr_out = get_post_meta($tid, 'tracking_outbound', true); if($tr_out): ?>
                                                                        <div class="outbound-track-card">
                                                                            <div class="ot-header"><i class="fas fa-truck"></i> ร้านส่งสินค้าคืนแล้ว</div>
                                                                            <div class="ot-body">
                                                                                <div class="ot-info"><div class="ot-number"><?php echo esc_html($tr_out); ?></div></div>
                                                                            </div>
                                                                        </div>
                                                                        <?php if($st_raw == 'shipping_out'): ?>
                                                                            <button id="btn_conf_<?php echo $tid; ?>" class="btn-confirm-receipt" onclick="confirmReceipt(<?php echo $tid; ?>)">ได้รับสินค้าแล้ว (กดเพื่อจบงาน)</button>
                                                                            <div class="confirm-note">* กรุณาตรวจสอบสภาพสินค้าก่อนกดยืนยัน</div>
                                                                        <?php endif; ?>
                                                                    <?php endif; endif; ?>
                                                                </div>
                                                            </div>
                                                        <?php endif; } // End Claim Logic ?>

                                                        <?php 
                                                        $expire_date      = get_post_meta($pid, 'warranty_expiry', true); 
                                                        $repair_repeater  = (function_exists('get_field')) ? get_field( 'repair_logs', $pid ) : '';
                                                        $cur_status       = ! empty( $chk_w ) ? $chk_w : 'original';
                                                        $show_status = isset( $status_display_map[$cur_status] ) ? $status_display_map[$cur_status] : $cur_status;
                                                        
                                                        $badge_html         = '<div class="w-red-bar">หมดอายุประกัน</div>'; 
                                                        $show_date          = '-'; 
                                                        $usage_age_text     = '0 ปี 0 เดือน 0 วัน'; 
                                                        $status_care_text   = 'ตรวจสอบไม่ได้';
                                                        $status_bar_text    = '✅ รับประกันสินค้าสินค้าใหม่สภาพสมบูรณ์'; 
                                                        $status_bar_class   = 'st-green';
                                                        
                                                        if ( $chk_w === 'warranty_pending' ) { $status_bar_text = '⛔ รอตรวจสอบประกัน ติดต่อแอดมิน'; $status_bar_class = 'st-red'; } 
                                                        elseif ( $chk_w === 'repaired' ) { $status_bar_text = '✅ ผ่านการซ่อมบำรุง'; } 
                                                        elseif ( $chk_w === 'refurbished' ) { $status_bar_text = '✅ สภาพพร้อมใช้งาน'; } 
                                                        elseif ( $chk_w === 'modified' ) { $status_bar_text = '✅ ดัดแปลงสภาพ'; }
                                                        elseif ( $chk_w === 'stolen' ) { $status_bar_text = '🚫 ถูกขโมย/ระงับสิทธิ์'; $status_bar_class = 'st-dark'; }
                                                        elseif ( $chk_w === 'inactive' ) { $status_bar_text = '⚪ สถานะไม่ระบุ / ระงับชั่วคราว'; $status_bar_class = 'st-gray'; }
                                                        
                                                        try {
                                                            $now = new DateTime(); $reg_date_val = get_post_meta($pid, 'warranty_register_date', true);
                                                            if ( $reg_date_val ) { $reg_dt = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $reg_dt ) { $usage_diff = $now->diff( $reg_dt ); $usage_age_text = $usage_diff->y . ' ปี ' . $usage_diff->m . ' เดือน ' . $usage_diff->d . ' วัน'; } }
                                                            $dx = null;
                                                            if ( $expire_date ) { $dx = DateTime::createFromFormat( 'd/m/Y', $expire_date ); if ( ! $dx ) $dx = new DateTime( $expire_date ); } 
                                                            elseif ( $reg_date_val ) { $dur = (int) get_post_meta($pid, 'warranty_duration_years', true); if ( $dur > 0 ) { $dx = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $dx ) $dx->modify( "+$dur years" ); } }
                                                            
                                                            if ( $dx ) {
                                                                $dx->setTime( 23, 59, 59 ); $show_date = $dx->format( 'd/m/Y' ); 
                                                                if ( $now > $dx ) { $status_care_text = 'หมดอายุการรับประกัน'; $badge_html = '<div class="w-red-bar">หมดประกันแล้ว</div>'; $status_bar_text = '⛔ หมดอายุรับประกัน'; $status_bar_class = 'st-red'; } 
                                                                else { $status_care_text = 'สินค้าอยู่ในการรับประกัน'; $badge_html = '<div class="w-green-bar">ประกันเหลือ ' . ($now->diff($dx)->y > 0 ? $now->diff($dx)->y." ปี " : "") . ($now->diff($dx)->m > 0 ? $now->diff($dx)->m." เดือน " : "") . $now->diff($dx)->d . ' วัน</div>'; if($chk_w !== 'warranty_pending' && $status_bar_class !== 'st-red' && $chk_w !== 'stolen' && $chk_w !== 'inactive') $status_bar_class = 'st-green'; }
                                                            } else {
                                                                $status_care_text = 'ไม่ระบุวันหมดอายุ'; 
                                                                $badge_html = '<div class="w-green-bar">Active</div>';
                                                            }
                                                        } catch ( Exception $e ) {}
                                                        
                                                        if ( $chk_w === 'stolen' ) {
                                                            $status_care_text = 'ระงับสิทธิ์ถาวร';
                                                            $badge_html = '<div class="w-red-bar" style="background:#000;">สินค้าถูกระงับสิทธิ์</div>';
                                                            $status_bar_class = 'st-dark';
                                                            $status_bar_text = '🚫 สินค้าถูกแจ้งหาย/ระงับสิทธิ์';
                                                        }
                                                        ?>

                                                        <div class="prod-card">
                                                            <div class="prod-status-bar <?php echo $status_bar_class; ?>"><?php echo $status_bar_text; ?></div>
                                                            <div class="prod-img-area"><img src="<?php echo esc_url( $img_url ); ?>" alt="Product"></div>
                                                            <div class="prod-body">
                                                                <div class="prod-model">รุ่น: <?php echo esc_html( $model_name ); ?></div>
                                                                <div class="prod-sku">SKU: <?php echo esc_html( $sku ); ?></div>
                                                                <div class="barcode-section"><div class="barcode-font"><?php echo $sn; ?></div></div>
                                                                
                                                                <div class="warranty-new-ui">
                                                                    <div class="w-usage-section"><div class="w-usage-label">อายุการใช้งาน</div><div class="w-usage-val"><?php echo $usage_age_text; ?></div></div>
                                                                    <div class="w-detail-section">
                                                                        <div class="w-row"><span class="w-row-label">สถานะ DINOCO Care:</span><span class="w-status-active"><?php echo $status_care_text; ?></span></div>
                                                                        <div class="w-row"><span class="w-row-label">วันหมดอายุประกัน:</span><span class="w-row-val"><?php echo $show_date; ?></span></div>
                                                                    </div>
                                                                    <?php echo $badge_html; ?>
                                                                </div>

                                                                <div class="status-row">
                                                                    <span class="st-label">🛠️ สภาพสินค้า</span>
                                                                    <span class="st-val"><?php echo esc_html( $show_status ); ?></span>
                                                                </div>
                                                                
                                                                <?php if ( $chk_w !== 'stolen' ) : ?>
                                                                    <button class="btn-stolen" onclick="reportStolen(<?php echo $pid; ?>)">🚨 แจ้งสินค้าหาย/ระงับสิทธิ์</button>
                                                                <?php endif; ?>

                                                                <?php if ( $repair_repeater ) : ?>
                                                                    <div class="repair-area">
                                                                        <div class="repair-head">🔧 ประวัติการซ่อม</div>
                                                                        <ul class="repair-list">
                                                                        <?php 
                                                                        $lines = preg_split( '/\r\n|\r|\n/', $repair_repeater ); 
                                                                        foreach ( $lines as $line ) { 
                                                                            if ( trim( $line ) === '' ) continue; 
                                                                            $parts = explode( ':', $line ); 
                                                                            if ( count( $parts ) >= 2 ) { 
                                                                                $r_desc = isset( $action_map[ trim( $parts[1] ) ] ) ? $action_map[ trim( $parts[1] ) ] : trim( $parts[1] ); 
                                                                                echo '<li class="repair-item"><div class="r-date">' . trim( $parts[0] ) . '</div><div class="r-action">' . $r_desc . '</div></li>'; 
                                                                            } 
                                                                        } 
                                                                        ?>
                                                                        </ul>
                                                                    </div>
                                                                <?php endif; ?>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endwhile; ?>
            <?php endif; wp_reset_postdata(); ?>
            
            <!-- SINGLE PRODUCT LOOP (FIXED STRUCTURE) -->
            <?php 
            while ( $my_singles->have_posts() ) : 
                $my_singles->the_post(); 
                $pid                  = get_the_ID();
                $sn                   = get_post_meta($pid, 'serial_code', true); 
                $sku                  = get_post_meta($pid, 'product_sku', true);
                $w_status_raw         = get_post_meta($pid, 'w_status', true);
                $w_status             = is_array( $w_status_raw ) ? ( isset( $w_status_raw['value'] ) ? $w_status_raw['value'] : ( isset( $w_status_raw[0] ) ? $w_status_raw[0] : '' ) ) : $w_status_raw; 
                $w_status             = trim( $w_status );
                
                $chk_w = strtolower( $w_status );

                $catalog_item         = isset( $product_catalog[ $sku ] ) ? $product_catalog[ $sku ] : null;
                $img_url              = ( $catalog_item && ! empty( $catalog_item['img'] ) ) ? $catalog_item['img'] : 'https://placehold.co/400x300?text=No+Image';
                
                $model_name = '';
                if ( $catalog_item && ! empty( $catalog_item['name'] ) ) { $model_name = $catalog_item['name']; } 
                else { 
                    $model_obj = (function_exists('get_field')) ? get_field( 'product_model', $pid ) : null; 
                    $model_name = is_object( $model_obj ) ? $model_obj->post_title : ( is_numeric( $model_obj ) ? get_the_title( $model_obj ) : ( $model_obj ?: "(ไม่ระบุรุ่นสินค้า)" ) ); 
                }

                $status_color_class = 'st-green'; 
                $st_txt = '✅ รับประกันสินค้า'; 
                $mini_badge_bg = '#dcfce7'; 
                $mini_badge_col = '#166534';
                
                $is_expired_header = false;
                $header_expire_check = get_post_meta($pid, 'warranty_expiry', true);
                
                if ( ! $header_expire_check ) {
                    $reg_d = get_post_meta($pid, 'warranty_register_date', true);
                    $dur_y = (int) get_post_meta($pid, 'warranty_duration_years', true);
                    if ( $reg_d && $dur_y > 0 ) {
                        $tmp_date = DateTime::createFromFormat( 'd/m/Y', $reg_d );
                        if ( $tmp_date ) {
                            $tmp_date->modify( "+$dur_y years" );
                            $tmp_date->setTime( 23, 59, 59 );
                            if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                        }
                    }
                } else {
                    $tmp_date = DateTime::createFromFormat( 'd/m/Y', $header_expire_check );
                    if ( ! $tmp_date ) $tmp_date = new DateTime( $header_expire_check );
                    $tmp_date->setTime( 23, 59, 59 );
                    if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                }

                if ( strpos( $chk_w, 'claim' ) !== false ) { 
                    $tks_header = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                    if ( $tks_header ) {
                        $cond_header_val = (function_exists('get_field')) ? get_field( 'claim_condition', $tks_header[0]->ID ) : '';
                        if ( is_array( $cond_header_val ) ) { $cond_header_val = isset( $cond_header_val['value'] ) ? $cond_header_val['value'] : $cond_header_val[0]; }
                        if ( trim( $cond_header_val ) === 'send_part' ) { $status_color_class = 'st-light-green'; $st_txt = '📦 รอเบิกอะไหล่'; $mini_badge_bg = '#dcfce7'; $mini_badge_col = '#15803d'; } 
                        else { $status_color_class = 'st-orange'; $st_txt = '🔧 ส่งซ่อมบำรุง'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                    } else { $status_color_class = 'st-orange'; $st_txt = '🔧 ส่งซ่อมบำรุง'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                } elseif ( $is_expired_header || strpos( $chk_w, 'expire' ) !== false ) { $status_color_class = 'st-red'; $st_txt = '⛔ หมดอายุรับประกัน'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; } 
                elseif ( $chk_w == 'warranty_pending' ) { $status_color_class = 'st-red'; $st_txt = '⛔ รอตรวจสอบ'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; }
                
                if ( $chk_w === 'inactive' ) {
                    $status_color_class = 'st-gray'; 
                    $st_txt = '⚪ สถานะไม่ระบุ';
                    $mini_badge_bg = '#f1f5f9'; 
                    $mini_badge_col = '#64748b';
                }

                if ( $chk_w === 'stolen' ) {
                    $status_color_class = 'st-dark';
                    $st_txt = '🚫 ถูกขโมย/ระงับสิทธิ์';
                    $mini_badge_bg = '#1f2937'; 
                    $mini_badge_col = '#ffffff';
                }
            ?>
                <!-- Wrapper Starts -->
                <div class="prod-item-wrapper" id="wrapper_<?php echo $pid; ?>">
                    
                    <!-- 1. Summary Card (Visible Always) -->
                    <div class="prod-summary-card" onclick="toggleSmartCard('<?php echo $pid; ?>')">
                        <div class="summary-status-header <?php echo $status_color_class; ?>"><?php echo $st_txt; ?></div>
                        <div class="summary-card-body">
                            <img src="<?php echo esc_url( $img_url ); ?>" class="summary-icon">
                            <div class="summary-info">
                                <div class="summary-title"><?php echo esc_html( $model_name ); ?></div>
                                <div class="summary-sn">SN: <?php echo esc_html( $sn ); ?></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Detail Wrapper (Hidden by default) -->
                    <!-- [SAFETY] Added inline style display:none -->
                    <div id="detail_<?php echo $pid; ?>" class="prod-detail-wrapper" style="display:none;">
                        
                        <!-- Claim UI Block -->
                        <?php 
                        $show_claim_ui = false;
                        if ( $chk_w === 'claim_process' || $chk_w === 'claim process' ) { $show_claim_ui = true; }
                        $tid = 0; $st_raw = 'pending';
                        if ( $show_claim_ui ) { 
                            $tks = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                            $tid = ( $tks ) ? $tks[0]->ID : 0;
                            $t_code = $tid ? get_post_meta($tid, 'ticket_code', true) : 'N/A';
                            $st_val_raw = $tid ? get_post_meta($tid, 'ticket_status', true) : 'pending';
                            $st_raw = trim( $st_val_raw );
                            
                            if( $tid > 0 ) :
                                $step1_active = ($st_raw=='pending'||$st_raw=='approved_send'||$st_raw=='shipping_in')?'active':'';
                                $step2_active = ($st_raw=='checking'||$st_raw=='fixing')?'active':'';
                                $step3_active = ($st_raw=='shipping_out'||$st_raw=='completed')?'active':'';
                        ?>
                            <div class="prod-card" style="margin-bottom:10px; border-bottom:3px solid #f97316;">
                                <div class="prod-status-bar st-orange">🔧 อยู่ระหว่างซ่อมบำรุง (Ticket #<?php echo $t_code; ?>)</div>
                                <div class="prod-body" style="padding:15px;">
                                    <div class="tl-wrap">
                                        <div class="tl-row">
                                            <div class="tl-line"></div>
                                            <div class="tl-item <?php echo $step1_active; ?>"><div class="tl-dot">1</div><span class="tl-txt">ส่งสินค้า<br>เข้าระบบ</span></div>
                                            <div class="tl-item <?php echo $step2_active; ?>"><div class="tl-dot">2</div><span class="tl-txt">ดำเนินการ<br>ตรวจสอบ/ซ่อม</span></div>
                                            <div class="tl-item <?php echo $step3_active; ?>"><div class="tl-dot">3</div><span class="tl-txt">ส่งคืน<br>เสร็จสิ้น</span></div>
                                        </div>
                                    </div>
                                    
                                    <?php if($st_raw == 'pending' || $st_raw == 'approved_send'): ?>
                                        <div class="tl-tracking-box" id="form_track_<?php echo $tid; ?>">
                                            <div style="font-size:13px; font-weight:bold; margin-bottom:10px;">📮 กรอกเลขพัสดุที่ท่านส่งมา</div>
                                            <select id="courier_<?php echo $tid; ?>" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;" onchange="toggleOther(<?php echo $tid; ?>)">
                                                <option value="">-- เลือกขนส่ง --</option>
                                                <?php foreach($thai_couriers as $k=>$v){ echo "<option value='$k'>$v</option>"; } ?>
                                                <option value="Other">อื่นๆ (ระบุเอง)</option>
                                            </select>
                                            <div id="div_other_courier_<?php echo $tid; ?>" style="display:none; margin-bottom:10px;">
                                                <input type="text" id="other_courier_<?php echo $tid; ?>" placeholder="ระบุชื่อขนส่ง" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                                            </div>
                                            <input type="text" id="tr_<?php echo $tid; ?>" placeholder="เลขพัสดุ (Tracking No.)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;">
                                            <button id="btn_save_<?php echo $tid; ?>" onclick="svTrack(<?php echo $tid; ?>)" style="background:#0f172a; color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">บันทึกเลขพัสดุ</button>
                                        </div>
                                    <?php elseif($st_raw == 'shipping_in'): $tr_in = get_post_meta($tid, 'tracking_inbound', true); ?>
                                        <div class="tl-tracking-box">
                                            <div>📦 ท่านส่งสินค้าเข้ามาแล้ว</div>
                                            <div style="font-weight:bold; color:#2563eb; font-family:monospace; margin-top:5px;"><?php echo esc_html($tr_in); ?></div>
                                        </div>
                                    <?php endif; ?>
                                    
                                    <?php if($st_raw == 'shipping_out' || $st_raw == 'completed'): $tr_out = get_post_meta($tid, 'tracking_outbound', true); if($tr_out): ?>
                                        <div class="outbound-track-card">
                                            <div class="ot-header"><i class="fas fa-truck"></i> ร้านส่งสินค้าคืนแล้ว</div>
                                            <div class="ot-body">
                                                <div class="ot-info"><div class="ot-number"><?php echo esc_html($tr_out); ?></div></div>
                                            </div>
                                        </div>
                                        <?php if($st_raw == 'shipping_out'): ?>
                                            <button id="btn_conf_<?php echo $tid; ?>" class="btn-confirm-receipt" onclick="confirmReceipt(<?php echo $tid; ?>)">ได้รับสินค้าแล้ว (กดเพื่อจบงาน)</button>
                                            <div class="confirm-note">* กรุณาตรวจสอบสภาพสินค้าก่อนกดยืนยัน</div>
                                        <?php endif; ?>
                                    <?php endif; endif; ?>
                                </div>
                            </div>
                        <?php endif; } // End Claim Logic ?>

                        <!-- Standard Product Detail Card -->
                        <!-- [FIX] This block is now safely INSIDE the hidden wrapper -->
                        <?php 
                        $chk_w = strtolower( $w_status );
                        $expire_date      = get_post_meta($pid, 'warranty_expiry', true); 
                        $repair_repeater  = (function_exists('get_field')) ? get_field( 'repair_logs', $pid ) : '';
                        $cur_status       = ! empty( $chk_w ) ? $chk_w : 'original';
                        $show_status = isset( $status_display_map[$cur_status] ) ? $status_display_map[$cur_status] : $cur_status;
                        
                        $badge_html         = '<div class="w-red-bar">หมดอายุประกัน</div>'; 
                        $show_date          = '-'; 
                        $usage_age_text     = '0 ปี 0 เดือน 0 วัน'; 
                        $status_care_text   = 'ตรวจสอบไม่ได้';
                        $status_bar_text    = '✅ รับประกันสินค้าสินค้าใหม่สภาพสมบูรณ์'; 
                        $status_bar_class   = 'st-green';
                        
                        if ( $chk_w === 'warranty_pending' ) { $status_bar_text = '⛔ รอตรวจสอบประกัน ติดต่อแอดมิน'; $status_bar_class = 'st-red'; } 
                        elseif ( $chk_w === 'repaired' ) { $status_bar_text = '✅ ผ่านการซ่อมบำรุง'; } 
                        elseif ( $chk_w === 'refurbished' ) { $status_bar_text = '✅ สภาพพร้อมใช้งาน'; } 
                        elseif ( $chk_w === 'modified' ) { $status_bar_text = '✅ ดัดแปลงสภาพ'; }
                        elseif ( $chk_w === 'stolen' ) { $status_bar_text = '🚫 ถูกขโมย/ระงับสิทธิ์'; $status_bar_class = 'st-dark'; }
                        elseif ( $chk_w === 'inactive' ) { $status_bar_text = '⚪ สถานะไม่ระบุ / ระงับชั่วคราว'; $status_bar_class = 'st-gray'; }
                        
                        try {
                            $now = new DateTime(); $reg_date_val = get_post_meta($pid, 'warranty_register_date', true);
                            if ( $reg_date_val ) { $reg_dt = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $reg_dt ) { $usage_diff = $now->diff( $reg_dt ); $usage_age_text = $usage_diff->y . ' ปี ' . $usage_diff->m . ' เดือน ' . $usage_diff->d . ' วัน'; } }
                            $dx = null;
                            if ( $expire_date ) { $dx = DateTime::createFromFormat( 'd/m/Y', $expire_date ); if ( ! $dx ) $dx = new DateTime( $expire_date ); } 
                            elseif ( $reg_date_val ) { $dur = (int) get_post_meta($pid, 'warranty_duration_years', true); if ( $dur > 0 ) { $dx = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $dx ) $dx->modify( "+$dur years" ); } }
                            
                            if ( $dx ) {
                                $dx->setTime( 23, 59, 59 ); $show_date = $dx->format( 'd/m/Y' ); 
                                if ( $now > $dx ) { $status_care_text = 'หมดอายุการรับประกัน'; $badge_html = '<div class="w-red-bar">หมดประกันแล้ว</div>'; $status_bar_text = '⛔ หมดอายุรับประกัน'; $status_bar_class = 'st-red'; } 
                                else { $status_care_text = 'สินค้าอยู่ในการรับประกัน'; $badge_html = '<div class="w-green-bar">ประกันเหลือ ' . ($now->diff($dx)->y > 0 ? $now->diff($dx)->y." ปี " : "") . ($now->diff($dx)->m > 0 ? $now->diff($dx)->m." เดือน " : "") . $now->diff($dx)->d . ' วัน</div>'; if($chk_w !== 'warranty_pending' && $status_bar_class !== 'st-red' && $chk_w !== 'stolen' && $chk_w !== 'inactive') $status_bar_class = 'st-green'; }
                            } else {
                                $status_care_text = 'ไม่ระบุวันหมดอายุ'; 
                                $badge_html = '<div class="w-green-bar">Active</div>';
                            }
                        } catch ( Exception $e ) {}
                        
                        if ( $chk_w === 'stolen' ) {
                            $status_care_text = 'ระงับสิทธิ์ถาวร';
                            $badge_html = '<div class="w-red-bar" style="background:#000;">สินค้าถูกระงับสิทธิ์</div>';
                            $status_bar_class = 'st-dark';
                            $status_bar_text = '🚫 สินค้าถูกแจ้งหาย/ระงับสิทธิ์';
                        }
                        ?>

                        <div class="prod-card">
                            <div class="prod-status-bar <?php echo $status_bar_class; ?>"><?php echo $status_bar_text; ?></div>
                            <div class="prod-img-area"><img src="<?php echo esc_url( $img_url ); ?>" alt="Product"></div>
                            <div class="prod-body">
                                <div class="prod-model">รุ่น: <?php echo esc_html( $model_name ); ?></div>
                                <div class="prod-sku">SKU: <?php echo esc_html( $sku ); ?></div>
                                <div class="barcode-section"><div class="barcode-font"><?php echo $sn; ?></div></div>
                                
                                <div class="warranty-new-ui">
                                    <div class="w-usage-section"><div class="w-usage-label">อายุการใช้งาน</div><div class="w-usage-val"><?php echo $usage_age_text; ?></div></div>
                                    <div class="w-detail-section">
                                        <div class="w-row"><span class="w-row-label">สถานะ DINOCO Care:</span><span class="w-status-active"><?php echo $status_care_text; ?></span></div>
                                        <div class="w-row"><span class="w-row-label">วันหมดอายุประกัน:</span><span class="w-row-val"><?php echo $show_date; ?></span></div>
                                    </div>
                                    <?php echo $badge_html; ?>
                                </div>

                                <div class="status-row">
                                    <span class="st-label">🛠️ สภาพสินค้า</span>
                                    <span class="st-val"><?php echo esc_html( $show_status ); ?></span>
                                </div>
                                
                                <?php if ( $chk_w !== 'stolen' ) : ?>
                                    <button class="btn-stolen" onclick="reportStolen(<?php echo $pid; ?>)">🚨 แจ้งสินค้าหาย/ระงับสิทธิ์</button>
                                <?php endif; ?>

                                <?php if ( $repair_repeater ) : ?>
                                    <div class="repair-area">
                                        <div class="repair-head">🔧 ประวัติการซ่อม</div>
                                        <ul class="repair-list">
                                        <?php 
                                        $lines = preg_split( '/\r\n|\r|\n/', $repair_repeater ); 
                                        foreach ( $lines as $line ) { 
                                            if ( trim( $line ) === '' ) continue; 
                                            $parts = explode( ':', $line ); 
                                            if ( count( $parts ) >= 2 ) { 
                                                $r_desc = isset( $action_map[ trim( $parts[1] ) ] ) ? $action_map[ trim( $parts[1] ) ] : trim( $parts[1] ); 
                                                echo '<li class="repair-item"><div class="r-date">' . trim( $parts[0] ) . '</div><div class="r-action">' . $r_desc . '</div></li>'; 
                                            } 
                                        } 
                                        ?>
                                        </ul>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>

                    </div> <!-- End prod-detail-wrapper -->
                    
                </div> <!-- End Wrapper -->
            <?php endwhile; ?>
            </div>
        
        <?php if ( !$my_bundles->have_posts() && !$my_singles->have_posts() ) : ?>
            <div style="text-align:center; padding:40px; border:2px dashed #ddd; color:#999; border-radius:10px;">📭 ยังไม่มีสินค้าในระบบ</div>
        <?php endif; wp_reset_postdata(); ?>

        <div style="text-align:center; margin-top:40px; padding-bottom: 80px;">
            <a href="<?php echo wp_logout_url( home_url() ); ?>" style="color:#999; text-decoration:none; font-weight:600; display:inline-block; border:1px solid #ddd; padding:10px 20px; border-radius:30px;">ออกจากระบบ</a>
        </div>
    </div> 

    <!-- JAVASCRIPT LOGIC (V16 - UX Overhaul) -->
    <script>
    var dinoco_nonce = '<?php echo wp_create_nonce('dinoco_nonce_action'); ?>';

    function getCacheBustedUrl() {
        var url = window.location.href.split('#')[0];
        var separator = url.indexOf('?') > -1 ? '&' : '?';
        return url + separator + 't=' + new Date().getTime();
    }

    // [FIXED V15.3] Smart Accordion Toggle Logic (Removed mode-list-view toggle)
    function toggleSmartCard(pid) {
        const wrapper = document.getElementById('wrapper_' + pid);
        const detail = document.getElementById('detail_' + pid);
        const isChild = wrapper.classList.contains('child-in-bundle');
        const isAlreadyActive = wrapper.classList.contains('active');

        if (!isChild) {
            // Case 1: Top-Level Card (Single or Bundle Parent)
            // Close ALL other top-level cards
            document.querySelectorAll('.prod-item-wrapper:not(.child-in-bundle).active').forEach(el => {
                if(el.id !== 'wrapper_' + pid) {
                    el.classList.remove('active', 'expanded');
                    const d = el.querySelector('.prod-detail-wrapper');
                    if(d) d.style.display = 'none';
                }
            });
        } else {
            // Case 2: Child inside Bundle - ACCORDION LOGIC
            // Only close other siblings in the same bundle. KEEP THE PARENT OPEN.
            const parentBundle = wrapper.closest('.prod-item-wrapper.is-bundle');
            if(parentBundle) {
                parentBundle.querySelectorAll('.child-in-bundle.active').forEach(child => {
                    if(child.id !== 'wrapper_' + pid) {
                        child.classList.remove('active', 'expanded');
                        const d = child.querySelector('.prod-detail-wrapper');
                        if(d) d.style.display = 'none';
                    }
                });
            }
        }

        // Toggle Current Card (Open/Close itself)
        if (isAlreadyActive) {
            wrapper.classList.remove('active', 'expanded');
            detail.style.display = 'none';
        } else {
            wrapper.classList.add('active', 'expanded');
            detail.style.display = 'block';
            
            setTimeout(() => { 
                wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            }, 100);
        }
    }
    
    function closeAllCards() {
        // [FIX V15.3] Removed 'mode-list-view' manipulation
        document.querySelectorAll('.prod-item-wrapper').forEach(el => { 
            el.classList.remove('active'); 
            el.classList.remove('expanded'); 
        });
        document.querySelectorAll('.prod-detail-wrapper').forEach(el => { 
            el.style.display = 'none'; 
        });
    }

    function toggleLoader(show) {
        const loader = document.getElementById('dinoco-loader');
        if (loader) {
            loader.style.display = show ? 'flex' : 'none';
        }
    }

    // --- Tracking Logic ---
    function toggleOther(tid) { 
        var val = document.getElementById('courier_'+tid).value; 
        var wrapper = document.getElementById('div_other_courier_'+tid); 
        var input = document.getElementById('other_courier_'+tid); 
        if(val === 'Other') { wrapper.style.display = 'block'; input.focus(); } 
        else { wrapper.style.display = 'none'; input.value = ''; } 
    }
    
    function showEditTrack(tid) { 
        document.getElementById('view_track_'+tid).style.display = 'none'; 
        document.getElementById('form_track_'+tid).style.display = 'block'; 
    }
    
    function cancelEditTrack(tid) { 
        document.getElementById('view_track_'+tid).style.display = 'block'; 
        document.getElementById('form_track_'+tid).style.display = 'none'; 
    }
    
    function svTrack(tid) { 
        var courier = document.getElementById('courier_'+tid).value; 
        var num = document.getElementById('tr_'+tid).value; 
        var btn = document.getElementById('btn_save_'+tid); 
        
        if(!courier) {
            Swal.fire('แจ้งเตือน', 'กรุณาเลือกบริษัทขนส่ง', 'warning');
            return;
        } 
        if(courier === 'Other') { 
            courier = document.getElementById('other_courier_'+tid).value; 
            if(!courier) {
                Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อขนส่ง', 'warning');
                return;
            }
        } 
        if(!num) {
            Swal.fire('แจ้งเตือน', 'กรุณากรอกเลขพัสดุ', 'warning');
            return;
        }
        
        var full_track = courier + ": " + num; 
        
        Swal.fire({
            title: 'ยืนยันการบันทึก?',
            html: `ขนส่ง: <b>${courier}</b><br>เลขพัสดุ: <b>${num}</b>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                btn.disabled = true; 
                btn.innerText = 'กำลังบันทึก...'; 
                toggleLoader(true);
                
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'save_track'); // V10 Variable
                fd.append('ticket_id', tid); 
                fd.append('tracking', full_track); 
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method:'POST', body:fd })
                .then(r=>r.json())
                .then(d=>{ 
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('สำเร็จ', 'บันทึกเรียบร้อย', 'success').then(() => location.reload());
                    } 
                    else { 
                        var debugMsg = d.msg || d.message || (d.data && d.data.msg) || 'Unknown Error';
                        Swal.fire('Error', debugMsg, 'error');
                        btn.disabled = false; 
                        btn.innerText = 'บันทึกเลขพัสดุ'; 
                    } 
                })
                .catch(e => { 
                    console.error(e); 
                    toggleLoader(false); 
                    Swal.fire('Error', 'Connection Error', 'error');
                    btn.disabled = false; 
                    btn.innerText = 'บันทึกเลขพัสดุ'; 
                }); 
            }
        });
    }

    function confirmReceipt(tid) {
        Swal.fire({
            title: 'ยืนยันการรับสินค้า?',
            text: 'กรุณาตรวจสอบความเรียบร้อยของสินค้าก่อนกดยืนยัน',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ได้รับแล้ว (จบงาน)',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#1e293b'
        }).then((result) => {
            if (result.isConfirmed) {
                var btn = document.getElementById('btn_conf_' + tid);
                if(btn) btn.disabled = true;
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'confirm_receipt'); // V10 Variable
                fd.append('ticket_id', tid); 
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method:'POST', body:fd })
                .then(r=>r.json())
                .then(d=>{
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('สำเร็จ', 'ยืนยันรับสินค้าเรียบร้อย ระบบปิดงาน Ticket นี้แล้ว', 'success')
                        .then(() => location.reload());
                    } 
                    else { 
                        var debugMsg = d.msg || d.message || (d.data && d.data.msg) || 'Unknown Error';
                        Swal.fire('Error', debugMsg, 'error');
                        if(btn) btn.disabled = false; 
                    }
                })
                .catch(e=>{ 
                    toggleLoader(false); 
                    Swal.fire('Error', 'Connection Error', 'error');
                    if(btn) btn.disabled = false; 
                });
            }
        });
    }
    
    // Bundle JS Functions
    function createBundle(targetSku, childIds) {
        Swal.fire({
            title: 'ยืนยันการรวมร่าง?',
            text: 'สถานะของสินค้าลูกจะถูกล็อคและย้ายมารวมแสดงผลในชุดนี้',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'รวมร่าง (Merge)',
            confirmButtonColor: '#f97316',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'create_bundle'); // V10 Variable
                fd.append('target_sku', targetSku);
                childIds.forEach(id => fd.append('child_ids[]', id));
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(response => response.json()) 
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('สำเร็จ!', (d.msg || 'Success'), 'success')
                        .then(() => location.reload());
                    } else { 
                        Swal.fire('Error', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error("Fetch Error:", e); 
                    Swal.fire('Error', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }

    function deleteBundle(bundleId) {
        Swal.fire({
            title: 'ต้องการแยกชุดสินค้า?',
            text: 'ข้อมูลประกันและประวัติซ่อมจะยังคงอยู่กับสินค้าลูกแต่ละชิ้นเหมือนเดิม',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'แยกชุด (Unbundle)',
            confirmButtonColor: '#ef4444',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'delete_bundle'); // V10 Variable
                fd.append('bundle_id', bundleId);
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable
                
                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('สำเร็จ!', (d.msg || 'Success'), 'success')
                        .then(() => location.reload());
                    } else { 
                        Swal.fire('Error', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error(e); 
                    Swal.fire('Error', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }

    // [NEW] Report Stolen JS (Refactored with SweetAlert2)
    function reportStolen(pid) {
        Swal.fire({
            title: '🚨 แจ้งสินค้าหาย/ระงับสิทธิ์',
            html: `
                <div style="text-align:left; font-size:14px; line-height:1.6;">
                    เมื่อยืนยันแล้ว:<br>
                    • สินค้าจะถูกระงับสิทธิ์การรับประกันทันที<br>
                    • สถานะจะเปลี่ยนเป็น "ถูกขโมย/ระงับสิทธิ์"<br>
                    • คุณจะไม่สามารถแก้ไขกลับคืนได้ด้วยตนเอง
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'ยืนยันระงับสิทธิ์',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'report_stolen'); // V10 Variable
                fd.append('product_id', pid);
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce);

                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('ดำเนินการสำเร็จ', 'ระบบได้ทำการระงับสิทธิ์สินค้าเรียบร้อยแล้ว', 'success')
                        .then(() => { location.reload(); });
                    } else { 
                        Swal.fire('เกิดข้อผิดพลาด', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error(e); 
                    Swal.fire('เกิดข้อผิดพลาด', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }
    </script>
    <?php
    return ob_get_clean();
}
