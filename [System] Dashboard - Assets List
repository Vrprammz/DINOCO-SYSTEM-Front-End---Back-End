/*
 * Template Name: System Dashboard - Assets List (V26.0 - Full Code & Child Fixed)
 * Description: 
 * - [BASE] Based STRICTLY on V22.0 provided code.
 * - [UX FIX] Bundle Child Cards can now be toggled ON/OFF freely (Removed restrictive onclick).
 * - [DATA FIX] Bundle Child Cards now show FULL details (Warranty, Claims, Repairs) identical to Single Products.
 * - [SAFETY] Added explicit variable resets in child loops to prevent data bleeding (Inactive bug).
 * - [CSS] KEPT ORIGINAL 100% (No Minification).
 * Author: Dinoco Dev Team x UX Specialist
 * Version: 26.0
 */

// [SECURITY] ‡∏´‡πâ‡∏≤‡∏° Cache
if ( ! defined( 'DONOTCACHEPAGE' ) ) {
    define( 'DONOTCACHEPAGE', true );
}

// --------------------------------------------------------------------------
// 1. HELPER FUNCTION: CUSTOM LOGGER (SECURED)
// --------------------------------------------------------------------------
if ( ! function_exists( 'dinoco_security_log' ) ) {
    function dinoco_security_log( $action, $user_id, $details ) {
        $upload_dir = wp_upload_dir();
        
        // [SECURITY FIX] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (Hash) ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ . (Dotfile)
        $secure_hash = md5( 'dinoco_secret_salt_' . date('Ym') ); 
        $log_file = $upload_dir['basedir'] . '/.dinoco_audit_' . $secure_hash . '.log';
        
        // [SECURITY FIX] ‡∏™‡∏£‡πâ‡∏≤‡∏á .htaccess ‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå Log (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        $htaccess_file = $upload_dir['basedir'] . '/.htaccess_dinoco_logs'; 
        
        $timezone = new DateTimeZone('Asia/Bangkok');
        $date = new DateTime('now', $timezone);
        $timestamp = $date->format('Y-m-d H:i:s');
        
        $user_ip = '';
        if ( ! empty( $_SERVER['HTTP_CLIENT_IP'] ) ) {
            $user_ip = $_SERVER['HTTP_CLIENT_IP'];
        } elseif ( ! empty( $_SERVER['HTTP_X_FORWARDED_FOR'] ) ) {
            $user_ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
        } else {
            $user_ip = $_SERVER['REMOTE_ADDR'];
        }
        
        $log_entry = sprintf(
            "[%s] AUTH: User %s | IP: %s | Action: %s | Details: %s" . PHP_EOL,
            $timestamp,
            $user_id,
            $user_ip,
            strtoupper($action),
            $details
        );
        
        @file_put_contents( $log_file, $log_entry, FILE_APPEND | LOCK_EX );
    }
}

add_shortcode( 'dinoco_dashboard_assets', 'dinoco_dashboard_assets_func' );

function dinoco_dashboard_assets_func() {
    
    // [SECURITY] Headers Force No-Cache
    if ( ! is_admin() ) {
        nocache_headers();
        header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
        header("Pragma: no-cache");
    }

    if ( ! is_user_logged_in() ) {
        return '<div style="padding:20px; text-align:center; color:red;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>';
    }

    $current_user_id = get_current_user_id();
    $current_user = wp_get_current_user();
    $current_username = $current_user->user_login;
    
    // --------------------------------------------------------------------------
    // 2. ACTION HANDLER
    // --------------------------------------------------------------------------
    if ( $_SERVER['REQUEST_METHOD'] === 'POST' && isset( $_POST['dinoco_request_v10'] ) ) {
        
        while ( ob_get_level() ) { ob_end_clean(); }
        header('Content-Type: application/json; charset=utf-8');
        error_reporting(0); @ini_set('display_errors', 0);
        
        // [LAYER 1: Token Soft-Fail]
        $received_nonce = isset($_POST['dinoco_auth_v10']) ? $_POST['dinoco_auth_v10'] : '';
        if ( ! wp_verify_nonce( $received_nonce, 'dinoco_nonce_action' ) ) {
             dinoco_security_log('TOKEN_WARNING', $current_user_id, "Token Invalid - Proceeding to Ownership Check");
        }

        $action = $_POST['dinoco_request_v10'];

        // --- ACTION: CREATE BUNDLE ---
        if ( $action === 'create_bundle' ) {
            $target_sku = isset($_POST['target_sku']) ? sanitize_text_field($_POST['target_sku']) : '';
            $child_ids  = isset($_POST['child_ids']) ? $_POST['child_ids'] : [];
            
            if ( empty($target_sku) || empty($child_ids) || !is_array($child_ids) ) {
                echo json_encode(['success' => false, 'msg' => '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô']);
                exit;
            }

            $safe_child_ids = array_map('intval', $child_ids);

            foreach ($safe_child_ids as $chk_id) {
                $db_owner = get_post_meta($chk_id, 'owner_product', true);
                if ( trim( (string)$db_owner ) !== trim( (string)$current_username ) ) {
                    echo json_encode(['success' => false, 'msg' => "SECURITY: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ID $chk_id ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"]);
                    exit;
                }
                
                $existing = get_post_meta($chk_id, 'current_bundle_id', true);
                if ( ! empty($existing) ) {
                    echo json_encode(['success' => false, 'msg' => "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡∏ä‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"]);
                    exit;
                }
            }

            $first_child_id = $safe_child_ids[0];
            $owner_line_id_val = get_post_meta($first_child_id, 'owner_product', true);

            $bundle_post_data = [
                'post_title'    => 'Set ' . $target_sku . ' - ' . date('YmdHis'),
                'post_type'     => 'product_bundle',
                'post_status'   => 'publish',
                'post_author'   => $current_user_id
            ];
            $bundle_id = wp_insert_post( $bundle_post_data );

            if ( $bundle_id && ! is_wp_error( $bundle_id ) ) {
                update_post_meta($bundle_id, 'bundle_sku', $target_sku);
                update_post_meta($bundle_id, 'bundle_owner', $current_user_id);
                update_post_meta($bundle_id, 'bundle_owner_id', $owner_line_id_val);
                
                if ( function_exists('update_field') ) {
                    update_field('bundle_children', $safe_child_ids, $bundle_id);
                } else {
                    update_post_meta($bundle_id, 'bundle_children', $safe_child_ids);
                }

                foreach ($safe_child_ids as $cid) {
                    update_post_meta($cid, 'current_bundle_id', $bundle_id);
                }
                
                dinoco_security_log( 'CREATE_SUCCESS', $current_user_id, "Bundle $bundle_id Created" );
                echo json_encode(['success' => true, 'msg' => '‡∏£‡∏ß‡∏°‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!']);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Create Failed']);
            }
            exit;
        }
        
        // --- ACTION: DELETE BUNDLE ---
        if ( $action === 'delete_bundle' ) {
            $bundle_id = isset($_POST['bundle_id']) ? intval($_POST['bundle_id']) : 0;
            
            if ( $bundle_id > 0 ) {
                $verify_owner = get_post_meta($bundle_id, 'bundle_owner', true);
                if ( intval($verify_owner) !== intval($current_user_id) && !current_user_can('manage_options') ) {
                     echo json_encode(['success' => false, 'msg' => '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ']);
                     exit;
                }

                $children = [];
                if ( function_exists('get_field') ) {
                    $acf_c = get_field('bundle_children', $bundle_id);
                    if ( $acf_c && is_array($acf_c) ) {
                        $children = $acf_c;
                    }
                }
                if ( empty($children) ) {
                    $meta_c = get_post_meta($bundle_id, 'bundle_children', true);
                    if ( $meta_c ) {
                         $children = is_array($meta_c) ? $meta_c : [$meta_c];
                         if(isset($children[0]) && is_array($children[0])) $children = $children[0];
                    }
                }
                
                if ( !empty($children) ) {
                    foreach ( $children as $child ) {
                        $cid = is_object($child) ? $child->ID : $child;
                        $cid = intval($cid);
                        if($cid > 0) delete_post_meta($cid, 'current_bundle_id');
                    }
                }
                
                wp_delete_post($bundle_id, true);
                
                dinoco_security_log( 'DELETE_SUCCESS', $current_user_id, "Deleted Bundle $bundle_id" );
                echo json_encode(['success' => true, 'msg' => '‡πÅ‡∏¢‡∏Å‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢']);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Invalid ID']);
            }
            exit;
        }

        // --- ACTION: SAVE TRACKING ---
        if ( $action === 'save_track' ) {
             $tid = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
             $track = isset($_POST['tracking']) ? sanitize_text_field($_POST['tracking']) : '';
             if($tid && $track) {
                 update_post_meta($tid, 'tracking_inbound', $track);
                 update_post_meta($tid, 'ticket_status', 'shipping_in');
                 echo json_encode(['success' => true]);
             } else {
                 echo json_encode(['success' => false, 'msg' => 'Error']);
             }
             exit;
        }

        // --- ACTION: CONFIRM RECEIPT ---
        if ( $action === 'confirm_receipt' ) {
            $tid = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
            if($tid) {
                update_post_meta($tid, 'ticket_status', 'completed');
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false]);
            }
            exit;
        }
        
        // --- ACTION: REPORT STOLEN ---
        if ( $action === 'report_stolen' ) {
            $pid = isset($_POST['product_id']) ? intval($_POST['product_id']) : 0;
            
            if ( $pid > 0 ) {
                $db_owner = get_post_meta($pid, 'owner_product', true);
                if ( trim( (string)$db_owner ) !== trim( (string)$current_username ) ) {
                     echo json_encode(['success' => false, 'msg' => "SECURITY: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ID $pid ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"]);
                     exit;
                }
                
                update_post_meta($pid, 'w_status', 'stolen');
                dinoco_security_log('REPORT_STOLEN', $current_user_id, "Reported Stolen Item ID: $pid");
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'msg' => 'Invalid ID']);
            }
            exit;
        }
    }

    // --------------------------------------------------------------------------
    // 3. DISPLAY LOGIC (FRONTEND)
    // --------------------------------------------------------------------------
    $dinoco_system_notice = get_query_var('dinoco_notice_msg', '');
    $product_catalog = get_option( 'dinoco_product_catalog', [] );
    if ( ! is_array( $product_catalog ) ) { $product_catalog = []; }
    $sku_relations = get_option( 'dinoco_sku_relations', [] );
    if ( ! is_array( $sku_relations ) ) { $sku_relations = []; }

    $bundle_recipes = [];
    if ( ! empty( $sku_relations ) ) {
        foreach ( $sku_relations as $parent_sku => $child_skus ) {
            $set_info = isset( $product_catalog[$parent_sku] ) ? $product_catalog[$parent_sku] : [];
            $safe_img = !empty($set_info['img']) ? $set_info['img'] : 'https://placehold.co/150x150?text=Set';
            $bundle_recipes[$parent_sku] = [
                'name'    => !empty($set_info['name']) ? $set_info['name'] : 'Set Bundle (' . $parent_sku . ')',
                'img'     => $safe_img,
                'req_sku' => $child_skus
            ];
        }
    }

    $thai_couriers = [
        'Thailand Post' => '‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÑ‡∏ó‡∏¢ (Thailand Post)', 'Kerry Express' => 'Kerry Express', 'Flash Express' => 'Flash Express', 'J&T Express' => 'J&T Express', 'DHL' => 'DHL eCommerce', 'Best Express' => 'Best Express', 'Ninja Van' => 'Ninja Van', 'SCG Express' => 'SCG Express', 'Inter Express' => 'Inter Express', 'Nim Express' => 'Nim Express', 'GrabExpress' => 'GrabExpress (Messenger)', 'Lineman' => 'Lineman (Messenger)'
    ];

    $action_map = [ 
        'fg_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 10%','fg_l_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%','fg_r_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%','fg_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 20%','fg_l_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%','fg_r_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%','fg_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 30%','fg_l_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%','fg_r_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%','fg_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 40%','fg_l_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%','fg_r_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%','fg_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 50%','fg_l_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%','fg_r_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%','eg_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 10%','eg_l_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%','eg_r_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%','eg_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 20%','eg_l_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%','eg_r_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%','eg_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 30%','eg_l_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%','eg_r_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%','eg_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 40%','eg_l_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%','eg_r_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%','eg_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 50%','eg_l_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%','eg_r_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%','tr_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 10%','tr_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 20%','tr_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 30%','tr_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 40%','tr_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 50%','sr_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 10%','sr_l_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%','sr_r_10'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%','sr_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 20%','sr_l_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%','sr_r_20'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%','sr_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 30%','sr_l_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%','sr_r_30'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%','sr_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 40%','sr_l_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%','sr_r_40'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%','sr_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 50%','sr_l_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%','sr_r_50'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%','repaint_minor'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ó‡∏≥‡∏™‡∏µ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢','align_minor'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏®‡∏≤‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢','align_medium'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏®‡∏≤‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á','rep_plastic'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏ï‡∏¥‡∏Å','rep_plastic_l'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢','rep_plastic_r'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤','rep_key'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏Å‡∏∏‡∏ç‡πÅ‡∏à','rep_mount'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á(‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á)','rep_tray'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á','rep_seal'=>'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ã‡∏µ‡∏•‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö','original'=>'Original : ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå','repaired'=>'Repainted : ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏µ','minor_fix'=>'Minor Fix : ‡∏î‡∏±‡∏î‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏á','welded'=>'Welded : ‡∏ã‡πà‡∏≠‡∏°‡∏î‡∏±‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î','modified'=>'Modified : ‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á/‡∏ã‡πà‡∏≠‡∏°‡∏´‡∏ô‡∏±‡∏Å','sticker_45l_1'=>'‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 45L 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)','sticker_38l_1'=>'‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 38L 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)','sticker_38l_2'=>'‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 38L 1 ‡∏ä‡∏∏‡∏î (4‡πÅ‡∏ú‡πà‡∏ô)','sticker_hand'=>'‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏Æ‡∏ô‡∏î‡πå 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)','plate_nx500'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ NX500 ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡πâ‡∏≤ 1 ‡∏ä‡∏¥‡πâ‡∏ô','plate_dinoco_1'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 1 ‡∏ä‡∏¥‡πâ‡∏ô','plate_dinoco_2'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 2 ‡∏ä‡∏¥‡πâ‡∏ô','plate_dinoco_3'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 3 ‡∏ä‡∏¥‡πâ‡∏ô','plate_dinoco_4'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 4 ‡∏ä‡∏¥‡πâ‡∏ô','plate_dinoco_5'=>'‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 5 ‡∏ä‡∏¥‡πâ‡∏ô'
    ];

    $status_display_map = [ 
        'warranty_on'        => '‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', 
        'original'           => '‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', 
        'repaired'           => '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', 
        'refurbished'        => '‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 
        'modified'           => '‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏†‡∏≤‡∏û', 
        'repainted'          => '‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏µ', 
        'minor_fix'          => '‡∏î‡∏±‡∏î‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏á', 
        'welded'             => '‡∏ã‡πà‡∏≠‡∏°‡∏î‡∏±‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î', 
        'claim_process'      => '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', 
        'warranty_pending'   => '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 
        'warranty_expiry'    => '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', 
        'warranty_available' => '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ',
        'stolen'             => '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
        'inactive'           => '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'
    ];

    // Queries Logic
    $my_bundles = new WP_Query([ 
        'post_type' => 'product_bundle', 
        'posts_per_page' => -1, 
        'meta_query' => [[ 'key' => 'bundle_owner', 'value' => $current_user_id, 'compare' => '=' ]] 
    ]);

    $my_singles = new WP_Query([ 
        'post_type' => 'serial_number', 
        'posts_per_page' => -1, 
        'meta_key' => 'owner_product', 
        'meta_value' => $current_username,
        'meta_query' => [ 
            'relation' => 'AND', 
            [ 
                'relation' => 'OR', 
                ['key' => 'current_bundle_id', 'compare' => 'NOT EXISTS'], 
                ['key' => 'current_bundle_id', 'value' => '', 'compare' => '='] 
            ] 
        ] 
    ]);
    
    // Bundle Opportunity Check Logic
    $inventory_map = []; 
    $ready_to_bundle = [];

    if ( $my_singles->have_posts() ) { 
        while ( $my_singles->have_posts() ) { 
            $my_singles->the_post(); 
            $s_id = get_the_ID(); 
            $s_sku = get_post_meta($s_id, 'product_sku', true);
            if ( $s_sku ) { 
                if ( !isset($inventory_map[$s_sku]) ) $inventory_map[$s_sku] = []; 
                $inventory_map[$s_sku][] = $s_id; 
            } 
        } 
        $my_singles->rewind_posts(); 
    }

    foreach ( $bundle_recipes as $r_sku => $recipe ) { 
        $required = $recipe['req_sku']; 
        $found_ids = []; 
        $is_possible = true; 
        $temp_inv = $inventory_map; 

        foreach ( $required as $req_sku ) { 
            if ( !empty($temp_inv[$req_sku]) && count($temp_inv[$req_sku]) > 0 ) { 
                $found_ids[] = array_shift($temp_inv[$req_sku]); 
            } else { 
                $is_possible = false; 
                $break; 
            } 
        } 
        
        if ( $is_possible ) { 
            $ready_to_bundle[] = [
                'sku' => $r_sku,
                'name' => $recipe['name'],
                'child_ids' => $found_ids
            ]; 
        } 
    }

    $total_display = $my_bundles->found_posts + $my_singles->found_posts;

    ob_start();
    ?>
    <!-- [UX] SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* CSS for Assets List - Full Expansion Mode */
        .prod-list-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-top: 15px; 
            align-items: start; /* Changed from stretch to start to avoid weird height issues */
            grid-auto-rows: min-content; /* Ensure rows don't stretch unnaturally */
        }
        
        /* Wrapper must be flex to stretch inner card */
        .prod-item-wrapper { 
            width: 100%; 
            display: flex; 
            flex-direction: column;
            height: auto; /* Changed to auto to let content dictate height */
            transition: all 0.3s ease; 
            position: relative; 
            /* Unified spacing */
            margin-top: 0;
            padding-top: 0;
            /* [FIX V16.5] Prevent Grid Blowout */
            min-width: 0; 
            overflow: hidden;
            box-sizing: border-box; /* [FIX V16.8] Ensure padding doesn't affect width */
        }
        
        /* [FIX V15.5] Full Row Expansion */
        .prod-item-wrapper.expanded {
            grid-column: 1 / -1; /* Take full width of 2 columns when expanded */
        }
        
        /* Summary Card fills the wrapper and pushes content down */
        .prod-summary-card { 
            background: #fff; 
            border-radius: 15px; 
            overflow: hidden; 
            border: 1px solid #e2e8f0; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03); 
            height: 100%; /* Stretch to fill wrapper */
            flex-grow: 1; 
            position: relative;
            z-index: 2;
        }
        
        .prod-item-wrapper:not(.expanded) .prod-summary-card { 
            min-height: 240px; 
        }
        
        .prod-summary-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); 
            border-color: #cbd5e1; 
        }
        
        .summary-status-header { 
            position: relative; 
            width: 100%; 
            padding: 8px 5px; 
            font-size: 13px; 
            font-weight: bold; 
            color: white; 
            text-align: center; 
            display: block; 
            z-index: 10; 
        }
        
        .st-green { background: #06C755; }
        .st-light-green { background: #4ade80; color: #fff; }
        .st-red { background: #e11d48; }
        .st-orange { background: #f97316; }
        .st-gray { background: #64748b; }
        .st-dark { background: #1f2937; } /* STOLEN */
        
        .prod-item-wrapper.expanded .summary-status-header { 
            display: none !important; 
        }
        
        /* Card Body */
        .summary-card-body { 
            position: relative; 
            width: 100%; 
            flex-grow: 1; /* Grow to fill space */
            display: flex; 
            flex-direction: column; 
            padding: 0; 
            overflow: hidden; 
            /* [FIX V16.9] Force Center Alignment */
            align-items: center;
            justify-content: center;
        }
        
        /* [FIX V16.6] Image Standard */
        .summary-icon { 
            width: 100%; 
            height: 140px; 
            object-fit: contain; 
            object-position: center; 
            background: #ffffff !important; 
            padding: 10px; 
            transition: transform 0.3s; 
        }
        
        /* Info Area fills remaining space */
        .summary-info { 
            background: #f8fafc !important; 
            border-top: 1px solid #f1f5f9; 
            padding: 15px 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; /* Start from top */
            text-align: center; 
            width: 100%; 
            flex-grow: 1; /* Push bottom content */
            gap: 5px; 
        }
        
        .summary-title { 
            font-size: 14px; 
            font-weight: 700; 
            color: #333; 
            line-height: 1.5; 
            width: 100%; 
            text-align: center !important; 
            white-space: normal !important; 
            word-wrap: break-word !important; 
            overflow-wrap: break-word !important; 
            display: block; 
            margin-bottom: 5px; 
        }
        
        /* SN at the bottom using auto margin */
        .summary-sn { 
            font-size: 11px; 
            color: #64748b; 
            margin-top: auto; 
            text-align: center !important; 
            width: 100%; 
            display: block; 
        }
        
        /* Expanded State Logic */
        .prod-item-wrapper.expanded .prod-summary-card { 
            flex-direction: row; 
            aspect-ratio: auto; 
            min-height: 90px; 
            height: auto; 
            align-items: stretch; 
            padding: 0; 
            background: #fff; 
            border-bottom: 1px solid #f0f0f0; 
            border-radius: 12px 12px 0 0; 
            border: 1px solid #e2e8f0; 
            border-bottom: none; 
        }
        
        .prod-item-wrapper.expanded .summary-card-body { 
            flex-direction: row; 
            padding: 0; 
            width: 100%; 
            height: auto; 
            position: relative; 
        }
        
        .prod-item-wrapper.expanded .summary-icon { 
            width: 90px; 
            height: auto; 
            min-height: 90px; 
            padding: 0; 
            object-fit: cover; 
            border-right: 1px solid #f1f5f9; 
        }
        
        .prod-item-wrapper.expanded .summary-info { 
            border-top: none; 
            background: #ffffff !important; 
            width: auto; 
            flex-grow: 1; 
            padding: 15px 60px 15px 15px !important; 
            align-items: flex-start; 
            justify-content: center; 
            text-align: left; 
        }
        
        .prod-item-wrapper.expanded .summary-title { 
            font-size: 16px; 
            margin-top: 5px; 
            margin-bottom: 8px; 
            text-align: left !important; 
            width: 100%; 
        }
        
        .prod-item-wrapper.expanded .summary-sn { 
            text-align: left !important; 
            margin-top: 0; 
        }
        
        .prod-detail-wrapper { 
            display: none; 
            margin-top: 0; 
            animation: slideDown 0.3s ease-out; 
        }
        
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .prod-detail-wrapper .prod-card { 
            background: #fff; 
            border-radius: 0 0 12px 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e2e8f0; 
            border-top: none; 
            margin-bottom: 0 !important; 
        }
        
        .prod-status-bar { 
            text-align: center; 
            font-size: 14px; 
            padding: 10px; 
            font-weight: bold; 
            display: block; 
            color: white; 
        }
        
        .prod-img-area { 
            width: 100%; 
            height: 220px; 
            background: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            border-bottom: 1px solid #eee; 
        }
        
        .prod-img-area img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }
        
        .prod-body { 
            padding: 20px; 
        }
        
        .prod-model { 
            font-size: 14px !important; 
            font-weight: 700 !important; 
            color: #333 !important; 
            margin: 0 0 5px 0 !important; 
            display: block !important; 
        }
        
        .prod-sku { 
            font-size: 13px; 
            color: #888; 
            margin-bottom: 15px; 
            font-family: 'Kanit', sans-serif; 
            display: block; 
        }
        
        .barcode-section { 
            text-align: center; 
            margin: 20px 0; 
            overflow-x: auto; 
            white-space: nowrap; 
            max-width: 100%; 
        }
        
        .barcode-font { 
            font-family: 'Libre Barcode 39 Text', cursive; 
            font-size: 30px; 
            color: #333; 
            line-height: 1; 
            display: inline-block;
            vertical-align: middle;
        }

        .warranty-new-ui { 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            background: #fff; 
        }
        
        .w-usage-section { 
            padding: 15px; 
            text-align: center; 
            border-bottom: 1px dashed #eee; 
        }
        
        .w-usage-label { 
            font-size: 12px; 
            color: #64748b; 
            margin-bottom: 5px; 
        }
        
        .w-usage-val { 
            font-size: 20px; 
            font-weight: bold; 
            color: #334155; 
            font-family: 'Kanit', sans-serif; 
        }
        
        .w-detail-section { 
            padding: 15px; 
            font-size: 13px; 
        }
        
        .w-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
        }
        
        .w-row-label { 
            color: #64748b; 
        }
        
        .w-row-val { 
            font-weight: bold; 
            color: #333; 
        }
        
        .w-status-active { 
            color: #06C755; 
            font-weight: bold; 
        }
        
        .w-green-bar { 
            background: #06C755; 
            color: #fff; 
            text-align: center; 
            padding: 10px; 
            font-weight: bold; 
            font-size: 14px; 
            display: block; 
        }
        
        .w-red-bar { 
            background: #e11d48; 
            color: #fff; 
            text-align: center; 
            padding: 10px; 
            font-weight: bold; 
            font-size: 14px; 
            display: block; 
        }
        
        .status-row { 
            margin-top: 15px; 
            background: #f1f5f9; 
            padding: 10px 15px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid #e2e8f0; 
        }
        
        .st-label { 
            font-size: 13px; 
            font-weight: 600; 
            color: #64748b; 
        }
        
        .st-val { 
            font-size: 12px; 
            font-weight: bold; 
            color: #334155; 
        }
        
        .repair-area { 
            margin-top: 15px; 
            border-top: 1px dashed #eee; 
            padding-top: 15px; 
        }
        
        .repair-head { 
            font-size: 14px; 
            font-weight: 600; 
            color: #555; 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .repair-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        
        .repair-item { 
            font-size: 12px; 
            color: #666; 
            padding: 6px 8px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
        }
        
        .repair-item:last-child { 
            border-bottom: none; 
        }
        
        .r-date { 
            font-weight: 600; 
            color: #333; 
            min-width: 80px; 
            font-size: 12px; 
        }
        
        .r-action { 
            flex-grow: 1; 
            text-align: right; 
            font-size: 12px; 
        }
        
        /* Timeline CSS */
        .tl-wrap { 
            padding: 0 5px; 
            margin-top: 20px; 
        }
        
        .tl-row { 
            display: flex; 
            justify-content: space-between; 
            position: relative; 
            margin-bottom: 20px; 
        }
        
        .tl-line { 
            position: absolute; 
            top: 12px; 
            left: 10px; 
            right: 10px; 
            height: 2px; 
            background: #e2e8f0; 
            z-index: 0; 
        }
        
        .tl-item { 
            position: relative; 
            z-index: 1; 
            text-align: center; 
            width: 100%; 
        }
        
        .tl-dot { 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            background: #fff; 
            border: 2px solid #d1d5db; 
            margin: 0 auto 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: bold; 
            color: #9ca3af; 
        }
        
        .tl-item.active .tl-dot { 
            background: #06C755; 
            border-color: #06C755; 
            color: #fff; 
        }
        
        .tl-txt { 
            font-size: 10px; 
            color: #6b7280; 
            display: block; 
            line-height: 1.2; 
            padding: 0 2px; 
        }
        
        .tl-item.active .tl-txt { 
            color: #06C755; 
            font-weight: 600; 
        }
        
        .tl-tracking-box { 
            background: #fff7ed; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            border: 1px solid #ffedd5; 
            margin-top: 20px; 
        }
        
        .outbound-track-card { 
            margin-top: 15px; 
            background: #ffffff; 
            border-radius: 12px; 
            border: 1px solid #cbd5e1; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
            text-align: left; 
        }
        
        .ot-header { 
            background: #f1f5f9; 
            padding: 10px 15px; 
            font-size: 13px; 
            font-weight: bold; 
            color: #475569; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            border-bottom: 1px solid #e2e8f0; 
        }
        
        .ot-body { 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .ot-info { 
            display: flex; 
            flex-direction: column; 
        }
        
        .ot-courier { 
            font-size: 12px; 
            color: #64748b; 
            margin-bottom: 2px; 
        }
        
        .ot-number { 
            font-size: 16px; 
            font-weight: bold; 
            color: #0f172a; 
            font-family: monospace; 
            letter-spacing: 0.5px; 
        }
        
        .btn-confirm-receipt { 
            display: block; 
            width: 100%; 
            margin-top: 10px; 
            background: #1e293b; 
            color: #fff; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        
        .confirm-note { 
            font-size: 10px; 
            color: #94a3b8; 
            margin-top: 8px; 
            text-align: center; 
            font-style: italic; 
        }
        
        .btn-unbundle { 
            background: #fff; 
            color: #ef4444; 
            border: 1px solid #ef4444; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 10px; 
            font-weight: bold;
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            gap: 3px; 
            margin-top: 5px;
        }
        
        .btn-unbundle:hover { 
            background: #ef4444; 
            color: #fff; 
        }

        .bundle-content { 
            padding: 15px; 
            background: #f8fafc;
        }
        
        /* [FIX V15.5] Image Contain everywhere */
        .bundle-img { 
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            border-radius: 10px; 
            border: 1px solid #eee; 
            background: #fff; 
        }

        /* [FIX V16.6] Revert Bundle Children to Single Column List */
        .bundle-children-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Single column list */
            gap: 15px; 
        }
        
        /* [FIX V16.6] Revert Bundle Child to Horizontal Row Layout */
        .child-in-bundle .prod-summary-card { 
            min-height: auto !important; 
            flex-direction: row; /* Horizontal Layout */
            height: auto; 
            border-radius: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
            background: #fff;
            align-items: stretch;
        }
        
        .child-in-bundle .summary-status-header { 
            display: none; 
        }
        
        .child-in-bundle .summary-card-body { 
            flex-direction: row; /* Horizontal Body */
            height: auto; 
            width: 100%;
        }
        
        /* [FIX V16.8] Force 100px Square Image (1x1) with Contain - STRENGTHENED */
        .child-in-bundle .summary-icon { 
            width: 100px !important; 
            height: 100px !important; 
            min-width: 100px !important; /* Prevent shrinking */
            min-height: 100px !important;
            padding: 5px; 
            border-right: 1px solid #f1f5f9; 
            border-bottom: none;
            object-fit: contain; /* Ensure full image is visible */
            background: #fff;
        }
        
        .child-in-bundle .summary-info { 
            padding: 10px; 
            align-items: flex-start; /* Left align text */
            text-align: left; 
            border-top: none; 
            background: #fff !important; 
            flex-grow: 1;
        }
        
        .child-in-bundle .summary-title { 
            font-size: 13px; 
            text-align: left !important; 
            margin-bottom: 2px; 
        }
        
        .child-in-bundle .summary-sn { 
            font-size: 10px; 
            text-align: left !important; 
            margin-top: auto;
        }
        
        .child-in-bundle .mini-status-badge { 
            font-size: 9px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-top: 4px; 
            display: inline-block; 
            font-weight: bold; 
        }
        
        .child-in-bundle.expanded .prod-summary-card { 
            border-radius: 10px 10px 0 0; 
            background: #fff; 
            border-bottom: none; 
        }
        
        /* [FIX V15.5] Explicit full row for expanded child */
        .child-in-bundle.expanded {
            grid-column: 1 / -1;
        }
        
        /* Ready to Bundle Notification */
        .ready-bundle-box { 
            grid-column: 1 / -1; 
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); 
            border: 2px dashed #f97316; 
            border-radius: 12px; 
            padding: 20px; 
            text-align: center; 
            margin-bottom: 40px; 
            margin-top: 10px; 
            animation: pulseBorder 2s infinite; 
        }
        
        @keyframes pulseBorder { 
            0% { border-color: #fb923c; box-shadow: 0 0 0 rgba(249, 115, 22, 0); } 
            50% { border-color: #f97316; box-shadow: 0 0 15px rgba(249, 115, 22, 0.2); } 
            100% { border-color: #fb923c; box-shadow: 0 0 0 rgba(249, 115, 22, 0); } 
        }
        
        .btn-merge { 
            background: #f97316; 
            color: white; 
            border: none; 
            padding: 10px 25px; 
            border-radius: 50px; 
            font-weight: bold; 
            font-size: 14px; 
            cursor: pointer; 
            margin-top: 10px; 
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); 
            transition: transform 0.2s; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .btn-merge:hover { 
            transform: scale(1.05); 
            background: #ea580c; 
        }
        
        /* Section Header */
        .section-header-desktop { 
            display: block !important; 
            font-size: 24px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
        }
        
        .section-header-mobile { 
            display: none !important; 
        }
        
        @media (max-width: 1023px) {
            .section-header-desktop { display: none !important; }
            .section-header-mobile { display: block; }
            .prod-list-container { grid-template-columns: repeat(2, 1fr) !important; }
        }
        
        /* [NEW] Stolen Button CSS */
        .btn-stolen {
            display: block;
            width: 100%;
            margin-top: 15px;
            background: #ef4444; /* red-500 */
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
            text-align: center;
        }
        
        .btn-stolen:hover {
            background: #dc2626; /* red-600 */
            transform: translateY(-1px);
        }

        /* Loader */
        .dinoco-loader-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.8); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            backdrop-filter: blur(2px); 
        }
        
        .dinoco-spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #06C755; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* SweetAlert2 Custom Overrides for Dinoco Theme */
        .swal2-popup {
            font-family: 'Kanit', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title {
            font-size: 20px !important;
            color: #333 !important;
        }
        .swal2-confirm {
            background-color: #0f172a !important;
            border-radius: 8px !important;
        }
        .swal2-cancel {
            background-color: #94a3b8 !important;
            border-radius: 8px !important;
        }

        /* [ULTIMATE FIX] Safety Net - Prevent Layout Explosion */
        /* 1. Hide Detail Wrapper specifically if not expanded */
        .prod-item-wrapper:not(.expanded) .prod-detail-wrapper {
            display: none !important;
        }
        /* 2. Hide any loose prod-card just in case */
        .prod-item-wrapper:not(.expanded) > .prod-card {
            display: none !important;
        }
        /* 3. Force detail card to show when inside active wrapper */
        .prod-detail-wrapper .prod-card {
            display: block; 
        }
        /* 4. Reset Grid Column */
        .prod-item-wrapper:not(.expanded) {
            grid-column: auto !important;
        }
    </style>

    <div id="dinoco-loader" class="dinoco-loader-overlay">
        <div class="dinoco-spinner"></div>
        <div style="margin-top:10px; font-weight:bold; color:#555;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <div class="dashboard-main">
        <?php echo $dinoco_system_notice; ?>
        
        <h4 class="section-header section-header-desktop">üì¶ ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô (<?php echo $total_display; ?>) ‡∏ä‡∏¥‡πâ‡∏ô</h4>
        <h4 class="section-header section-header-mobile">üì¶ ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô (<?php echo $total_display; ?>) ‡∏ä‡∏¥‡πâ‡∏ô</h4>

        <?php if ( ! empty($ready_to_bundle) ) : ?>
            <?php foreach ( $ready_to_bundle as $opp ) : ?>
                <div class="ready-bundle-box">
                    <div style="font-size:18px; font-weight:bold; color:#c2410c; margin-bottom:5px;">
                        <i class="fas fa-magic"></i> ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ!
                    </div>
                    <div style="color:#666; font-size:14px; margin-bottom:15px;">
                        ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î <strong>"<?php echo esc_html($opp['name']); ?>"</strong>
                    </div>
                    <button class="btn-merge" onclick='createBundle("<?php echo $opp['sku']; ?>", <?php echo json_encode($opp['child_ids']); ?>)'>
                        ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Merge)
                    </button>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
        
        <div id="prod-container" class="prod-list-container">
            <!-- BUNDLE LOOP: Inside the grid container now -->
            <?php if ( $my_bundles->have_posts() ) : ?>
                <?php while ( $my_bundles->have_posts() ) : $my_bundles->the_post(); 
                    $bid = get_the_ID();
                    $b_sku = get_post_meta($bid, 'bundle_sku', true);
                    
                    // Get Children IDs [CRITICAL FIX: CHECK FUNCTION EXISTS]
                    $b_children_raw = (function_exists('get_field')) ? get_field('bundle_children', $bid) : null; 
                    $b_children = [];
                    if ( $b_children_raw && is_array($b_children_raw) ) {
                        foreach($b_children_raw as $c) {
                            $b_children[] = is_object($c) ? $c->ID : $c;
                        }
                    } else {
                         $meta_children = get_post_meta($bid, 'bundle_children', true);
                         if(is_array($meta_children)) $b_children = $meta_children;
                    }
                    
                    $b_info = isset($bundle_recipes[$b_sku]) ? $bundle_recipes[$b_sku] : [];
                    $b_name = isset($b_info['name']) ? $b_info['name'] : get_the_title();
                    $b_img  = isset($b_info['img']) ? $b_info['img'] : 'https://placehold.co/150x150?text=Set';
                ?>
                    <!-- New Bundle Card: Matches Single Product Wrapper with extra class 'is-bundle' -->
                    <div class="prod-item-wrapper is-bundle" id="wrapper_bundle_<?php echo $bid; ?>">
                        <div class="prod-summary-card" onclick="toggleSmartCard('bundle_<?php echo $bid; ?>')">
                            <!-- Green Header for Bundle -->
                            <div class="summary-status-header st-green">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ã‡πá‡∏ï (Set)</div>
                            
                            <div class="summary-card-body">
                                <img src="<?php echo esc_url($b_img); ?>" class="summary-icon">
                                <div class="summary-info">
                                    <div class="summary-title"><i class="fas fa-cubes"></i> <?php echo esc_html($b_name); ?></div>
                                    <div class="summary-sn" style="color:#15803d; font-weight:bold;">‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <?php echo count($b_children); ?> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                                    
                                    <button class="btn-unbundle" onclick="event.stopPropagation(); deleteBundle(<?php echo $bid; ?>)">
                                        <i class="fas fa-unlink"></i> ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ã‡πá‡∏ï
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bundle Detail View (Shows Children Grid) -->
                        <!-- [SAFETY] Added inline style display:none -->
                        <div id="detail_bundle_<?php echo $bid; ?>" class="prod-detail-wrapper" style="display:none;">
                            <div class="prod-card">
                                <div class="prod-status-bar st-green">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ã‡πá‡∏ï</div>
                                <div class="bundle-content">
                                    <div class="bundle-children-grid">
                                        <?php 
                                        if ( ! empty($b_children) ) : 
                                            foreach ( $b_children as $child_id ) : 
                                                $pid = $child_id;
                                                $sn  = get_post_meta($pid, 'serial_code', true); 
                                                $sku = get_post_meta($pid, 'product_sku', true);
                                                $w_status_raw = get_post_meta($pid, 'w_status', true);
                                                $w_status     = is_array( $w_status_raw ) ? ( isset( $w_status_raw['value'] ) ? $w_status_raw['value'] : ( isset( $w_status_raw[0] ) ? $w_status_raw[0] : '' ) ) : $w_status_raw; 
                                                $w_status     = trim( $w_status );

                                                $catalog_item = isset( $product_catalog[ $sku ] ) ? $product_catalog[ $sku ] : null;
                                                $img_url      = ( $catalog_item && ! empty( $catalog_item['img'] ) ) ? $catalog_item['img'] : 'https://placehold.co/400x300?text=No+Image';
                                                
                                                $model_name = '';
                                                if ( $catalog_item && ! empty( $catalog_item['name'] ) ) {
                                                    $model_name = $catalog_item['name'];
                                                } else {
                                                    $model_obj  = (function_exists('get_field')) ? get_field( 'product_model', $pid ) : null; 
                                                    $model_name = is_object( $model_obj ) ? $model_obj->post_title : ( is_numeric( $model_obj ) ? get_the_title( $model_obj ) : ( $model_obj ?: "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)" ) );
                                                }
                                                
                                                // --- [DATA FIX] Full Detail Logic Injection for Children ---
                                                // 1. Reset Variables
                                                $st_cls = 'st-green'; 
                                                $st_txt = '‚úÖ ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                                                $mini_badge_bg = '#dcfce7'; 
                                                $mini_badge_col = '#166534';
                                                $is_expired_header = false;
                                                $chk_w = strtolower( $w_status );

                                                // 2. Check Expiry
                                                $header_expire_check = get_post_meta($pid, 'warranty_expiry', true);
                                                if ( ! $header_expire_check ) {
                                                    $reg_d = get_post_meta($pid, 'warranty_register_date', true);
                                                    $dur_y = (int) get_post_meta($pid, 'warranty_duration_years', true);
                                                    if ( $reg_d && $dur_y > 0 ) {
                                                        $tmp_date = DateTime::createFromFormat( 'd/m/Y', $reg_d );
                                                        if ( $tmp_date ) {
                                                            $tmp_date->modify( "+$dur_y years" );
                                                            $tmp_date->setTime( 23, 59, 59 );
                                                            if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                                                        }
                                                    }
                                                } else {
                                                    $tmp_date = DateTime::createFromFormat( 'd/m/Y', $header_expire_check );
                                                    if ( ! $tmp_date ) $tmp_date = new DateTime( $header_expire_check );
                                                    $tmp_date->setTime( 23, 59, 59 );
                                                    if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                                                }
                                                
                                                // 3. Status Logic
                                                if ( strpos( $chk_w, 'claim' ) !== false ) { 
                                                    $tks_header = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                                                    if ( $tks_header ) {
                                                        $cond_header_val = (function_exists('get_field')) ? get_field( 'claim_condition', $tks_header[0]->ID ) : '';
                                                        if ( is_array( $cond_header_val ) ) { $cond_header_val = isset( $cond_header_val['value'] ) ? $cond_header_val['value'] : $cond_header_val[0]; }
                                                        if ( trim( $cond_header_val ) === 'send_part' ) { $st_cls = 'st-light-green'; $st_txt = 'üì¶ ‡∏£‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'; $mini_badge_bg = '#dcfce7'; $mini_badge_col = '#15803d'; } 
                                                        else { $st_cls = 'st-orange'; $st_txt = 'üîß ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                                                    } else { $st_cls = 'st-orange'; $st_txt = 'üîß ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                                                } elseif ( $is_expired_header || strpos( $chk_w, 'expire' ) !== false ) { $st_cls = 'st-red'; $st_txt = '‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; } 
                                                elseif ( $chk_w == 'warranty_pending' ) { $st_cls = 'st-red'; $st_txt = '‚õî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; }
                                                
                                                if ( $chk_w === 'inactive' ) { $st_cls = 'st-gray'; $st_txt = '‚ö™ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; $mini_badge_bg = '#f1f5f9'; $mini_badge_col = '#64748b'; }

                                                elseif ( $chk_w === 'stolen' ) { $st_cls = 'st-dark'; $st_txt = 'üö´ ‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'; $mini_badge_bg = '#1f2937'; $mini_badge_col = '#ffffff'; }
                                                ?>
                                                
                                                <div class="prod-item-wrapper child-in-bundle" id="wrapper_<?php echo $pid; ?>">
                                                    <!-- [UX FIX] Removed logic that prevented re-toggling -->
                                                    <div class="prod-summary-card" onclick="toggleSmartCard('<?php echo $pid; ?>')">
                                                        <div class="summary-card-body">
                                                            <img src="<?php echo esc_url( $img_url ); ?>" class="summary-icon" width="100" height="100">
                                                            <div class="summary-info">
                                                                <div class="summary-title"><?php echo esc_html( $model_name ); ?></div>
                                                                <div class="summary-sn">SN: <?php echo esc_html( $sn ); ?></div>
                                                                <div class="mini-status-badge" style="background:<?php echo $mini_badge_bg; ?>; color:<?php echo $mini_badge_col; ?>;">
                                                                    <?php echo $st_txt; ?>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- [DATA FIX] Full Child Detail (Identical to Single Product) -->
                                                    <div id="detail_<?php echo $pid; ?>" class="prod-detail-wrapper" style="display:none;">
                                                        
                                                        <?php 
                                                        $show_claim_ui = false;
                                                        if ( $chk_w === 'claim_process' || $chk_w === 'claim process' ) { $show_claim_ui = true; }

                                                        $tid = 0; $st_raw = 'pending';
                                                        if ( $show_claim_ui ) { 
                                                            $tks = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                                                            $tid = ( $tks ) ? $tks[0]->ID : 0;
                                                            $t_code = $tid ? get_post_meta($tid, 'ticket_code', true) : 'N/A';
                                                            $st_val_raw = $tid ? get_post_meta($tid, 'ticket_status', true) : 'pending';
                                                            $st_raw = trim( $st_val_raw );
                                                            
                                                            if( $tid > 0 ) :
                                                                $step1_active = ($st_raw=='pending'||$st_raw=='approved_send'||$st_raw=='shipping_in')?'active':'';
                                                                $step2_active = ($st_raw=='checking'||$st_raw=='fixing')?'active':'';
                                                                $step3_active = ($st_raw=='shipping_out'||$st_raw=='completed')?'active':'';
                                                        ?>
                                                            <div class="prod-card" style="margin-bottom:10px; border-bottom:3px solid #f97316;">
                                                                <div class="prod-status-bar st-orange">üîß ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Ticket #<?php echo $t_code; ?>)</div>
                                                                <div class="prod-body" style="padding:15px;">
                                                                    <div class="tl-wrap">
                                                                        <div class="tl-row">
                                                                            <div class="tl-line"></div>
                                                                            <div class="tl-item <?php echo $step1_active; ?>"><div class="tl-dot">1</div><span class="tl-txt">‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span></div>
                                                                            <div class="tl-item <?php echo $step2_active; ?>"><div class="tl-dot">2</div><span class="tl-txt">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£<br>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏ã‡πà‡∏≠‡∏°</span></div>
                                                                            <div class="tl-item <?php echo $step3_active; ?>"><div class="tl-dot">3</div><span class="tl-txt">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô<br>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span></div>
                                                                        </div>
                                                                    </div>
                                                                    <?php if($st_raw == 'pending' || $st_raw == 'approved_send'): ?>
                                                                        <div class="tl-tracking-box" id="form_track_<?php echo $tid; ?>">
                                                                            <div style="font-size:13px; font-weight:bold; margin-bottom:10px;">üìÆ ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≤</div>
                                                                            <select id="courier_<?php echo $tid; ?>" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;" onchange="toggleOther(<?php echo $tid; ?>)">
                                                                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á --</option>
                                                                                <?php foreach($thai_couriers as $k=>$v){ echo "<option value='$k'>$v</option>"; } ?>
                                                                                <option value="Other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                                                                            </select>
                                                                            <div id="div_other_courier_<?php echo $tid; ?>" style="display:none; margin-bottom:10px;">
                                                                                <input type="text" id="other_courier_<?php echo $tid; ?>" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                                                                            </div>
                                                                            <input type="text" id="tr_<?php echo $tid; ?>" placeholder="‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ (Tracking No.)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;">
                                                                            <button id="btn_save_<?php echo $tid; ?>" onclick="svTrack(<?php echo $tid; ?>)" style="background:#0f172a; color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
                                                                        </div>
                                                                    <?php elseif($st_raw == 'shipping_in'): $tr_in = get_post_meta($tid, 'tracking_inbound', true); ?>
                                                                        <div class="tl-tracking-box">
                                                                            <div>üì¶ ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</div>
                                                                            <div style="font-weight:bold; color:#2563eb; font-family:monospace; margin-top:5px;"><?php echo esc_html($tr_in); ?></div>
                                                                        </div>
                                                                    <?php endif; ?>
                                                                    
                                                                    <?php if($st_raw == 'shipping_out' || $st_raw == 'completed'): $tr_out = get_post_meta($tid, 'tracking_outbound', true); if($tr_out): ?>
                                                                        <div class="outbound-track-card">
                                                                            <div class="ot-header"><i class="fas fa-truck"></i> ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                                                                            <div class="ot-body">
                                                                                <div class="ot-info"><div class="ot-number"><?php echo esc_html($tr_out); ?></div></div>
                                                                            </div>
                                                                        </div>
                                                                        <?php if($st_raw == 'shipping_out'): ?>
                                                                            <button id="btn_conf_<?php echo $tid; ?>" class="btn-confirm-receipt" onclick="confirmReceipt(<?php echo $tid; ?>)">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô)</button>
                                                                            <div class="confirm-note">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                                                                        <?php endif; ?>
                                                                    <?php endif; endif; ?>
                                                                </div>
                                                            </div>
                                                        <?php endif; } // End Claim Logic ?>

                                                        <?php 
                                                        $expire_date      = get_post_meta($pid, 'warranty_expiry', true); 
                                                        $repair_repeater  = (function_exists('get_field')) ? get_field( 'repair_logs', $pid ) : '';
                                                        $cur_status       = ! empty( $chk_w ) ? $chk_w : 'original';
                                                        $show_status = isset( $status_display_map[$cur_status] ) ? $status_display_map[$cur_status] : $cur_status;
                                                        
                                                        $badge_html         = '<div class="w-red-bar">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>'; 
                                                        $show_date          = '-'; 
                                                        $usage_age_text     = '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 0 ‡∏ß‡∏±‡∏ô'; 
                                                        $status_care_text   = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
                                                        $status_bar_text    = '‚úÖ ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå'; 
                                                        $status_bar_class   = 'st-green';
                                                        
                                                        if ( $chk_w === 'warranty_pending' ) { $status_bar_text = '‚õî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'; $status_bar_class = 'st-red'; } 
                                                        elseif ( $chk_w === 'repaired' ) { $status_bar_text = '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; } 
                                                        elseif ( $chk_w === 'refurbished' ) { $status_bar_text = '‚úÖ ‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; } 
                                                        elseif ( $chk_w === 'modified' ) { $status_bar_text = '‚úÖ ‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏†‡∏≤‡∏û'; }
                                                        elseif ( $chk_w === 'stolen' ) { $status_bar_text = 'üö´ ‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'; $status_bar_class = 'st-dark'; }
                                                        elseif ( $chk_w === 'inactive' ) { $status_bar_text = '‚ö™ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ / ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'; $status_bar_class = 'st-gray'; }
                                                        
                                                        try {
                                                            $now = new DateTime(); $reg_date_val = get_post_meta($pid, 'warranty_register_date', true);
                                                            if ( $reg_date_val ) { $reg_dt = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $reg_dt ) { $usage_diff = $now->diff( $reg_dt ); $usage_age_text = $usage_diff->y . ' ‡∏õ‡∏µ ' . $usage_diff->m . ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ' . $usage_diff->d . ' ‡∏ß‡∏±‡∏ô'; } }
                                                            $dx = null;
                                                            if ( $expire_date ) { $dx = DateTime::createFromFormat( 'd/m/Y', $expire_date ); if ( ! $dx ) $dx = new DateTime( $expire_date ); } 
                                                            elseif ( $reg_date_val ) { $dur = (int) get_post_meta($pid, 'warranty_duration_years', true); if ( $dur > 0 ) { $dx = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $dx ) $dx->modify( "+$dur years" ); } }
                                                            
                                                            if ( $dx ) {
                                                                $dx->setTime( 23, 59, 59 ); $show_date = $dx->format( 'd/m/Y' ); 
                                                                if ( $now > $dx ) { $status_care_text = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $badge_html = '<div class="w-red-bar">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>'; $status_bar_text = '‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $status_bar_class = 'st-red'; } 
                                                                else { $status_care_text = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $badge_html = '<div class="w-green-bar">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' . ($now->diff($dx)->y > 0 ? $now->diff($dx)->y." ‡∏õ‡∏µ " : "") . ($now->diff($dx)->m > 0 ? $now->diff($dx)->m." ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô " : "") . $now->diff($dx)->d . ' ‡∏ß‡∏±‡∏ô</div>'; if($chk_w !== 'warranty_pending' && $status_bar_class !== 'st-red' && $chk_w !== 'stolen' && $chk_w !== 'inactive') $status_bar_class = 'st-green'; }
                                                            } else {
                                                                $status_care_text = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'; 
                                                                $badge_html = '<div class="w-green-bar">Active</div>';
                                                            }
                                                        } catch ( Exception $e ) {}
                                                        
                                                        if ( $chk_w === 'stolen' ) {
                                                            $status_care_text = '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏≤‡∏ß‡∏£';
                                                            $badge_html = '<div class="w-red-bar" style="background:#000;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>';
                                                            $status_bar_class = 'st-dark';
                                                            $status_bar_text = 'üö´ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                                                        }
                                                        ?>

                                                        <div class="prod-card">
                                                            <div class="prod-status-bar <?php echo $status_bar_class; ?>"><?php echo $status_bar_text; ?></div>
                                                            <div class="prod-img-area"><img src="<?php echo esc_url( $img_url ); ?>" alt="Product"></div>
                                                            <div class="prod-body">
                                                                <div class="prod-model">‡∏£‡∏∏‡πà‡∏ô: <?php echo esc_html( $model_name ); ?></div>
                                                                <div class="prod-sku">SKU: <?php echo esc_html( $sku ); ?></div>
                                                                <div class="barcode-section"><div class="barcode-font"><?php echo $sn; ?></div></div>
                                                                
                                                                <div class="warranty-new-ui">
                                                                    <div class="w-usage-section"><div class="w-usage-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="w-usage-val"><?php echo $usage_age_text; ?></div></div>
                                                                    <div class="w-detail-section">
                                                                        <div class="w-row"><span class="w-row-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ DINOCO Care:</span><span class="w-status-active"><?php echo $status_care_text; ?></span></div>
                                                                        <div class="w-row"><span class="w-row-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</span><span class="w-row-val"><?php echo $show_date; ?></span></div>
                                                                    </div>
                                                                    <?php echo $badge_html; ?>
                                                                </div>

                                                                <div class="status-row">
                                                                    <span class="st-label">üõ†Ô∏è ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                                                                    <span class="st-val"><?php echo esc_html( $show_status ); ?></span>
                                                                </div>
                                                                
                                                                <?php if ( $chk_w !== 'stolen' ) : ?>
                                                                    <button class="btn-stolen" onclick="reportStolen(<?php echo $pid; ?>)">üö® ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                                                                <?php endif; ?>

                                                                <?php if ( $repair_repeater ) : ?>
                                                                    <div class="repair-area">
                                                                        <div class="repair-head">üîß ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</div>
                                                                        <ul class="repair-list">
                                                                        <?php 
                                                                        $lines = preg_split( '/\r\n|\r|\n/', $repair_repeater ); 
                                                                        foreach ( $lines as $line ) { 
                                                                            if ( trim( $line ) === '' ) continue; 
                                                                            $parts = explode( ':', $line ); 
                                                                            if ( count( $parts ) >= 2 ) { 
                                                                                $r_desc = isset( $action_map[ trim( $parts[1] ) ] ) ? $action_map[ trim( $parts[1] ) ] : trim( $parts[1] ); 
                                                                                echo '<li class="repair-item"><div class="r-date">' . trim( $parts[0] ) . '</div><div class="r-action">' . $r_desc . '</div></li>'; 
                                                                            } 
                                                                        } 
                                                                        ?>
                                                                        </ul>
                                                                    </div>
                                                                <?php endif; ?>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endwhile; ?>
            <?php endif; wp_reset_postdata(); ?>
            
            <!-- SINGLE PRODUCT LOOP (FIXED STRUCTURE) -->
            <?php 
            while ( $my_singles->have_posts() ) : 
                $my_singles->the_post(); 
                $pid                  = get_the_ID();
                $sn                   = get_post_meta($pid, 'serial_code', true); 
                $sku                  = get_post_meta($pid, 'product_sku', true);
                $w_status_raw         = get_post_meta($pid, 'w_status', true);
                $w_status             = is_array( $w_status_raw ) ? ( isset( $w_status_raw['value'] ) ? $w_status_raw['value'] : ( isset( $w_status_raw[0] ) ? $w_status_raw[0] : '' ) ) : $w_status_raw; 
                $w_status             = trim( $w_status );
                
                $chk_w = strtolower( $w_status );

                $catalog_item         = isset( $product_catalog[ $sku ] ) ? $product_catalog[ $sku ] : null;
                $img_url              = ( $catalog_item && ! empty( $catalog_item['img'] ) ) ? $catalog_item['img'] : 'https://placehold.co/400x300?text=No+Image';
                
                $model_name = '';
                if ( $catalog_item && ! empty( $catalog_item['name'] ) ) { $model_name = $catalog_item['name']; } 
                else { 
                    $model_obj = (function_exists('get_field')) ? get_field( 'product_model', $pid ) : null; 
                    $model_name = is_object( $model_obj ) ? $model_obj->post_title : ( is_numeric( $model_obj ) ? get_the_title( $model_obj ) : ( $model_obj ?: "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)" ) ); 
                }

                $status_color_class = 'st-green'; 
                $st_txt = '‚úÖ ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'; 
                $mini_badge_bg = '#dcfce7'; 
                $mini_badge_col = '#166534';
                
                $is_expired_header = false;
                $header_expire_check = get_post_meta($pid, 'warranty_expiry', true);
                
                if ( ! $header_expire_check ) {
                    $reg_d = get_post_meta($pid, 'warranty_register_date', true);
                    $dur_y = (int) get_post_meta($pid, 'warranty_duration_years', true);
                    if ( $reg_d && $dur_y > 0 ) {
                        $tmp_date = DateTime::createFromFormat( 'd/m/Y', $reg_d );
                        if ( $tmp_date ) {
                            $tmp_date->modify( "+$dur_y years" );
                            $tmp_date->setTime( 23, 59, 59 );
                            if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                        }
                    }
                } else {
                    $tmp_date = DateTime::createFromFormat( 'd/m/Y', $header_expire_check );
                    if ( ! $tmp_date ) $tmp_date = new DateTime( $header_expire_check );
                    $tmp_date->setTime( 23, 59, 59 );
                    if ( new DateTime() > $tmp_date ) { $is_expired_header = true; }
                }

                if ( strpos( $chk_w, 'claim' ) !== false ) { 
                    $tks_header = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                    if ( $tks_header ) {
                        $cond_header_val = (function_exists('get_field')) ? get_field( 'claim_condition', $tks_header[0]->ID ) : '';
                        if ( is_array( $cond_header_val ) ) { $cond_header_val = isset( $cond_header_val['value'] ) ? $cond_header_val['value'] : $cond_header_val[0]; }
                        if ( trim( $cond_header_val ) === 'send_part' ) { $status_color_class = 'st-light-green'; $st_txt = 'üì¶ ‡∏£‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'; $mini_badge_bg = '#dcfce7'; $mini_badge_col = '#15803d'; } 
                        else { $status_color_class = 'st-orange'; $st_txt = 'üîß ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                    } else { $status_color_class = 'st-orange'; $st_txt = 'üîß ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; $mini_badge_bg = '#ffedd5'; $mini_badge_col = '#c2410c'; }
                } elseif ( $is_expired_header || strpos( $chk_w, 'expire' ) !== false ) { $status_color_class = 'st-red'; $st_txt = '‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; } 
                elseif ( $chk_w == 'warranty_pending' ) { $status_color_class = 'st-red'; $st_txt = '‚õî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; $mini_badge_bg = '#fee2e2'; $mini_badge_col = '#b91c1c'; }
                
                if ( $chk_w === 'inactive' ) {
                    $status_color_class = 'st-gray'; 
                    $st_txt = '‚ö™ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    $mini_badge_bg = '#f1f5f9'; 
                    $mini_badge_col = '#64748b';
                }

                if ( $chk_w === 'stolen' ) {
                    $status_color_class = 'st-dark';
                    $st_txt = 'üö´ ‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                    $mini_badge_bg = '#1f2937'; 
                    $mini_badge_col = '#ffffff';
                }
            ?>
                <!-- Wrapper Starts -->
                <div class="prod-item-wrapper" id="wrapper_<?php echo $pid; ?>">
                    
                    <!-- 1. Summary Card (Visible Always) -->
                    <div class="prod-summary-card" onclick="toggleSmartCard('<?php echo $pid; ?>')">
                        <div class="summary-status-header <?php echo $status_color_class; ?>"><?php echo $st_txt; ?></div>
                        <div class="summary-card-body">
                            <img src="<?php echo esc_url( $img_url ); ?>" class="summary-icon">
                            <div class="summary-info">
                                <div class="summary-title"><?php echo esc_html( $model_name ); ?></div>
                                <div class="summary-sn">SN: <?php echo esc_html( $sn ); ?></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Detail Wrapper (Hidden by default) -->
                    <!-- [SAFETY] Added inline style display:none -->
                    <div id="detail_<?php echo $pid; ?>" class="prod-detail-wrapper" style="display:none;">
                        
                        <!-- Claim UI Block -->
                        <?php 
                        $show_claim_ui = false;
                        if ( $chk_w === 'claim_process' || $chk_w === 'claim process' ) { $show_claim_ui = true; }
                        $tid = 0; $st_raw = 'pending';
                        if ( $show_claim_ui ) { 
                            $tks = get_posts([ 'post_type' => 'claim_ticket', 'meta_query' => [ 'relation' => 'OR', [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => '=' ], [ 'key' => 'ref_product_id', 'value' => '"' . $pid . '"', 'compare' => 'LIKE' ], [ 'key' => 'ref_product_id', 'value' => $pid, 'compare' => 'LIKE' ], [ 'key' => 'ref_product_serial', 'value' => $sn, 'compare' => '=' ] ], 'posts_per_page' => 1, 'orderby' => 'ID', 'order' => 'DESC', 'post_status' => ['publish', 'draft', 'pending', 'private', 'future'] ]);
                            $tid = ( $tks ) ? $tks[0]->ID : 0;
                            $t_code = $tid ? get_post_meta($tid, 'ticket_code', true) : 'N/A';
                            $st_val_raw = $tid ? get_post_meta($tid, 'ticket_status', true) : 'pending';
                            $st_raw = trim( $st_val_raw );
                            
                            if( $tid > 0 ) :
                                $step1_active = ($st_raw=='pending'||$st_raw=='approved_send'||$st_raw=='shipping_in')?'active':'';
                                $step2_active = ($st_raw=='checking'||$st_raw=='fixing')?'active':'';
                                $step3_active = ($st_raw=='shipping_out'||$st_raw=='completed')?'active':'';
                        ?>
                            <div class="prod-card" style="margin-bottom:10px; border-bottom:3px solid #f97316;">
                                <div class="prod-status-bar st-orange">üîß ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Ticket #<?php echo $t_code; ?>)</div>
                                <div class="prod-body" style="padding:15px;">
                                    <div class="tl-wrap">
                                        <div class="tl-row">
                                            <div class="tl-line"></div>
                                            <div class="tl-item <?php echo $step1_active; ?>"><div class="tl-dot">1</div><span class="tl-txt">‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span></div>
                                            <div class="tl-item <?php echo $step2_active; ?>"><div class="tl-dot">2</div><span class="tl-txt">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£<br>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏ã‡πà‡∏≠‡∏°</span></div>
                                            <div class="tl-item <?php echo $step3_active; ?>"><div class="tl-dot">3</div><span class="tl-txt">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô<br>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span></div>
                                        </div>
                                    </div>
                                    
                                    <?php if($st_raw == 'pending' || $st_raw == 'approved_send'): ?>
                                        <div class="tl-tracking-box" id="form_track_<?php echo $tid; ?>">
                                            <div style="font-size:13px; font-weight:bold; margin-bottom:10px;">üìÆ ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≤</div>
                                            <select id="courier_<?php echo $tid; ?>" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;" onchange="toggleOther(<?php echo $tid; ?>)">
                                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á --</option>
                                                <?php foreach($thai_couriers as $k=>$v){ echo "<option value='$k'>$v</option>"; } ?>
                                                <option value="Other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                                            </select>
                                            <div id="div_other_courier_<?php echo $tid; ?>" style="display:none; margin-bottom:10px;">
                                                <input type="text" id="other_courier_<?php echo $tid; ?>" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
                                            </div>
                                            <input type="text" id="tr_<?php echo $tid; ?>" placeholder="‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ (Tracking No.)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;">
                                            <button id="btn_save_<?php echo $tid; ?>" onclick="svTrack(<?php echo $tid; ?>)" style="background:#0f172a; color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
                                        </div>
                                    <?php elseif($st_raw == 'shipping_in'): $tr_in = get_post_meta($tid, 'tracking_inbound', true); ?>
                                        <div class="tl-tracking-box">
                                            <div>üì¶ ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</div>
                                            <div style="font-weight:bold; color:#2563eb; font-family:monospace; margin-top:5px;"><?php echo esc_html($tr_in); ?></div>
                                        </div>
                                    <?php endif; ?>
                                    
                                    <?php if($st_raw == 'shipping_out' || $st_raw == 'completed'): $tr_out = get_post_meta($tid, 'tracking_outbound', true); if($tr_out): ?>
                                        <div class="outbound-track-card">
                                            <div class="ot-header"><i class="fas fa-truck"></i> ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                                            <div class="ot-body">
                                                <div class="ot-info"><div class="ot-number"><?php echo esc_html($tr_out); ?></div></div>
                                            </div>
                                        </div>
                                        <?php if($st_raw == 'shipping_out'): ?>
                                            <button id="btn_conf_<?php echo $tid; ?>" class="btn-confirm-receipt" onclick="confirmReceipt(<?php echo $tid; ?>)">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô)</button>
                                            <div class="confirm-note">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                                        <?php endif; ?>
                                    <?php endif; endif; ?>
                                </div>
                            </div>
                        <?php endif; } // End Claim Logic ?>

                        <!-- Standard Product Detail Card -->
                        <!-- [FIX] This block is now safely INSIDE the hidden wrapper -->
                        <?php 
                        $chk_w = strtolower( $w_status );
                        $expire_date      = get_post_meta($pid, 'warranty_expiry', true); 
                        $repair_repeater  = (function_exists('get_field')) ? get_field( 'repair_logs', $pid ) : '';
                        $cur_status       = ! empty( $chk_w ) ? $chk_w : 'original';
                        $show_status = isset( $status_display_map[$cur_status] ) ? $status_display_map[$cur_status] : $cur_status;
                        
                        $badge_html         = '<div class="w-red-bar">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>'; 
                        $show_date          = '-'; 
                        $usage_age_text     = '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 0 ‡∏ß‡∏±‡∏ô'; 
                        $status_care_text   = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
                        $status_bar_text    = '‚úÖ ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå'; 
                        $status_bar_class   = 'st-green';
                        
                        if ( $chk_w === 'warranty_pending' ) { $status_bar_text = '‚õî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'; $status_bar_class = 'st-red'; } 
                        elseif ( $chk_w === 'repaired' ) { $status_bar_text = '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'; } 
                        elseif ( $chk_w === 'refurbished' ) { $status_bar_text = '‚úÖ ‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; } 
                        elseif ( $chk_w === 'modified' ) { $status_bar_text = '‚úÖ ‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏†‡∏≤‡∏û'; }
                        elseif ( $chk_w === 'stolen' ) { $status_bar_text = 'üö´ ‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'; $status_bar_class = 'st-dark'; }
                        elseif ( $chk_w === 'inactive' ) { $status_bar_text = '‚ö™ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ / ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'; $status_bar_class = 'st-gray'; }
                        
                        try {
                            $now = new DateTime(); $reg_date_val = get_post_meta($pid, 'warranty_register_date', true);
                            if ( $reg_date_val ) { $reg_dt = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $reg_dt ) { $usage_diff = $now->diff( $reg_dt ); $usage_age_text = $usage_diff->y . ' ‡∏õ‡∏µ ' . $usage_diff->m . ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ' . $usage_diff->d . ' ‡∏ß‡∏±‡∏ô'; } }
                            $dx = null;
                            if ( $expire_date ) { $dx = DateTime::createFromFormat( 'd/m/Y', $expire_date ); if ( ! $dx ) $dx = new DateTime( $expire_date ); } 
                            elseif ( $reg_date_val ) { $dur = (int) get_post_meta($pid, 'warranty_duration_years', true); if ( $dur > 0 ) { $dx = DateTime::createFromFormat( 'd/m/Y', $reg_date_val ); if ( $dx ) $dx->modify( "+$dur years" ); } }
                            
                            if ( $dx ) {
                                $dx->setTime( 23, 59, 59 ); $show_date = $dx->format( 'd/m/Y' ); 
                                if ( $now > $dx ) { $status_care_text = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $badge_html = '<div class="w-red-bar">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>'; $status_bar_text = '‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $status_bar_class = 'st-red'; } 
                                else { $status_care_text = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô'; $badge_html = '<div class="w-green-bar">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' . ($now->diff($dx)->y > 0 ? $now->diff($dx)->y." ‡∏õ‡∏µ " : "") . ($now->diff($dx)->m > 0 ? $now->diff($dx)->m." ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô " : "") . $now->diff($dx)->d . ' ‡∏ß‡∏±‡∏ô</div>'; if($chk_w !== 'warranty_pending' && $status_bar_class !== 'st-red' && $chk_w !== 'stolen' && $chk_w !== 'inactive') $status_bar_class = 'st-green'; }
                            } else {
                                $status_care_text = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'; 
                                $badge_html = '<div class="w-green-bar">Active</div>';
                            }
                        } catch ( Exception $e ) {}
                        
                        if ( $chk_w === 'stolen' ) {
                            $status_care_text = '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏≤‡∏ß‡∏£';
                            $badge_html = '<div class="w-red-bar" style="background:#000;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>';
                            $status_bar_class = 'st-dark';
                            $status_bar_text = 'üö´ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                        }
                        ?>

                        <div class="prod-card">
                            <div class="prod-status-bar <?php echo $status_bar_class; ?>"><?php echo $status_bar_text; ?></div>
                            <div class="prod-img-area"><img src="<?php echo esc_url( $img_url ); ?>" alt="Product"></div>
                            <div class="prod-body">
                                <div class="prod-model">‡∏£‡∏∏‡πà‡∏ô: <?php echo esc_html( $model_name ); ?></div>
                                <div class="prod-sku">SKU: <?php echo esc_html( $sku ); ?></div>
                                <div class="barcode-section"><div class="barcode-font"><?php echo $sn; ?></div></div>
                                
                                <div class="warranty-new-ui">
                                    <div class="w-usage-section"><div class="w-usage-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="w-usage-val"><?php echo $usage_age_text; ?></div></div>
                                    <div class="w-detail-section">
                                        <div class="w-row"><span class="w-row-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ DINOCO Care:</span><span class="w-status-active"><?php echo $status_care_text; ?></span></div>
                                        <div class="w-row"><span class="w-row-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</span><span class="w-row-val"><?php echo $show_date; ?></span></div>
                                    </div>
                                    <?php echo $badge_html; ?>
                                </div>

                                <div class="status-row">
                                    <span class="st-label">üõ†Ô∏è ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                                    <span class="st-val"><?php echo esc_html( $show_status ); ?></span>
                                </div>
                                
                                <?php if ( $chk_w !== 'stolen' ) : ?>
                                    <button class="btn-stolen" onclick="reportStolen(<?php echo $pid; ?>)">üö® ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                                <?php endif; ?>

                                <?php if ( $repair_repeater ) : ?>
                                    <div class="repair-area">
                                        <div class="repair-head">üîß ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</div>
                                        <ul class="repair-list">
                                        <?php 
                                        $lines = preg_split( '/\r\n|\r|\n/', $repair_repeater ); 
                                        foreach ( $lines as $line ) { 
                                            if ( trim( $line ) === '' ) continue; 
                                            $parts = explode( ':', $line ); 
                                            if ( count( $parts ) >= 2 ) { 
                                                $r_desc = isset( $action_map[ trim( $parts[1] ) ] ) ? $action_map[ trim( $parts[1] ) ] : trim( $parts[1] ); 
                                                echo '<li class="repair-item"><div class="r-date">' . trim( $parts[0] ) . '</div><div class="r-action">' . $r_desc . '</div></li>'; 
                                            } 
                                        } 
                                        ?>
                                        </ul>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>

                    </div> <!-- End prod-detail-wrapper -->
                    
                </div> <!-- End Wrapper -->
            <?php endwhile; ?>
            </div>
        
        <?php if ( !$my_bundles->have_posts() && !$my_singles->have_posts() ) : ?>
            <div style="text-align:center; padding:40px; border:2px dashed #ddd; color:#999; border-radius:10px;">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        <?php endif; wp_reset_postdata(); ?>

        <div style="text-align:center; margin-top:40px; padding-bottom: 80px;">
            <a href="<?php echo wp_logout_url( home_url() ); ?>" style="color:#999; text-decoration:none; font-weight:600; display:inline-block; border:1px solid #ddd; padding:10px 20px; border-radius:30px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </div> 

    <!-- JAVASCRIPT LOGIC (V16 - UX Overhaul) -->
    <script>
    var dinoco_nonce = '<?php echo wp_create_nonce('dinoco_nonce_action'); ?>';

    function getCacheBustedUrl() {
        var url = window.location.href.split('#')[0];
        var separator = url.indexOf('?') > -1 ? '&' : '?';
        return url + separator + 't=' + new Date().getTime();
    }

    // [FIXED V15.3] Smart Accordion Toggle Logic (Removed mode-list-view toggle)
    function toggleSmartCard(pid) {
        const wrapper = document.getElementById('wrapper_' + pid);
        const detail = document.getElementById('detail_' + pid);
        const isChild = wrapper.classList.contains('child-in-bundle');
        const isAlreadyActive = wrapper.classList.contains('active');

        if (!isChild) {
            // Case 1: Top-Level Card (Single or Bundle Parent)
            // Close ALL other top-level cards
            document.querySelectorAll('.prod-item-wrapper:not(.child-in-bundle).active').forEach(el => {
                if(el.id !== 'wrapper_' + pid) {
                    el.classList.remove('active', 'expanded');
                    const d = el.querySelector('.prod-detail-wrapper');
                    if(d) d.style.display = 'none';
                }
            });
        } else {
            // Case 2: Child inside Bundle - ACCORDION LOGIC
            // Only close other siblings in the same bundle. KEEP THE PARENT OPEN.
            const parentBundle = wrapper.closest('.prod-item-wrapper.is-bundle');
            if(parentBundle) {
                parentBundle.querySelectorAll('.child-in-bundle.active').forEach(child => {
                    if(child.id !== 'wrapper_' + pid) {
                        child.classList.remove('active', 'expanded');
                        const d = child.querySelector('.prod-detail-wrapper');
                        if(d) d.style.display = 'none';
                    }
                });
            }
        }

        // Toggle Current Card (Open/Close itself)
        if (isAlreadyActive) {
            wrapper.classList.remove('active', 'expanded');
            detail.style.display = 'none';
        } else {
            wrapper.classList.add('active', 'expanded');
            detail.style.display = 'block';
            
            setTimeout(() => { 
                wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            }, 100);
        }
    }
    
    function closeAllCards() {
        // [FIX V15.3] Removed 'mode-list-view' manipulation
        document.querySelectorAll('.prod-item-wrapper').forEach(el => { 
            el.classList.remove('active'); 
            el.classList.remove('expanded'); 
        });
        document.querySelectorAll('.prod-detail-wrapper').forEach(el => { 
            el.style.display = 'none'; 
        });
    }

    function toggleLoader(show) {
        const loader = document.getElementById('dinoco-loader');
        if (loader) {
            loader.style.display = show ? 'flex' : 'none';
        }
    }

    // --- Tracking Logic ---
    function toggleOther(tid) { 
        var val = document.getElementById('courier_'+tid).value; 
        var wrapper = document.getElementById('div_other_courier_'+tid); 
        var input = document.getElementById('other_courier_'+tid); 
        if(val === 'Other') { wrapper.style.display = 'block'; input.focus(); } 
        else { wrapper.style.display = 'none'; input.value = ''; } 
    }
    
    function showEditTrack(tid) { 
        document.getElementById('view_track_'+tid).style.display = 'none'; 
        document.getElementById('form_track_'+tid).style.display = 'block'; 
    }
    
    function cancelEditTrack(tid) { 
        document.getElementById('view_track_'+tid).style.display = 'block'; 
        document.getElementById('form_track_'+tid).style.display = 'none'; 
    }
    
    function svTrack(tid) { 
        var courier = document.getElementById('courier_'+tid).value; 
        var num = document.getElementById('tr_'+tid).value; 
        var btn = document.getElementById('btn_save_'+tid); 
        
        if(!courier) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á', 'warning');
            return;
        } 
        if(courier === 'Other') { 
            courier = document.getElementById('other_courier_'+tid).value; 
            if(!courier) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á', 'warning');
                return;
            }
        } 
        if(!num) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', 'warning');
            return;
        }
        
        var full_track = courier + ": " + num; 
        
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å?',
            html: `‡∏Ç‡∏ô‡∏™‡πà‡∏á: <b>${courier}</b><br>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <b>${num}</b>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                btn.disabled = true; 
                btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; 
                toggleLoader(true);
                
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'save_track'); // V10 Variable
                fd.append('ticket_id', tid); 
                fd.append('tracking', full_track); 
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method:'POST', body:fd })
                .then(r=>r.json())
                .then(d=>{ 
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => location.reload());
                    } 
                    else { 
                        var debugMsg = d.msg || d.message || (d.data && d.data.msg) || 'Unknown Error';
                        Swal.fire('Error', debugMsg, 'error');
                        btn.disabled = false; 
                        btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'; 
                    } 
                })
                .catch(e => { 
                    console.error(e); 
                    toggleLoader(false); 
                    Swal.fire('Error', 'Connection Error', 'error');
                    btn.disabled = false; 
                    btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'; 
                }); 
            }
        });
    }

    function confirmReceipt(tid) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏ö‡∏á‡∏≤‡∏ô)',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#1e293b'
        }).then((result) => {
            if (result.isConfirmed) {
                var btn = document.getElementById('btn_conf_' + tid);
                if(btn) btn.disabled = true;
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'confirm_receipt'); // V10 Variable
                fd.append('ticket_id', tid); 
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method:'POST', body:fd })
                .then(r=>r.json())
                .then(d=>{
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô Ticket ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success')
                        .then(() => location.reload());
                    } 
                    else { 
                        var debugMsg = d.msg || d.message || (d.data && d.data.msg) || 'Unknown Error';
                        Swal.fire('Error', debugMsg, 'error');
                        if(btn) btn.disabled = false; 
                    }
                })
                .catch(e=>{ 
                    toggleLoader(false); 
                    Swal.fire('Error', 'Connection Error', 'error');
                    if(btn) btn.disabled = false; 
                });
            }
        });
    }
    
    // Bundle JS Functions
    function createBundle(targetSku, childIds) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á?',
            text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏ß‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á (Merge)',
            confirmButtonColor: '#f97316',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'create_bundle'); // V10 Variable
                fd.append('target_sku', targetSku);
                childIds.forEach(id => fd.append('child_ids[]', id));
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable

                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(response => response.json()) 
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', (d.msg || 'Success'), 'success')
                        .then(() => location.reload());
                    } else { 
                        Swal.fire('Error', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error("Fetch Error:", e); 
                    Swal.fire('Error', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }

    function deleteBundle(bundleId) {
        Swal.fire({
            title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',
            text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡πÅ‡∏¢‡∏Å‡∏ä‡∏∏‡∏î (Unbundle)',
            confirmButtonColor: '#ef4444',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'delete_bundle'); // V10 Variable
                fd.append('bundle_id', bundleId);
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce); // V10 Variable
                
                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', (d.msg || 'Success'), 'success')
                        .then(() => location.reload());
                    } else { 
                        Swal.fire('Error', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error(e); 
                    Swal.fire('Error', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }

    // [NEW] Report Stolen JS (Refactored with SweetAlert2)
    function reportStolen(pid) {
        Swal.fire({
            title: 'üö® ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
            html: `
                <div style="text-align:left; font-size:14px; line-height:1.6;">
                    ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß:<br>
                    ‚Ä¢ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
                    ‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå"<br>
                    ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                toggleLoader(true);
                var fd = new FormData();
                fd.append('dinoco_request_v10', 'report_stolen'); // V10 Variable
                fd.append('product_id', pid);
                if(typeof dinoco_nonce !== 'undefined') fd.append('dinoco_auth_v10', dinoco_nonce);

                fetch(getCacheBustedUrl(), { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    toggleLoader(false);
                    if(d.success) { 
                        Swal.fire('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success')
                        .then(() => { location.reload(); });
                    } else { 
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', (d.msg || 'Unknown Error'), 'error');
                    }
                })
                .catch(e => { 
                    toggleLoader(false); 
                    console.error(e); 
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'Connection Error: ' + e.message, 'error');
                });
            }
        });
    }
    </script>
    <?php
    return ob_get_clean();
}
