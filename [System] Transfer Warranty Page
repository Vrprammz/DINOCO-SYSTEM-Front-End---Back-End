/* Snippet Name: DINOCO Transfer System V5.9.3 (Ultimate Layout Fix + Watermark Patch)
   Shortcode: [dinoco_transfer_sys] OR [dinoco_transfer_v3]
   Version: 5.9.3 (Fixed Icon Alignment & Step Timeline & Watermark Security)
   Author: Full Stack Expert
*/

// ======================================================================
// PART 1: BACKEND LOGIC (AJAX) - V3 NAMESPACE
// ======================================================================

add_action( 'wp_ajax_dinoco_v3_find', 'dinoco_v3_find_func' );
add_action( 'wp_ajax_nopriv_dinoco_v3_find', 'dinoco_v3_find_func' );

function dinoco_v3_find_func() {
    check_ajax_referer( 'dinoco_v3_nonce', 'security' );

    if ( ! is_user_logged_in() ) {
        wp_send_json_error( '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' );
    }

    $phone = isset($_POST['phone']) ? sanitize_text_field( $_POST['phone'] ) : '';
    $phone_clean = preg_replace('/[^0-9]/', '', $phone);

    if ( empty( $phone_clean ) ) {
        wp_send_json_error( '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' );
    }

    $users = get_users([
        'meta_key'      => 'phone_number',
        'meta_value'    => $phone_clean,
        'meta_compare'  => 'LIKE',
        'number'        => 1,
        'fields'        => 'all'
    ]);

    if ( ! empty( $users ) ) {
        $user = $users[0];
        $uid  = $user->ID;

        if ( $uid == get_current_user_id() ) {
            wp_send_json_error( '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ' );
        }

        $pic = get_user_meta( $uid, 'line_picture_url', true );
        if ( empty( $pic ) ) {
            $pic = get_avatar_url($uid);
        }

        $line_id = get_user_meta( $uid, 'owner_line_id', true );
        if ( empty( $line_id ) ) {
            $line_id = $user->user_login;
        }

        $phone_show = get_user_meta( $uid, 'phone_number', true );
        
        $first_name = get_user_meta( $uid, 'first_name', true );
        $last_name  = get_user_meta( $uid, 'last_name', true );
        $fullname   = trim( $first_name . ' ' . $last_name );
        
        if ( empty($fullname) ) {
            $fullname = $user->display_name;
        }

        wp_send_json_success([
            'pic'          => $pic,
            'line_id'      => $line_id,
            'wp_user_id'   => $uid, 
            'display_name' => $user->display_name,
            'full_name'    => $fullname,
            'phone'        => $phone_show
        ]);

    } else {
        wp_send_json_error( '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å DINOCO' );
    }

    wp_die();
}

add_action( 'wp_ajax_dinoco_v3_exec', 'dinoco_v3_exec_func' );
add_action( 'wp_ajax_nopriv_dinoco_v3_exec', 'dinoco_v3_exec_func' );

function dinoco_v3_exec_func() {
    set_time_limit(0);

    check_ajax_referer( 'dinoco_v3_nonce', 'security' );

    if ( ! is_user_logged_in() ) {
        wp_send_json_error( 'Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠' );
    }

    $pid            = isset($_POST['post_id']) ? intval( $_POST['post_id'] ) : 0;
    $target_line_id = isset($_POST['target_line_id']) ? sanitize_text_field( $_POST['target_line_id'] ) : '';
    $target_wp_uid  = isset( $_POST['target_wp_uid'] ) ? intval( $_POST['target_wp_uid'] ) : 0;

    if ( ! $pid || empty( $target_line_id ) ) {
        wp_send_json_error( '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' );
    }

    $post_type = get_post_type( $pid );
    $current_user = wp_get_current_user();

    $item_title = get_the_title($pid);
    $evidence_log = sprintf(
        "[%s] Consent Accepted | Item: %s (ID:%d) | To: %s (UID:%d) | By User ID: %d | IP: %s | Status: Irreversible Agreed",
        current_time('mysql'),
        $item_title,
        $pid,
        $target_line_id,
        $target_wp_uid,
        $current_user->ID,
        $_SERVER['REMOTE_ADDR']
    );
    add_user_meta( $current_user->ID, 'dinoco_transfer_consent_log', $evidence_log );

    if ( $post_type === 'product_bundle' ) {
        
        $children = get_field( 'bundle_children', $pid );
        if ( empty( $children ) ) {
            $children = get_post_meta( $pid, 'bundle_children', true );
        }

        if ( empty( $children ) || ! is_array( $children ) ) {
            wp_send_json_error( '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏∏‡∏î Bundle ‡∏ô‡∏µ‡πâ (System Error)' );
            wp_die();
        }

        foreach ( $children as $child ) {
            $cid = is_object( $child ) ? $child->ID : $child;
            
            $w_st = get_field( 'w_status', $cid );
            if ( is_array( $w_st ) ) $w_st = isset($w_st['value']) ? $w_st['value'] : '';

            if ( $w_st == 'claim_process' || $w_st == 'warranty_pending' || $w_st == 'stolen' ) {
                $sn = get_field( 'serial_code', $cid );
                $reason = ($w_st == 'stolen') ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                wp_send_json_error( "‡∏ï‡∏¥‡∏î‡∏•‡πá‡∏≠‡∏Ñ! ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î (S/N: $sn) $reason ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î‡πÑ‡∏î‡πâ" );
                wp_die();
            }
        }

        if ( $target_wp_uid > 0 ) {
            update_post_meta( $pid, 'bundle_owner', $target_wp_uid );
        }
        update_post_meta( $pid, 'bundle_owner_id', $target_line_id );

        foreach ( $children as $child ) {
            $cid = is_object( $child ) ? $child->ID : $child;

            update_field( 'owner_product', $target_line_id, $cid );

            $seq = (int) get_field( 'owner_sequence', $cid );
            update_field( 'owner_sequence', ( $seq < 1 ? 1 : $seq ) + 1, $cid );

            $log_entry = date( 'd/m/Y H:i' ) . " : Transfer (Bundle) by " . $current_user->display_name . " -> " . $target_line_id;
            $prev_logs = get_field( 'transfer_logs', $cid );
            update_field( 'transfer_logs', $prev_logs . "\n" . $log_entry, $cid );
        }

        wp_send_json_success( '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' );

    } else {
        $w_st = get_field( 'w_status', $pid );
        if ( is_array( $w_st ) ) {
            $w_st = isset($w_st['value']) ? $w_st['value'] : '';
        }
        
        if ( $w_st == 'claim_process' || $w_st == 'warranty_pending' || $w_st == 'stolen' ) {
             $reason = ($w_st == 'stolen') ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
             wp_send_json_error( "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å$reason" );
             wp_die();
        }

        update_field( 'owner_product', $target_line_id, $pid );
        
        $seq = (int) get_field( 'owner_sequence', $pid );
        update_field( 'owner_sequence', ( $seq < 1 ? 1 : $seq ) + 1, $pid );

        $log_entry = date( 'd/m/Y H:i' ) . " : Transfer by " . $current_user->display_name . " -> " . $target_line_id;
        $prev_logs = get_field( 'transfer_logs', $pid );
        
        update_field( 'transfer_logs', $prev_logs . "\n" . $log_entry, $pid );

        wp_send_json_success( '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' );
    }

    wp_die();
}

add_action( 'wp_ajax_dinoco_v3_proxy_image', 'dinoco_v3_proxy_image_func' );
add_action( 'wp_ajax_nopriv_dinoco_v3_proxy_image', 'dinoco_v3_proxy_image_func' );

function dinoco_v3_proxy_image_func() {
    $url = isset($_POST['img_url']) ? esc_url_raw($_POST['img_url']) : '';
    if (empty($url)) wp_send_json_error('No URL provided');

    $args = array(
        'timeout'     => 20,
        'sslverify'   => false,
        'redirection' => 5,
        'user-agent'  => 'WordPress/DinocoSystem'
    );

    $response = wp_remote_get($url, $args);
    
    if (is_wp_error($response)) {
        wp_send_json_error('Fetch failed: ' . $response->get_error_message());
    }

    $body = wp_remote_retrieve_body($response);
    $type = wp_remote_retrieve_header($response, 'content-type');
    
    if (empty($body)) wp_send_json_error('Empty body received');
    if(empty($type)) $type = 'image/jpeg';

    $base64 = 'data:' . $type . ';base64,' . base64_encode($body);
    wp_send_json_success($base64);
}

// ======================================================================
// PART 2: FRONTEND (DINOCO PASSPORT V5.9.3)
// ======================================================================
add_shortcode( 'dinoco_transfer_sys', 'dinoco_render_v3_frontend' );
add_shortcode( 'dinoco_transfer_v3', 'dinoco_render_v3_frontend' );

function dinoco_render_v3_frontend() {
    ob_start();

    if ( ! is_user_logged_in() ) {
        ?>
        <script type="text/javascript">
            window.location.href = '/warranty';
        </script>
        <?php
        return ob_get_clean();
    }

    // --- FULL LOGS MAPPING ---
    $action_map = [ 
        'fg_10'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 10%',
        'fg_l_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%',
        'fg_r_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%',
        'fg_20'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 20%',
        'fg_l_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%',
        'fg_r_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%',
        'fg_30'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 30%',
        'fg_l_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%',
        'fg_r_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%',
        'fg_40'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 40%',
        'fg_l_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%',
        'fg_r_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%',
        'fg_50'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) 50%',
        'fg_l_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%',
        'fg_r_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ö‡∏ô (Fairing Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%',
        'eg_10'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 10%',
        'eg_l_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%',
        'eg_r_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%',
        'eg_20'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 20%',
        'eg_l_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%',
        'eg_r_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%',
        'eg_30'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 30%',
        'eg_l_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%',
        'eg_r_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%',
        'eg_40'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 40%',
        'eg_l_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%',
        'eg_r_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%',
        'eg_50'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) 50%',
        'eg_l_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%',
        'eg_r_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á (Engine Guard) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%',
        'tr_10'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 10%',
        'tr_20'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 20%',
        'tr_30'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 30%',
        'tr_40'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 40%',
        'tr_50'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á (TopRack) 50%',
        'sr_10'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 10%',
        'sr_l_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 10%',
        'sr_r_10' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 10%',
        'sr_20'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 20%',
        'sr_l_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 20%',
        'sr_r_20' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 20%',
        'sr_30'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 30%',
        'sr_l_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 30%',
        'sr_r_30' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 30%',
        'sr_40'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 40%',
        'sr_l_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 40%',
        'sr_r_40' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 40%',
        'sr_50'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) 50%',
        'sr_l_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ 50%',
        'sr_r_50' => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á (SideRack) ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ 50%',
        'repaint_minor'  => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏°‡∏ó‡∏≥‡∏™‡∏µ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
        'align_minor'    => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏®‡∏≤‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
        'align_medium'   => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏®‡∏≤‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        'rep_plastic'    => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏ï‡∏¥‡∏Å',
        'rep_plastic_l'  => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢',
        'rep_plastic_r'  => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤',
        'rep_key'        => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏Å‡∏∏‡∏ç‡πÅ‡∏à',
        'rep_mount'      => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á(‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á)',
        'rep_tray'       => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á',
        'rep_seal'       => '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ã‡∏µ‡∏•‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö',
        'original'       => 'Original : ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
        'repaired'       => 'Repainted : ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏µ',
        'minor_fix'      => 'Minor Fix : ‡∏î‡∏±‡∏î‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏á',
        'welded'         => 'Welded : ‡∏ã‡πà‡∏≠‡∏°‡∏î‡∏±‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î',
        'modified'       => 'Modified : ‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á/‡∏ã‡πà‡∏≠‡∏°‡∏´‡∏ô‡∏±‡∏Å',
        'sticker_45l_1'  => '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 45L 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)',
        'sticker_38l_1'  => '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 38L 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)',
        'sticker_38l_2'  => '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á 38L 1 ‡∏ä‡∏∏‡∏î (4‡πÅ‡∏ú‡πà‡∏ô)',
        'sticker_hand'   => '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏Æ‡∏ô‡∏î‡πå 1 ‡∏ä‡∏∏‡∏î (2‡πÅ‡∏ú‡πà‡∏ô)',
        'plate_nx500'    => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ NX500 ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡πâ‡∏≤ 1 ‡∏ä‡∏¥‡πâ‡∏ô',
        'plate_dinoco_1' => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 1 ‡∏ä‡∏¥‡πâ‡∏ô',
        'plate_dinoco_2' => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 2 ‡∏ä‡∏¥‡πâ‡∏ô',
        'plate_dinoco_3' => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 3 ‡∏ä‡∏¥‡πâ‡∏ô',
        'plate_dinoco_4' => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 4 ‡∏ä‡∏¥‡πâ‡∏ô',
        'plate_dinoco_5' => '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ö DINOCO 5 ‡∏ä‡∏¥‡πâ‡∏ô'
    ];

    $current_user = wp_get_current_user();
    $uid          = $current_user->ID;
    
    $my_pic       = get_user_meta( $uid, 'line_picture_url', true );
    if ( empty( $my_pic ) ) $my_pic = get_avatar_url( $uid );
    
    $my_lid       = get_user_meta( $uid, 'owner_line_id', true );
    $my_phone     = get_user_meta( $uid, 'phone_number', true );
    $my_user      = $current_user->user_login;
    $my_display_name = $current_user->display_name;

    $product_catalog = get_option( 'dinoco_product_catalog', [] );
    if ( ! is_array( $product_catalog ) ) { $product_catalog = []; }

    // --- STATUS TEXT MAP (UPDATED V5.9.4) ---
    $status_map = [
        'warranty_available' => '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ',
        'warranty_pending'   => '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
        'old_warranty'       => '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ',
        'warranty_on'        => '‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
        'repaired'           => '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',
        'refurbished'        => '‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        'modified'           => '‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏†‡∏≤‡∏û',
        'claim_process'      => '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',
        'warranty_expiry'    => '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',
        'stolen'             => '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
        'void' => '‡∏ï‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Void)'
    ];

    // --- ICON MAP (UPDATED V5.9.4) ---
    $icon_map = [
        'warranty_available' => 'fa-clipboard-list',
        'warranty_pending'   => 'fa-magnifying-glass',
        'old_warranty'       => 'fa-box-archive',
        'warranty_on'        => 'fa-circle-check', 
        'repaired'           => 'fa-screwdriver-wrench', 
        'refurbished'        => 'fa-screwdriver-wrench',
        'modified'           => 'fa-hammer',
        'claim_process'      => 'fa-clock-rotate-left',
        'warranty_expiry'    => 'fa-circle-exclamation',
        'stolen'             => 'fa-ban'
    ];

    $all_assets = []; 

    // --- QUERY 1: BUNDLES ---
    $bundles_query = new WP_Query([
        'post_type'      => 'product_bundle',
        'posts_per_page' => -1,
        'meta_query'     => [
            [ 'key' => 'bundle_owner', 'value' => $uid, 'compare' => '=' ]
        ]
    ]);

    if ( $bundles_query->have_posts() ) {
        while ( $bundles_query->have_posts() ) {
            $bundles_query->the_post();
            $bid = get_the_ID();
            $b_sku = get_post_meta( $bid, 'bundle_sku', true );
            
            $cat_item = isset($product_catalog[$b_sku]) ? $product_catalog[$b_sku] : null;
            $b_name    = ( $cat_item && ! empty( $cat_item['name'] ) ) ? $cat_item['name'] : get_the_title();
            $b_img     = ( $cat_item && ! empty( $cat_item['img'] ) ) ? $cat_item['img'] : ''; 

            $children_raw = get_field( 'bundle_children', $bid );
            $children_data = [];
            $is_locked = false;
            $lock_reason = '';
            
            if ( $children_raw && is_array( $children_raw ) ) {
                foreach ( $children_raw as $c ) {
                    $cid = is_object($c) ? $c->ID : $c;
                    
                    $c_sn  = get_field( 'serial_code', $cid );
                    $c_sku = get_post_meta( $cid, 'product_sku', true );
                    $c_w   = get_field( 'w_status', $cid ); 
                    if(is_array($c_w)) $c_w = isset($c_w['value']) ? $c_w['value'] : '';
                    
                    $c_hand_seq = ( get_field( 'owner_sequence', $cid ) ?: 1 );

                    // Bundle Child Locking Logic
                    if ( $c_w == 'claim_process' || $c_w == 'warranty_pending' || $c_w == 'stolen' ) {
                        $is_locked = true;
                        if (strpos($lock_reason, '‡∏Ç‡πÇ‡∏°‡∏¢') === false) { // Keep highest priority
                             if ($c_w == 'stolen') {
                                 $lock_reason = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                             } else {
                                 $lock_reason = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°';
                             }
                        }
                    }

                    $c_cat = isset($product_catalog[$c_sku]) ? $product_catalog[$c_sku] : null;
                    $c_name = ( $c_cat && ! empty( $c_cat['name'] ) ) ? $c_cat['name'] : 'Item #' . $cid;
                    $c_img  = ( $c_cat && ! empty( $c_cat['img'] ) ) ? $c_cat['img'] : '';

                    // CHILD DATE CALC
                    $c_reg_date = get_post_meta( $cid, 'warranty_register_date', true ) ?: '-';
                    $c_exp_date = get_post_meta( $cid, 'warranty_expiry', true );
                    
                    if ( empty( $c_exp_date ) && $c_reg_date !== '-' ) {
                        $dur = (int) get_field( 'warranty_duration_years', $cid );
                        if ( $dur > 0 ) {
                            try {
                                $d = DateTime::createFromFormat( 'd/m/Y', $c_reg_date );
                                if ( $d ) {
                                    $d->modify( "+$dur years" );
                                    $c_exp_date = $d->format( 'd/m/Y' );
                                }
                            } catch ( Exception $e ) {}
                        }
                    }
                    $c_exp_date = $c_exp_date ?: '-';
                    
                    // STATUS TEXT & SEMANTIC COLOR FOR CHILD
                    $status_text = isset($status_map[$c_w]) ? $status_map[$c_w] : $c_w;
                    $status_bg = "bg-slate-500"; 
                    // DEFAULT ICON
                    $icon_class = isset($icon_map[$c_w]) ? $icon_map[$c_w] : 'fa-circle';
                    
                    if ($c_w == 'warranty_on' || $c_w == 'original') {
                        $status_bg = "bg-green-500"; 
                    } elseif ($c_w == 'claim_process' || $c_w == 'warranty_pending') {
                        $status_bg = "bg-amber-500 animate-pulse";
                    } elseif ($c_w == 'warranty_expiry') {
                        $status_bg = "bg-red-500"; 
                    } elseif ($c_w == 'stolen') {
                        $status_bg = "bg-red-700"; 
                    } 
                    
                    $status_icon = '<i class="fa-solid '.$icon_class.'"></i>';

                    // Logs (UPDATED: WITH ACTION MAPPING)
                    $c_logs_raw = get_field( 'repair_logs', $cid );
                    $c_logs = [];
                    if(!empty($c_logs_raw) && is_string($c_logs_raw)){
                        $lines = preg_split('/\r\n|\r|\n/', $c_logs_raw);
                        foreach($lines as $line){
                            $parts = explode(":", $line);
                            if(count($parts) >= 2) {
                                $date_part = trim($parts[0]);
                                $raw_detail = trim($parts[1]);
                                $final_detail = isset($action_map[$raw_detail]) ? $action_map[$raw_detail] : $raw_detail;
                                $c_logs[] = ['date' => $date_part, 'detail' => $final_detail];
                            }
                        }
                    }

                    $children_data[] = [
                        'id'   => $cid, 'name' => $c_name, 'sn'    => $c_sn, 'img'   => $c_img,
                        'sku' => $c_sku ? $c_sku : 'N/A', // Add SKU
                        'status_val' => $c_w, 
                        'status_text' => $status_text,
                        'status_bg' => $status_bg,
                        'status_icon' => $status_icon,
                        'hand_seq' => $c_hand_seq,
                        'reg_date' => $c_reg_date, 'exp_date' => $c_exp_date, 'logs' => $c_logs
                    ];
                }
            }

            // BUNDLE STATUS FOR CARD
            $b_status_text = "‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Bundle)"; 
            $b_status_bg = "bg-indigo-600";
            $b_status_icon = '<i class="fa-solid fa-cubes"></i>';

            if($is_locked) {
                if (strpos($lock_reason, '‡∏Ç‡πÇ‡∏°‡∏¢') !== false || strpos($lock_reason, '‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢') !== false) {
                      $b_status_text = "‚ö†Ô∏è ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Suspended)";
                      $b_status_bg = "bg-red-700";
                      $b_status_icon = '<i class="fa-solid fa-ban"></i>';
                } else {
                      $b_status_text = "‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö";
                      $b_status_bg = "bg-amber-500 animate-pulse";
                      $b_status_icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                }
            }

            $all_assets[] = [
                'type' => 'bundle', 'id'    => $bid, 'name' => $b_name, 'sn'    => 'BUNDLE SET',
                'sku' => $b_sku ? $b_sku : 'BUNDLE', // Add SKU
                'img'  => $b_img, 'is_locked' => $is_locked, 'lock_reason' => $lock_reason,
                'children' => $children_data, 
                'status_label' => 'üì¶ ‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Bundle Set)',
                'status_text' => $b_status_text, 
                'status_bg' => $b_status_bg,
                'status_icon' => $b_status_icon,
                'count_display' => count($children_data) . ' ‡∏ä‡∏¥‡πâ‡∏ô', 
                'count_color' => '#4f46e5',
                'reg_date' => null, 
                'exp_date' => null
            ];
        }
        wp_reset_postdata();
    }

    // --- QUERY 2: SINGLES ---
    $singles_query = new WP_Query([
        'post_type'      => 'serial_number',
        'posts_per_page' => -1,
        'meta_query'     => [
            'relation' => 'AND',
            [ 
                'relation' => 'OR',
                [ 'key' => 'owner_product', 'value' => $my_lid, 'compare' => '=' ],
                [ 'key' => 'owner_product', 'value' => $my_user, 'compare' => '=' ],
                [ 'key' => 'owner_product', 'value' => $uid, 'compare' => '=' ]
            ],
            [
                'relation' => 'OR',
                [ 'key' => 'current_bundle_id', 'compare' => 'NOT EXISTS' ],
                [ 'key' => 'current_bundle_id', 'value' => '', 'compare' => '=' ]
            ]
        ]
    ]);

    if ( $singles_query->have_posts() ) {
        while ( $singles_query->have_posts() ) {
            $singles_query->the_post();
            $id = get_the_ID();
            $sn = get_field( 'serial_code', $id ) ?: '-';
            $sku = get_post_meta( $id, 'product_sku', true );
            $cat_item = isset($product_catalog[$sku]) ? $product_catalog[$sku] : null;
            $img_url  = ( $cat_item && ! empty( $cat_item['img'] ) ) ? $cat_item['img'] : '';
            
            $model_name = ( $cat_item && ! empty( $cat_item['name'] ) ) ? $cat_item['name'] : get_the_title();
            $hand_seq = ( get_field( 'owner_sequence', $id ) ?: 1 );
            $w_st = get_field( 'w_status', $id ); 
            if ( is_array( $w_st ) ) $w_st = isset($w_st['value']) ? $w_st['value'] : '';

            // Updated Locking Logic
            $is_locked = ($w_st == 'claim_process' || $w_st == 'warranty_pending' || $w_st == 'stolen');
            if ($is_locked) {
                if ($w_st == 'stolen') {
                    $lock_reason = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢/‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                } else {
                    $lock_reason = '‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                }
            } else {
                $lock_reason = '';
            }

            // Logs (UPDATED: WITH ACTION MAPPING)
            $raw_logs = get_field( 'repair_logs', $id );
            $logs_data = [];
            if ( ! empty( $raw_logs ) && is_string($raw_logs) ) {
                $lines = preg_split( '/\r\n|\r|\n/', $raw_logs );
                foreach ( $lines as $line ) {
                    $parts = explode( ":", $line );
                    if ( count( $parts ) >= 2 ) {
                        $date_part = trim($parts[0]);
                        $raw_detail = trim($parts[1]);
                        $final_detail = isset($action_map[$raw_detail]) ? $action_map[$raw_detail] : $raw_detail;
                        $logs_data[] = ['date' => $date_part, 'detail' => $final_detail];
                    }
                }
            }
            
            // DATE CALC
            $reg_date_s = get_post_meta( $id, 'warranty_register_date', true ) ?: '-';
            $exp_date_s = get_post_meta( $id, 'warranty_expiry', true );

            if ( empty( $exp_date_s ) && $reg_date_s !== '-' ) {
                $dur = (int) get_field( 'warranty_duration_years', $id );
                if ( $dur > 0 ) {
                    try {
                        $d = DateTime::createFromFormat( 'd/m/Y', $reg_date_s );
                        if ( $d ) {
                            $d->modify( "+$dur years" );
                            $exp_date_s = $d->format( 'd/m/Y' );
                        }
                    } catch ( Exception $e ) {}
                }
            }
            $exp_date_s = $exp_date_s ?: '-';
            
            // STATUS MAP & COLOR CLASS
            $status_text = isset($status_map[$w_st]) ? $status_map[$w_st] : $w_st;
            $status_bg = "bg-slate-500";
            
            $icon_class = isset($icon_map[$w_st]) ? $icon_map[$w_st] : 'fa-circle';

            if ($w_st == 'warranty_on' || $w_st == 'original') {
                $status_bg = "bg-green-500";
            } elseif ($w_st == 'claim_process' || $w_st == 'warranty_pending') {
                $status_bg = "bg-amber-500 animate-pulse";
            } elseif ($w_st == 'warranty_expiry') {
                $status_bg = "bg-red-500";
            } elseif ($w_st == 'stolen') {
                $status_bg = "bg-red-700";
            } 
            
            $status_icon = '<i class="fa-solid '.$icon_class.'"></i>';

            $all_assets[] = [
                'type' => 'single', 'id'    => $id, 'name' => $model_name, 'sn'    => $sn,
                'sku' => $sku ? $sku : 'N/A', // Add SKU
                'img'  => $img_url, 'is_locked' => $is_locked, 'lock_reason' => $lock_reason,
                'status_val' => $w_st, 
                'status_label' => $status_text, 
                'status_text' => $status_text,
                'status_bg' => $status_bg,
                'status_icon' => $status_icon,
                'hand_seq' => $hand_seq,
                'count_display' => $status_text,
                'count_color' => '#10b981', 'logs' => $logs_data,
                'reg_date' => $reg_date_s, 'exp_date' => $exp_date_s
            ];
        }
        wp_reset_postdata();
    }

    $ajax_nonce = wp_create_nonce( 'dinoco_v3_nonce' );
    ?>

    <!-- EXTERNAL LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Font imports: consolidated + certificate fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&family=Chakra+Petch:ital,wght@0,400;0,600;0,700;1,700&family=Sarabun:wght@300;400;500;700&family=Courier+Prime:wght@400;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const DINOCO_CONFIG_V3 = {
            nonce: "<?php echo $ajax_nonce; ?>",
            owner: {
                name: "<?php echo esc_js($my_display_name); ?>",
                pic: "<?php echo esc_url($my_pic); ?>",
                phone: "<?php echo esc_js($my_phone); ?>"
            }
        };
    </script>

    <style>
        /* ============================================
           CSS CUSTOM PROPERTIES (Design Tokens)
           ============================================ */
        :root {
            --dnc-primary: #06C755;
            --dnc-primary-hover: #05a748;
            --dnc-primary-light: #f0fdf4;
            --dnc-dark: #0f172a;
            --dnc-text: #1e293b;
            --dnc-text-secondary: #64748b;
            --dnc-border: #e2e8f0;
            --dnc-bg: #f8fafc;
            --dnc-font: 'Noto Sans Thai', 'Prompt', sans-serif;
            --dnc-radius-sm: 8px;
            --dnc-radius-md: 12px;
            --dnc-radius-lg: 16px;
            --dnc-radius-xl: 20px;
            --dnc-shadow-subtle: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --dnc-shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --dnc-shadow-lg: 0 10px 25px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
            --dnc-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* CORE VARIABLES & APP STYLES */
        #dinoco-root-v3 { font-family: var(--dnc-font); color: var(--dnc-text); max-width: 900px; margin: 0 auto; padding-bottom: 100px; }
        .d-transition { transition: var(--dnc-transition); }
        
        /* HEADER (Shield & Circle Fix) */
        .member-header-v2 {
            background: linear-gradient(135deg, #1e293b 0%, var(--dnc-dark) 100%);
            border-radius: var(--dnc-radius-lg); padding: 22px 24px; color: white; display: flex; align-items: center; gap: 18px;
            margin-bottom: 24px; box-shadow: var(--dnc-shadow-lg), 0 0 0 1px rgba(255,255,255,0.06); position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .member-header-v2::before {
            content: '\f3ed'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; right: -20px; top: 50%; transform: translateY(-50%);
            font-size: 140px; color: rgba(255,255,255,0.04); pointer-events: none;
        }
        .member-avatar-v2 {
            width: 60px; height: 60px; border-radius: 50% !important; object-fit: cover; border: 2.5px solid #fbbf24;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25); flex-shrink: 0;
        }
        
        /* ITEM CARD */
        .item-card { 
            background: white; border-radius: 12px; padding-bottom: 12px; border: 1px solid #e2e8f0; 
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .item-card:hover { transform: translateY(-3px); border-color: #94a3b8; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
        .item-card img { width: 100%; height: auto; max-height: 120px; object-fit: contain; margin-bottom: 8px; margin-top: 10px; transition: transform 0.3s; }
        .item-card:hover img { transform: scale(1.05); }

        /* ITEM CARD STRIP */
        .item-card-strip { 
            width: 100%; padding: 8px 8px; color: white; font-size: 10px; font-weight: bold; 
            display: flex; flex-direction: row; align-items: center; justify-content: center;
            gap: 4px; line-height: 1.3; min-height: 48px; 
        }
        .item-card-strip i { flex-shrink: 0; margin: 0; font-size: 1.1em; }
        .item-card-strip span {
            text-align: left; display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden; word-break: break-word; 
        }

        /* PASSPORT DETAIL */
        .passport-hero { 
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; 
            border-radius: 16px 16px 0 0; position: relative; overflow: hidden; 
        }
        
        /* EXPANDABLE CHILD CARD */
        .child-item-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.3s;
        }
        .child-item-header-strip { padding: 6px 16px; color: white; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .child-head { padding: 12px 14px; display: flex; align-items: flex-start; gap: 12px; cursor: pointer; }
        .child-body { display: none; padding: 14px; background: #f8fafc; border-top: 1px dashed #e2e8f0; }

        /* TIMELINE CSS */
        .tl-container { position: relative; padding-left: 20px; margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
        .tl-line { position: absolute; left: 6px; top: 20px; bottom: 20px; width: 2px; background: #e2e8f0; border-left: 2px dashed #cbd5e1; background: none; }
        .tl-item { position: relative; margin-bottom: 24px; }
        .tl-item:last-child { margin-bottom: 0; }
        .tl-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: white; border: 3px solid #6366f1; z-index: 10; box-shadow: 0 0 0 2px white; } 
        .tl-date { font-size: 11px; font-weight: 700; color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 8px; font-family: monospace; border: 1px solid #e2e8f0; }
        
        .tl-log-group { padding-left: 4px; }
        .tl-log-row {
            background-color: white; border: 1px solid #e2e8f0; border-left: 3px solid #6366f1;
            border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 12px;
            color: #334155; line-height: 1.5; display: flex; gap: 8px; align-items: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .tl-log-row:last-child { margin-bottom: 0; }
        .tl-icon-col { flex-shrink: 0; color: #6366f1; margin-top: 2px; }
        .tl-text-col { flex: 1; word-break: break-word; }

        /* BUTTONS & INPUTS */
        .btn-check { 
            background: #0f172a; color: white; border-radius: 12px; padding: 0 20px; font-weight: 500; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 6px; flex-shrink: 0; height: 44px; 
        }
        .input-check { 
            height: 44px; border: 1px solid #cbd5e1 !important; border-radius: 12px !important; padding: 0 12px; width: 100%; outline: none; 
            transition: all 0.2s; font-size: 16px; border-width: 1px !important; font-family: 'Prompt', sans-serif !important;
        }
        .input-check:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .btn-sales-gen { 
            background: #039230; color: white; border-radius: 30px; font-size: 11px; padding: 6px 14px; 
            box-shadow: 0 2px 5px rgba(3, 146, 48, 0.3); border: none; cursor: pointer; display: flex; align-items: center; gap: 5px; 
        }
        
        .img-placeholder { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 8px; color: #94a3b8; font-size: 24px; }
        
        .dinoco-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(5px); }
        /* Modal Scroll Fix */
        .modal-content { 
            background: white; width: 95%; max-width: 480px; border-radius: 16px; padding: 24px; 
            position: relative; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4); 
            max-height: 90vh; overflow-y: auto; /* Enable scroll inside modal */
            display: flex; flex-direction: column; 
        }
        
        /* Modal Close Button */
        .btn-close-modal {
            background-color: #f1f5f9; color: #475569; font-size: 12px; font-weight: bold;
            padding: 10px 0; border-radius: 8px; width: 100%; margin-top: 5px;
            border: 1px solid #e2e8f0; transition: all 0.2s; cursor: pointer; text-align: center;
        }
        .btn-close-modal:hover { background-color: #e2e8f0; color: #1e293b; }

        .disclaimer-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;
            font-size: 12px; color: #475569; height: 180px; overflow-y: auto; text-align: left;
            margin-bottom: 16px; line-height: 1.5;
        }
        .disclaimer-box strong { color: #1e293b; display: block; margin-bottom: 4px; margin-top: 8px; }
        .disclaimer-box p { margin-bottom: 8px; }
        
        .chk-group { 
            display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; 
            text-align: left; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s; 
        }
        .chk-group:hover { background: #f1f5f9; }
        .chk-group input[type="checkbox"] { 
            appearance: none; -webkit-appearance: none; width: 24px; height: 24px; 
            border: 2px solid #cbd5e1; border-radius: 50%; margin-top: 2px; flex-shrink: 0; background-color: white;
            transition: all 0.2s; position: relative;
        }
        .chk-group input[type="checkbox"]:checked { border-color: #2563eb; background-color: #2563eb; }
        .chk-group input[type="checkbox"]:checked::after {
            content: ''; position: absolute; left: 8px; top: 4px; width: 6px; height: 12px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }
        .chk-label { font-size: 13px; color: #334155; line-height: 1.6; user-select: none; }
        .chk-label strong { color: #1e293b; font-weight: 600; }
        
        /* ================================================================
           CERTIFICATE STYLES (STRICT FROM MOCKUP & FIXES)
           ================================================================ */
        /* Hidden Container */
        .cert-hidden-container {
            position: fixed; left: -9999px; top: 0;
            width: 800px; /* Fixed standard width */
        }

        .cert-wrapper {
            width: 800px;
            min-height: 1200px;
            background: #fff; /* Ensure white BG */
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
        }
        .cert-wrapper.bundle-mode {
            min-height: 1400px;
            height: auto;
            padding-bottom: 40px;
        }

        .bg-texture {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(#00AA5B 1px, transparent 1px),
                radial-gradient(#00AA5B 1px, transparent 1px);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
            opacity: 0.05; z-index: 0; pointer-events: none;
        }

        /* WATERMARK FIX - FULL PAGE BOMBING (ABSOLUTE Z-INDEX 999) */
        /* Logic: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î (Top Layer) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏ß */
        .antifake-overlay {
            position: absolute;
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö: ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤ container 2 ‡πÄ‡∏ó‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            
            /* Image Source */
            background-image: url('https://dinoco.in.th/wp-content/uploads/2026/02/logofullboom.webp');
            background-size: 80px; 
            background-repeat: repeat;
            
            /* Geometry */
            transform: rotate(-30deg); 
            transform-origin: center; /* ‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            
            /* VISIBILITY LOGIC (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) */
            z-index: 999; 
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏à‡∏≤‡∏Å 0.12 ‡πÄ‡∏õ‡πá‡∏ô 0.20 ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß */
            opacity: 0.20; 
            
            /* COLOR CORRECTION */
            /* ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥ (Black) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß */
            filter: grayscale(100%) invert(1); 
            
            /* BLEND MODE */
            /* multiply: ‡∏™‡∏µ‡∏î‡∏≥‡∏à‡∏∞‡πÑ‡∏õ‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏ô‡∏Ç‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
            mix-blend-mode: multiply;
            
            pointer-events: none; 
        }

        .watermark-big {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-family: 'Chakra Petch', sans-serif; font-size: 80px; font-weight: 900;
            color: rgba(0,0,0,0.04); white-space: nowrap; z-index: 0; pointer-events: none;
        }

        /* HEADER SPACING FIX - EQUAL GAP 15px */
        .header-green-zone {
            background-color: #00AA5B; 
            padding: 30px 20px 80px 20px; /* Reduced top padding to move text up */
            text-align: center; color: #fff; 
            position: relative; 
            z-index: 1; /* ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 999 ‡∏Ç‡∏≠‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ */
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 10px);
            /* New Layout Logic - Equal Spacing via Gap */
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; 
        }
        .head-subtitle, .head-desc { margin: 0; line-height: 1; }
        .head-logo { margin: 0; line-height: 0; }
        
        .head-subtitle {
            font-size: 16px; letter-spacing: 2px; opacity: 0.9; text-transform: uppercase;
        }
        .head-logo img {
            height: 120px; width: auto; /* Updated to 140px */
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2)); display: block;
        }
        .head-desc {
            font-size: 24px; font-weight: 300;
        }

        /* OWNER CARD */
        .owner-card-wrapper {
            margin-top: -80px; padding: 0 40px; 
            position: relative; 
            z-index: 10; /* Higher than background but lower than watermark */
            display: flex; justify-content: center;
        }
        .owner-card {
            background: #fff; width: 100%; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); border: 3px solid #000; padding: 8px;
        }
        .owner-card-inner {
            border: 1px solid #ccc; width: 100%; border-radius: 10px;
            display: flex; padding: 20px; align-items: center; gap: 20px; box-sizing: border-box;
        }
        .owner-img-box { position: relative; flex-shrink: 0; }
        
        /* FIX: Profile Pic Roundness via Container & Img */
        .owner-img-box-inner {
            width: 120px; height: 120px; border-radius: 50%; 
            border: 4px solid #f0f0f0; overflow: hidden; 
            background: #fff; position: relative;
        }
        .owner-avatar {
            width: 100%; height: 100%; object-fit: cover;
        }
        /* FIX: Checkmark Centering & Position */
        .owner-verified-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: #00AA5B; color: #fff; width: 30px; height: 30px;
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; /* Flex Center */
            font-size: 16px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            line-height: 0; /* Reset line-height to strict center */
            padding: 0;
            z-index: 5;
        }

        .owner-details { flex: 1; text-align: left; position: relative; z-index: 10; }
        .owner-label { color: #888; font-size: 14px; margin-bottom: 2px; }
        .owner-name { font-size: 28px; font-weight: bold; color: #000; line-height: 1.2; }
        .owner-tel { font-family: 'Chakra Petch', sans-serif; font-size: 20px; color: #555; margin-top: 5px; }

        .owner-qr-box {
            text-align: center; border-left: 2px dashed #ddd; padding-left: 20px; flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .qr-img { width: 90px; height: 90px; }

        .content-body { padding: 40px 50px; position: relative; z-index: 10; flex: 1; }

        /* SINGLE PRODUCT STYLES */
        .product-row {
            display: flex; gap: 30px; margin-bottom: 30px;
            border-bottom: 2px solid #eee; padding-bottom: 30px; align-items: flex-start;
            position: relative; z-index: 10;
        }
        .product-img-container { width: 35%; }
        /* FIX: Product Image Rounded */
        .product-img-wrapper {
            width: 100%; border-radius: 10px; overflow: hidden; /* Clip image */
            border: 1px solid #ddd; box-shadow: 3px 3px 10px rgba(0,0,0,0.05);
        }
        .product-img { width: 100%; display: block; }
        
        .product-info-container { width: 65%; }
        .section-head {
            font-size: 18px; color: #00AA5B; font-weight: bold;
            margin-bottom: 10px; text-transform: uppercase;
        }
        .mother-section .section-head, .child-section .section-head {
            margin-bottom: 15px; border-left: 5px solid #00AA5B; padding-left: 10px;
        }

        .product-title {
            font-size: 26px; font-weight: bold; line-height: 1.3; margin-bottom: 8px; color: #222;
        }
        /* FIX: Center SKU Vertically - Flex Logic */
        .product-sku {
            font-family: 'Courier Prime', monospace; font-size: 16px; color: #555;
            background: #f0f0f0; 
            display: inline-flex; align-items: center; justify-content: center; /* Flex Center */
            width: fit-content;
            padding: 4px 12px; border-radius: 6px;
            margin-bottom: 20px; 
            min-height: 32px;
            line-height: 1;
        }

        .specs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .spec-item {
            border-bottom: 1px dashed #ccc; padding-bottom: 5px;
            display: flex; justify-content: space-between; align-items: baseline; flex-wrap: nowrap; 
        }
        .spec-label { font-size: 14px; color: #777; font-weight: 500; white-space: nowrap; margin-right: 10px; }
        .spec-val { font-size: 16px; font-weight: bold; color: #000; text-align: right; white-space: normal; word-break: break-word; }
        .spec-val.mono { font-family: 'Courier Prime', monospace; letter-spacing: -0.5px; font-size: 14px; white-space: nowrap; }

        .barcode-area {
            margin-top: 25px; text-align: center; opacity: 0.9;
            overflow: hidden; min-height: 50px; 
            display: flex; justify-content: center; align-items: center;
        }
        /* FIX: Increased Barcode Size */
        .barcode-font {
            font-family: 'Libre Barcode 39 Text', cursive;
            font-size: 55px; /* Increased from 40px */
            line-height: 1; white-space: nowrap; 
        }

        .status-dashboard { display: flex; gap: 20px; margin-bottom: 30px; position: relative; z-index: 10; }
        .age-card {
            flex: 1; background: #f2fff6; border: 2px solid #00AA5B; border-radius: 12px;
            padding: 20px; text-align: center;
        }
        .age-label { font-size: 14px; color: #555; margin-bottom: 5px;}
        .age-value { 
            font-size: 32px; font-weight: bold; color: #00AA5B; font-family: 'Chakra Petch', sans-serif; 
            line-height: 1.2; margin-bottom: 5px;
        }
        .age-sub { font-size: 12px; color: #888; }

        .status-card {
            flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 12px;
            padding: 20px; 
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            text-align: center;
        }
        /* FIX: Status Badge - Auto Height & Vertical Center */
        .status-badge {
            background: #00AA5B; color: #fff; font-size: 18px; font-weight: bold;
            padding: 10px 25px; border-radius: 25px; margin-bottom: 5px;
            box-shadow: 0 4px 10px rgba(0,170,91,0.25);
            display: flex; align-items: center; justify-content: center; /* Flex Center */
            min-height: 45px; height: auto; 
            text-align: center;
            max-width: 90%;
            flex-wrap: wrap;
            line-height: 1.2;
        }

        /* BUNDLE STYLES */
        .mother-section { border-bottom: 4px double #eee; padding-bottom: 30px; margin-bottom: 30px; position: relative; z-index: 10; }
        .mother-layout { display: flex; gap: 30px; align-items: center; }
        .mother-img {
            width: 40%; border-radius: 10px; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .mother-info { width: 60%; }
        /* FIX: Set Badge Vertical Center */
        .set-badge {
            background: #333; color: #fff; padding: 0 10px; border-radius: 4px;
            font-size: 12px; font-weight: bold; 
            display: inline-flex; align-items: center; justify-content: center; /* Flex Center */
            margin-bottom: 10px; height: 26px; width: fit-content; line-height: 1;
        }
        .mother-title {
            font-size: 32px; font-weight: bold; line-height: 1.2; margin-bottom: 10px; color: #222;
        }
        /* FIX: Mother SKU Vertical Center */
        .mother-sku {
            font-family: 'Courier Prime', monospace; font-size: 18px; color: #555;
            background: #f4f4f4; padding: 0 15px; border-radius: 5px; 
            display: inline-flex; align-items: center; justify-content: center; /* Flex Center */
            height: 36px; width: fit-content; line-height: 1;
        }

        .child-section { margin-bottom: 40px; position: relative; z-index: 10; }
        .child-list { display: flex; flex-direction: column; gap: 20px; }
        .child-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px;
            display: flex; gap: 20px; position: relative; transition: transform 0.2s;
        }
        .child-card:hover { border-color: #00AA5B; box-shadow: 0 5px 15px rgba(0,170,91,0.1); }
        .child-img-box { width: 120px; flex-shrink: 0; }
        .child-img {
            width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;
        }
        .child-info { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .child-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .child-name {
            font-size: 18px; font-weight: bold; color: #000; line-height: 1.2; margin-bottom: 2px;
        }
        .child-sku { font-size: 12px; color: #888; font-family: 'Courier Prime', monospace; }
        .child-barcode-mini {
            font-family: 'Libre Barcode 39 Text', cursive; font-size: 24px; color: #333; line-height: 1;
        }
        .child-stats {
            display: flex; gap: 15px; background: #f9f9f9; padding: 10px 12px; border-radius: 6px;
        }
        .stat-box { flex: 1; border-right: 1px solid #ddd; padding-right: 10px; }
        .stat-box:last-child { border-right: none; }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .stat-val { font-size: 14px; font-weight: bold; color: #333; }
        .stat-val.mono { font-family: 'Courier Prime', monospace; font-size: 13px; }
        .stat-val.active { color: #00AA5B; }
        .stat-val.expired { color: #cc0000; }

        .child-history {
            margin-top: 5px; border: 1px dashed #ffa500; background: #fffdf5; padding: 8px;
            border-radius: 6px; font-size: 12px;
        }
        .history-head {
            font-weight: bold; color: #d68900; margin-bottom: 4px; display: flex; align-items: center; gap: 5px;
        }
        .history-item {
            display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 2px 0;
        }
        .history-item:last-child { border-bottom: none; }
        .h-date { color: #555; font-family: 'Chakra Petch'; }
        .h-desc { color: #333; flex: 1; margin-left: 10px; }

        /* LOGS & FOOTER */
        .log-section { border-top: 1px solid #ddd; padding-top: 20px; position: relative; z-index: 10; }
        .log-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .log-title { font-size: 18px; font-weight: bold; color: #333; }

        table.log-table { width: 100%; border-collapse: collapse; }
        table.log-table th {
            text-align: left; color: #888; font-size: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;
        }
        table.log-table td { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        .log-date { font-weight: bold; color: #00AA5B; width: 15%; font-family: 'Chakra Petch', sans-serif; }
        .log-desc { width: 65%; color: #444; }
        .log-by { width: 20%; text-align: right; color: #999; font-size: 12px; }

        .footer-stamp {
            margin-top: 30px; display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 20px;
        }
        .stamp-img {
            width: 80px; height: 80px; border: 3px solid #cc0000; border-radius: 50%;
            color: #cc0000; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; transform: rotate(-15deg); opacity: 0.8; text-align: center; line-height: 1.2;
        }
    </style>

    <!-- HTML STRUCTURE -->
    <div id="dinoco-root-v3">
        
        <!-- HEADER (Shield & Circle Fix) -->
        <div class="member-header-v2">
            <img src="<?php echo esc_url($my_pic); ?>" class="member-avatar-v2">
            <div class="relative z-10">
                <div class="text-[10px] text-yellow-400 font-bold uppercase tracking-wider mb-0.5">DINOCO Digital Asset</div>
                <h1 class="text-lg md:text-xl font-bold leading-tight"><?php echo esc_html($my_display_name); ?></h1>
                <div class="inline-flex items-center gap-1 bg-yellow-500/20 text-yellow-400 text-[10px] px-2 py-0.5 rounded border border-yellow-500/30 mt-1.5">
                    <i class="fa-solid fa-circle-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </div>

        <!-- VIEW 1: ASSET LIST -->
        <div id="view-assets" class="d-transition">
            <h2 class="text-base font-bold mb-4 flex items-center gap-2 text-slate-700">
                <span class="bg-slate-800 w-1 h-5 rounded-full block"></span>
                ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (My Assets)
            </h2>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <?php if ( ! empty( $all_assets ) ): ?>
                    <?php foreach ( $all_assets as $item ): 
                        $json_attr = htmlspecialchars( json_encode( $item ), ENT_QUOTES, 'UTF-8' );
                        $locked_cls = $item['is_locked'] ? 'opacity-80 bg-red-50 border-red-200' : '';
                        $card_status = $item['status_text'];
                        
                        // Smart Placeholder
                        $img_html = '';
                        if (!empty($item['img'])) {
                            $img_html = '<img src="' . esc_url($item['img']) . '">';
                        } else {
                            $icon_class = 'fa-box'; 
                            if ($item['type'] === 'bundle') $icon_class = 'fa-cubes';
                            $img_html = '<div class="img-placeholder"><i class="fa-solid ' . $icon_class . '"></i></div>';
                        }
                    ?>
                        <div class="item-card d-transition <?php echo $locked_cls; ?>" onclick="DINOCO_APP_V3.openPassport(this)" data-json="<?php echo $json_attr; ?>">
                            
                            <!-- FULL WIDTH STRIP (Fixed Alignment) -->
                            <div class="item-card-strip <?php echo $item['status_bg']; ?>">
                                <?php echo $item['status_icon']; ?> <span><?php echo $card_status; ?></span>
                            </div>

                            <?php echo $img_html; ?>
                            
                            <div class="text-xs font-bold text-slate-800 line-clamp-2 h-8 mb-1 px-1"><?php echo esc_html($item['name']); ?></div>
                            
                            <!-- HIDE SN FOR BUNDLE -->
                            <?php if($item['type'] !== 'bundle'): ?>
                                <div class="bg-slate-100 text-slate-500 text-[9px] px-1.5 py-0.5 rounded font-mono mb-1">S/N: <?php echo esc_html($item['sn']); ?></div>
                            <?php endif; ?>
                            
                            <?php if($item['is_locked']): ?>
                                <div class="absolute top-8 left-2 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-lock text-[9px]"></i></div>
                            <?php endif; ?>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <div class="col-span-full py-10 text-center border-2 border-dashed border-slate-300 rounded-xl">
                        <i class="fa-solid fa-box-open text-3xl text-slate-300 mb-2"></i>
                        <p class="text-slate-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <!-- VIEW 2: PASSPORT & TRANSFER -->
        <div id="view-passport" class="hidden d-transition">
            <!-- BACK BUTTON -->
            <button onclick="DINOCO_APP_V3.goBack()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-100 border border-slate-200 rounded-full text-slate-600 text-sm font-semibold hover:bg-slate-200 hover:text-slate-900 transition-all mb-5 shadow-sm">
                <i class="fa-solid fa-chevron-left text-xs"></i>
                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</span>
            </button>

            <!-- Passport Card -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mb-6">
                <div class="passport-hero">
                    <div class="relative z-10 flex flex-col p-5">
                        <div class="flex justify-between items-start mb-2">
                            <div class="opacity-70 text-[9px] tracking-widest uppercase">DINOCO PASSPORT</div>
                            <div id="p-sn" class="font-mono text-indigo-200 text-[10px] bg-white/10 px-2 py-0.5 rounded">S/N: ...</div>
                        </div>
                        
                        <h2 id="p-model" class="text-lg md:text-xl font-bold leading-snug text-white mb-1">Product Name</h2>
                    </div>
                    
                    <!-- STATUS BAR -->
                    <div id="p-status-bar" class="w-full py-1.5 px-5 flex items-center gap-2 text-white text-[11px] font-bold">
                        <span id="p-status-text">Active</span>
                    </div>
                </div>
                
                <div class="p-5 md:flex gap-6">
                    <div class="w-full md:w-1/3 flex justify-center items-center bg-white rounded-xl border border-slate-100 mb-5 md:mb-0 shadow-sm p-4" id="p-img-container">
                        <img id="p-img" src="" class="w-full h-auto object-contain">
                    </div>

                    <div class="w-full md:w-2/3">
                        <div id="date-row-box" class="grid grid-cols-2 gap-3 mb-5">
                            <div class="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm">
                                <div class="text-[10px] text-slate-400 font-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
                                <div id="p-reg-date" class="font-bold text-slate-800 text-sm">-</div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm">
                                <div class="text-[10px] text-slate-400 font-bold mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>
                                <div id="p-exp-date" class="font-bold text-slate-800 text-sm">-</div>
                            </div>
                        </div>
                        
                        <div id="bundle-info-text" class="hidden mb-5 p-3 bg-indigo-50 border border-indigo-100 rounded-lg text-center">
                            <p class="text-indigo-800 font-bold text-xs">üì¶ ‡∏ä‡∏∏‡∏î‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Bundle Set)</p>
                            <p class="text-[10px] text-indigo-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>

                        <div class="border-t border-slate-100 pt-3">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xs font-bold text-slate-600 uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
                                <button id="btn-sales-main" onclick="DINOCO_APP_V3.generateSalesCard(null)" class="btn-sales-gen">
                                    <i class="fa-solid fa-camera"></i> ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠
                                </button>
                            </div>
                            <div id="p-dynamic-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transfer Section -->
            <div id="transfer-panel" class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm">
                <h3 class="text-base font-bold text-slate-800 mb-1">‡πÇ‡∏≠‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Transfer Ownership)</h3>
                <p class="text-xs text-slate-500 mb-4">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•</p>
                
                <div id="transfer-lock-msg" class="hidden bg-red-50 text-red-700 p-3 rounded-lg border border-red-200 mb-4 text-xs flex gap-2 items-start">
                    <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                    <div>
                        <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ:</strong> <span id="lock-reason-txt">...</span>
                    </div>
                </div>

                <div id="transfer-form-area">
                    <div class="flex flex-col md:flex-col gap-2.5 mb-3">
                        <input type="tel" id="t-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà" class="input-check text-center" maxlength="12">
                        
                        <!-- UPDATED WARNING UI (BLUE INFO BOX) -->
                        <div class="bg-blue-50 text-blue-700 text-xs px-3 py-2 rounded-lg flex items-center gap-2 justify-center mb-1 border border-blue-100">
                            <i class="fa-solid fa-circle-info"></i>
                            <span>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å DINOCO ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                        </div>

                        <button onclick="DINOCO_APP_V3.findUser(this)" class="btn-check w-full rounded-xl text-sm">
                            <i class="fa-solid fa-magnifying-glass"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå
                        </button>
                    </div>

                    <!-- PRE-CONFIRM BOX -->
                    <div id="t-result-box" class="hidden bg-green-50 border border-green-200 rounded-xl p-4 animate-fade-in">
                        <div class="flex flex-col items-center text-center gap-2 mb-3">
                             <!-- UPDATED: Full Circle Image Wrapper (Fix Overflow) -->
                             <div class="w-20 h-20 rounded-full border-4 border-green-400 shadow-md overflow-hidden mx-auto mb-2 relative bg-white">
                                <img id="t-pic" src="" class="absolute inset-0 w-full h-full object-cover">
                             </div>
                            <div>
                                <div class="text-[10px] text-green-700 font-bold uppercase tracking-wider mb-1">‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å DINOCO</div>
                                <div id="t-name" class="font-bold text-slate-800 text-sm leading-tight">Name</div>
                                <div id="t-lid" class="text-[10px] text-slate-500 mt-0.5 font-mono">Line: ...</div>
                            </div>
                        </div>
                        <button onclick="DINOCO_APP_V3.confirmTransfer()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2.5 rounded-xl shadow transition-colors text-sm">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- UPDATED CONFIRMATION MODAL -->
    <div id="modal-confirm-transfer" class="dinoco-modal">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <div class="flex items-center gap-2 text-red-600 font-bold">
                    <i class="fa-solid fa-triangle-exclamation"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                </div>
                <!-- RED CANCEL BUTTON -->
                <button onclick="document.getElementById('modal-confirm-transfer').style.display='none'" class="bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold px-3 py-1.5 rounded-full transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>

            <!-- PRODUCT SUMMARY & RECEIVER CARD (NEW DESIGN) -->
            <div class="text-left mb-4">
                <div class="flex gap-3 items-start bg-white p-3 rounded-xl border border-slate-200 shadow-sm mb-3">
                    <div class="w-14 h-14 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-center shrink-0 overflow-hidden">
                        <img id="confirm-product-img" src="" class="w-full h-full object-contain">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[10px] text-slate-400 font-bold uppercase mb-0.5">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô</div>
                        <div class="font-bold text-slate-800 text-xs leading-tight line-clamp-2" id="confirm-product-name">Product Name</div>
                    </div>
                </div>

                <!-- RECEIVER INFO CARD -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-blue-100 rounded-full -mr-8 -mt-8 opacity-50"></div>
                    
                    <div class="relative z-10">
                        <span class="inline-block bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-md mb-2 shadow-sm">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á (Transferring To)
                        </span>
                        <div class="font-bold text-slate-900 text-base" id="confirm-receiver-name">Receiver Name</div>
                        <div class="text-sm text-slate-600 font-mono mt-0.5 flex items-center gap-1.5">
                            <i class="fa-solid fa-phone"></i>
                            <span id="confirm-receiver-phone">08x-xxx-xxxx</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DISCLAIMER BOX -->
            <div class="disclaimer-box custom-scrollbar">
                <strong>1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Platform Role)</strong>
                <p>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Serial Number) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏à‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏•‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î</p>
                <strong>2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</strong>
                <p>‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏•‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏Å‡∏•‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï ‡∏Å‡∏≤‡∏£‡∏â‡πâ‡∏≠‡πÇ‡∏Å‡∏á (Scam) ‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏õ‡∏Å ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏ï‡∏≤‡∏°</p>
                <strong>3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</strong>
                <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SN) ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (Irreversible) ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á</p>
                <div class="text-red-600 bg-red-50 p-2 rounded mt-2 border border-red-100">
                    <strong>‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏° (Prohibitions):</strong> ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢, ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö, ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏≠‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏±‡πà‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á
                </div>
            </div>

            <!-- CHECKBOXES (CIRCULAR STYLE + PURE CSS CHECK) -->
            <div class="mb-5">
                <label class="chk-group">
                    <input type="checkbox" id="chk-sn" onchange="DINOCO_APP_V3.checkConsent()">
                    <span class="chk-label">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SN)</strong> ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                </label>
                <label class="chk-group">
                    <input type="checkbox" id="chk-role" onchange="DINOCO_APP_V3.checkConsent()">
                    <span class="chk-label">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø <strong>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</strong> ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                </label>
                <label class="chk-group">
                    <input type="checkbox" id="chk-irrev" onchange="DINOCO_APP_V3.checkConsent()">
                    <span class="chk-label">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (Irreversible)</strong></span>
                </label>
            </div>

            <button id="btn-final-confirm" onclick="DINOCO_APP_V3.finalConfirm()" disabled class="w-full py-3 rounded-xl bg-slate-300 text-white font-bold text-sm shadow-none cursor-not-allowed transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-shield-halved"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ)
            </button>
        </div>
    </div>

    <!-- SALES CARD CANVAS NODE SINGLE -->
    <div id="sc-canvas-single" class="cert-hidden-container">
        <div class="cert-wrapper">
            <div class="bg-texture"></div>
            <div class="antifake-overlay"></div>
            <div class="watermark-big">DNC DIGITAL ASSET</div>

            <!-- HEADER -->
            <div class="header-green-zone">
                <div class="head-logo">
                    <img src="https://dinoco.in.th/wp-content/uploads/2026/02/sys4.webp" alt="DINOCO LOGO">
                </div>
            </div>

            <!-- OWNER CARD -->
            <div class="owner-card-wrapper">
                <div class="owner-card">
                    <div class="owner-card-inner">
                        <div class="owner-img-box">
                            <div class="owner-img-box-inner">
                                <img id="sc-s-owner-pic" src="" class="owner-avatar" crossorigin="anonymous">
                            </div>
                            <div class="owner-verified-badge">‚úì</div>
                        </div>
                        <div class="owner-details">
                            <div class="owner-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Owner)</div>
                            <div id="sc-s-owner-name" class="owner-name">...</div>
                            <div id="sc-s-owner-tel" class="owner-tel">...</div>
                        </div>
                        <div class="owner-qr-box">
                            <img id="sc-s-qr" src="" class="qr-img">
                        </div>
                    </div>
                </div>
            </div>

            <!-- BODY CONTENT -->
            <div class="content-body">
                <!-- Product Section -->
                <div class="product-row">
                    <div class="product-img-container">
                        <div class="product-img-wrapper">
                            <img id="sc-s-prod-img" src="" class="product-img" crossorigin="anonymous">
                        </div>
                    </div>
                    <div class="product-info-container">
                        <div class="section-head">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
                        <div id="sc-s-prod-name" class="product-title">...</div>
                        <div id="sc-s-prod-sku" class="product-sku">SKU: ...</div>

                        <div class="specs-grid">
                            <div class="spec-item">
                                <span class="spec-label">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà (Owner No.)</span>
                                <span id="sc-s-hand" class="spec-val">1</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">Serial No.</span>
                                <span id="sc-s-sn" class="spec-val mono">...</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
                                <span id="sc-s-reg" class="spec-val">...</span>
                            </div>
                        </div>

                        <div class="barcode-area">
                            <div id="sc-s-barcode" class="barcode-font">...</div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="status-dashboard">
                    <div class="age-card">
                        <div class="age-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
                        <div id="sc-s-age" class="age-value">...</div>
                        <div id="sc-s-exp" class="age-sub">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: ...</div>
                    </div>
                    <div class="status-card">
                        <div class="age-label" style="margin-bottom:10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á</div>
                        <div id="sc-s-status" class="status-badge">...</div>
                        <div class="age-sub">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ó‡πâ</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="log-section">
                    <div class="log-header">
                        <div class="log-title">üîß ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                        <div style="font-size:14px; color:#888;">(Latest Maintenance Record)</div>
                    </div>
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                                <th style="text-align:right;">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            </tr>
                        </thead>
                        <tbody id="sc-s-logs-body">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>

                    <div class="footer-stamp">
                        <div style="text-align:left; color:#888; font-size:12px;">
                            <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Issue Date):</div>
                            <div id="sc-s-issue-date" style="font-family:'Chakra Petch', sans-serif; font-size:16px; color:#333; font-weight:bold; margin-top:2px;">...</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div style="text-align:right;">
                                <div style="font-weight:bold; font-size:16px;">DINOCO SYSTEM</div>
                                <div style="font-size:12px; color:#888;">Certified Digital Document</div>
                            </div>
                            <div class="stamp-img">OFFICIAL<br>VERIFIED</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SALES CARD CANVAS NODE BUNDLE -->
    <div id="sc-canvas-bundle" class="cert-hidden-container">
        <div class="cert-wrapper bundle-mode">
            <div class="bg-texture"></div>
            <div class="antifake-overlay"></div>
            <div class="watermark-big">DNC SET PRODUCT</div>

            <!-- HEADER -->
            <div class="header-green-zone">
                <div class="head-logo">
                    <img src="https://dinoco.in.th/wp-content/uploads/2026/02/sys3.webp" alt="DINOCO LOGO">
                </div>
            </div>

            <!-- OWNER CARD -->
            <div class="owner-card-wrapper">
                <div class="owner-card">
                    <div class="owner-card-inner">
                        <div class="owner-img-box">
                            <div class="owner-img-box-inner">
                                <img id="sc-b-owner-pic" src="" class="owner-avatar" crossorigin="anonymous">
                            </div>
                            <div class="owner-verified-badge">‚úì</div>
                        </div>
                        <div class="owner-details">
                            <div class="owner-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Owner)</div>
                            <div id="sc-b-owner-name" class="owner-name">...</div>
                            <div id="sc-b-owner-tel" class="owner-tel">...</div>
                        </div>
                        <div class="owner-qr-box">
                            <img id="sc-b-qr" src="" class="qr-img">
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-body">
                <!-- 1. MOTHER PRODUCT -->
                <div class="mother-section">
                    <div class="section-head">‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registered Product Set)</div>
                    <div class="mother-layout">
                        <div class="mother-info">
                            <div class="set-badge">FULL SET BUNDLE</div>
                            <div id="sc-b-title" class="mother-title">...</div>
                            <div id="sc-b-sku" class="mother-sku">...</div>
                        </div>
                        <div style="width: 40%; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            <img id="sc-b-img" src="" style="width: 100%; display: block;" crossorigin="anonymous">
                        </div>
                    </div>
                </div>

                <!-- 2. CHILD PRODUCTS -->
                <div class="child-section">
                    <div class="section-head">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏∏‡∏î (Items in Set)</div>
                    <div id="sc-b-child-list" class="child-list">
                        <!-- Items injected via JS -->
                    </div>
                </div>

                <!-- LOGS & FOOTER -->
                <div class="log-section">
                    <div class="log-header">
                        <div class="log-title">üîß ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (System Overview Log)</div>
                    </div>
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                                <th style="text-align:right;">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="log-date" id="sc-b-log-date">...</td>
                                <td class="log-desc">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î (System Registered)</td>
                                <td class="log-by">SYSTEM</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="footer-stamp">
                        <div style="text-align:left; color:#888; font-size:12px;">
                            <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Issue Date):</div>
                            <div id="sc-b-issue-date" style="font-family:'Chakra Petch', sans-serif; font-size:16px; color:#333; font-weight:bold; margin-top:2px;">...</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div style="text-align:right;">
                                <div style="font-weight:bold; font-size:16px;">DINOCO SYSTEM</div>
                                <div style="font-size:12px; color:#888;">Certified Digital Document</div>
                            </div>
                            <div class="stamp-img">OFFICIAL<br>VERIFIED</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: SALES CARD PREVIEW -->
    <div id="modal-sales" class="dinoco-modal">
        <div class="modal-content text-center">
            <h3 class="text-lg font-bold mb-1">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠ (Digital Record)</h3>
            <p class="text-xs text-slate-500 mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</p>
            
            <div id="modal-sales-loader" class="py-8 text-[#00AA5B]">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                <div class="mt-2 text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</div>
            </div>
            
            <div id="modal-sales-img-wrap" class="hidden mb-3 rounded-lg overflow-hidden shadow border border-slate-200"></div>

            <button id="btn-download-sc" class="w-full bg-slate-800 text-white font-bold py-2.5 rounded-lg mb-2 hidden text-sm">
                <i class="fa-solid fa-download mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            <button onclick="document.getElementById('modal-sales').style.display='none'" class="btn-close-modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script>
    const DINOCO_APP_V3 = {
        data: null,
        targetUser: null,

        toggleChild: function(el) {
            let row = el.closest('.child-item-card');
            let body = row.querySelector('.child-body');
            let icon = el.querySelector('i.fa-chevron-down');
            
            if(body.style.display === 'block') {
                body.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            } else {
                body.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            }
        },

        generateTimeline: function(logs) {
            if(!logs || logs.length === 0) return '';
            let groups = {};
            logs.forEach(l => {
                if(!groups[l.date]) groups[l.date] = [];
                groups[l.date].push(l.detail);
            });
            let html = '<div class="tl-container"><div class="tl-line"></div>';
            for(let date in groups) {
                html += `<div class="tl-item">
                    <div class="tl-dot"></div>
                    <div class="tl-date">${date}</div>
                    <div class="tl-log-group">`;
                groups[date].forEach(d => {
                    html += `
                    <div class="tl-log-row">
                        <div class="tl-icon-col"><i class="fa-solid fa-check-circle text-[10px]"></i></div>
                        <div class="tl-text-col">${d}</div>
                    </div>`;
                });
                html += `</div></div>`;
            }
            html += '</div>';
            return html;
        },

        openPassport: function(el) {
            let raw = el.getAttribute('data-json');
            this.data = JSON.parse(raw);
            let d = this.data;

            document.querySelector('#p-model').innerText = d.name;
            document.querySelector('#p-sn').innerText = 'S/N: ' + d.sn;
            
            let imgContainer = document.querySelector('#p-img-container');
            if (d.img) {
                imgContainer.innerHTML = `<img id="p-img" src="${d.img}" class="w-full h-auto object-contain">`;
            } else {
                let iconClass = 'fa-box';
                if (d.type === 'bundle') iconClass = 'fa-cubes';
                imgContainer.innerHTML = `<div class="img-placeholder"><i class="fa-solid ${iconClass}"></i></div>`;
            }

            let statusBar = document.querySelector('#p-status-bar');
            let statusText = document.querySelector('#p-status-text');
            statusBar.className = `w-full py-2 px-5 flex items-center gap-2 text-white text-[12px] font-bold ${d.status_bg}`;
            statusText.innerHTML = `${d.status_icon} ${d.status_text}`;

            function checkExpiryColor(dateStr) {
                if(!dateStr || dateStr === '-') return 'text-slate-800';
                let parts = dateStr.split('/');
                if(parts.length === 3) {
                    let exp = new Date(parts[2], parts[1]-1, parts[0]);
                    let now = new Date();
                    if(exp < now) return 'text-red-600 font-bold';
                    return 'text-green-600 font-bold';
                }
                return 'text-slate-800';
            }

            if (d.type === 'bundle') {
                document.querySelector('#date-row-box').classList.add('hidden');
                document.querySelector('#bundle-info-text').classList.remove('hidden');
                document.querySelector('#p-sn').style.display = 'none';
            } else {
                document.querySelector('#date-row-box').classList.remove('hidden');
                document.querySelector('#bundle-info-text').classList.add('hidden');
                document.querySelector('#p-sn').style.display = 'block';
                document.querySelector('#p-reg-date').innerText = d.reg_date || '-';
                let expEl = document.querySelector('#p-exp-date');
                expEl.innerText = d.exp_date || '-';
                expEl.className = `text-sm ${checkExpiryColor(d.exp_date)}`;
            }

            if(d.is_locked) {
                document.querySelector('#transfer-form-area').classList.add('hidden');
                document.querySelector('#transfer-lock-msg').classList.remove('hidden');
                document.querySelector('#lock-reason-txt').innerText = d.lock_reason;
            } else {
                document.querySelector('#transfer-form-area').classList.remove('hidden');
                document.querySelector('#transfer-lock-msg').classList.add('hidden');
            }

            let container = document.querySelector('#p-dynamic-content');
            let html = '';

            if (d.type === 'bundle') {
                d.children.forEach((c, idx) => {
                    let childLogsHtml = this.generateTimeline(c.logs);
                    html += `
                    <div class="child-item-card">
                        <div class="child-item-header-strip ${c.status_bg}">
                             ${c.status_icon} ${c.status_text}
                        </div>
                        <div class="child-head" onclick="DINOCO_APP_V3.toggleChild(this)">
                            ${c.img ? `<img src="${c.img}" class="w-14 h-14 object-contain rounded-lg border border-slate-100 p-1 bg-white">` : `<div class="w-14 h-14 flex items-center justify-center bg-slate-100 rounded-lg text-slate-400"><i class="fa-solid fa-cube text-xl"></i></div>`}
                            <div class="flex-1 min-w-0 ml-1">
                                <div class="text-sm font-bold text-slate-800 leading-tight mb-1">${c.name}</div>
                                <div class="text-[10px] text-slate-500 font-mono bg-slate-50 inline-block px-1.5 rounded">S/N: ${c.sn}</div>
                            </div>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-[10px] mt-1 transition-transform"></i>
                        </div>
                        <div class="child-body">
                            <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-600 mb-3 bg-white p-2 rounded border border-slate-100">
                                <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: <span class="font-bold text-slate-700">${c.reg_date}</span></div>
                                <div>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: <span class="${checkExpiryColor(c.exp_date)}">${c.exp_date}</span></div>
                            </div>
                            ${childLogsHtml}
                             <button class="btn-sales-gen w-full justify-center py-2 mt-3" onclick="event.stopPropagation(); DINOCO_APP_V3.generateSalesCard(${idx})">
                                <i class="fa-solid fa-camera"></i> ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠
                            </button>
                        </div>
                    </div>`;
                });
            } else {
                if(d.logs && d.logs.length > 0) {
                    let timelineHtml = this.generateTimeline(d.logs);
                    html += `
                    <div class="child-item-card">
                        <div class="child-head bg-slate-50" onclick="DINOCO_APP_V3.toggleChild(this)">
                            <div class="flex items-center gap-2 text-xs font-bold text-slate-700">
                                <i class="fa-solid fa-clock-rotate-left text-indigo-500"></i>
                                ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (${d.logs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                            </div>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-[10px] ml-auto transition-transform"></i>
                        </div>
                        <div class="child-body">${timelineHtml}</div>
                    </div>`;
                } else {
                    html = `<div class="text-center text-slate-400 text-xs py-4 bg-slate-50 rounded-lg border border-dashed border-slate-200">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
                }
            }
            container.innerHTML = html;
            document.querySelector('#view-assets').classList.add('hidden');
            document.querySelector('#view-passport').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        },

        goBack: function() {
            document.querySelector('#view-passport').classList.add('hidden');
            document.querySelector('#view-assets').classList.remove('hidden');
            document.querySelector('#t-phone').value = '';
            document.querySelector('#t-result-box').classList.add('hidden');
        },

        loadImage: async function(url) {
            return new Promise((resolve) => {
                let formData = new FormData();
                formData.append('action', 'dinoco_v3_proxy_image');
                formData.append('img_url', url);
                fetch('/wp-admin/admin-ajax.php', { method: 'POST', body: formData })
                .then(r => r.json()).then(res => resolve(res.success ? res.data : url))
                .catch(() => resolve(url));
            });
        },

        // Helper: Calculate Time Passed
        calcAge: function(dateStr) {
            if(!dateStr || dateStr === '-') return '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 0 ‡∏ß‡∏±‡∏ô';
            let parts = dateStr.split('/');
            if(parts.length !== 3) return '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 0 ‡∏ß‡∏±‡∏ô';
            let start = new Date(parts[2], parts[1]-1, parts[0]);
            let now = new Date();
            let diff = now - start;
            if(diff < 0) return '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 0 ‡∏ß‡∏±‡∏ô';
            
            let years = now.getFullYear() - start.getFullYear();
            let months = now.getMonth() - start.getMonth();
            let days = now.getDate() - start.getDate();
            if(days < 0) {
                months--;
                days += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            }
            if(months < 0) {
                years--;
                months += 12;
            }
            return `${years} ‡∏õ‡∏µ ${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${days} ‡∏ß‡∏±‡∏ô`;
        },

        generateSalesCard: async function(childIndex) {
            let modal = document.querySelector('#modal-sales');
            modal.style.display = 'flex';
            document.querySelector('#modal-sales-loader').classList.remove('hidden');
            document.querySelector('#modal-sales-img-wrap').classList.add('hidden');
            document.querySelector('#btn-download-sc').classList.add('hidden');

            let item = this.data;
            let isBundleItem = false;
            // If viewing a child of a bundle, treat as single item
            if (childIndex !== null && item.children && item.children[childIndex]) {
                item = item.children[childIndex];
                isBundleItem = true;
            }

            let today = new Date().toLocaleDateString('th-TH', {day: '2-digit', month:'2-digit', year:'numeric'});
            let qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent("https://dinoco.in.th/check?sn="+item.sn)}`;
            let base64QR = await this.loadImage(qrUrl);

            // Determine Target Node (Single or Bundle)
            let targetNodeId = (item.type === 'bundle' && !isBundleItem) ? 'sc-canvas-bundle' : 'sc-canvas-single';
            
            if (targetNodeId === 'sc-canvas-single') {
                // POPULATE SINGLE LAYOUT
                document.querySelector('#sc-s-owner-pic').src = DINOCO_CONFIG_V3.owner.pic;
                document.querySelector('#sc-s-owner-name').innerText = DINOCO_CONFIG_V3.owner.name;
                document.querySelector('#sc-s-owner-tel').innerText = DINOCO_CONFIG_V3.owner.phone || '-';
                document.querySelector('#sc-s-qr').src = base64QR;

                // Load Product Image
                let base64Img = await this.loadImage(item.img);
                document.querySelector('#sc-s-prod-img').src = base64Img;

                document.querySelector('#sc-s-prod-name').innerText = item.name;
                document.querySelector('#sc-s-prod-sku').innerText = 'SKU: ' + (item.sku || '-');
                document.querySelector('#sc-s-hand').innerText = item.hand_seq || '1';
                document.querySelector('#sc-s-sn').innerText = item.sn;
                document.querySelector('#sc-s-reg').innerText = item.reg_date || '-';
                document.querySelector('#sc-s-barcode').innerText = '*' + (item.sku || 'DINOCO') + '*';
                document.querySelector('#sc-s-age').innerText = this.calcAge(item.reg_date);
                document.querySelector('#sc-s-exp').innerText = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: ' + (item.exp_date || '-');
                
                // Remove "(‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)" and keep raw status text
                let rawStatus = item.status_text || 'Active';
                document.querySelector('#sc-s-status').innerText = rawStatus;
                
                document.querySelector('#sc-s-issue-date').innerText = today;

                // Logs Table
                let logsHtml = '';
                if(item.logs && item.logs.length > 0) {
                    item.logs.forEach(l => {
                        logsHtml += `<tr><td class="log-date">${l.date}</td><td class="log-desc">${l.detail}</td><td class="log-by">DINOCO</td></tr>`;
                    });
                } else {
                    logsHtml = `<tr><td colspan="3" style="text-align:center;color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</td></tr>`;
                }
                document.querySelector('#sc-s-logs-body').innerHTML = logsHtml;

            } else {
                // POPULATE BUNDLE LAYOUT
                document.querySelector('#sc-b-owner-pic').src = DINOCO_CONFIG_V3.owner.pic;
                document.querySelector('#sc-b-owner-name').innerText = DINOCO_CONFIG_V3.owner.name;
                document.querySelector('#sc-b-owner-tel').innerText = DINOCO_CONFIG_V3.owner.phone || '-';
                document.querySelector('#sc-b-qr').src = base64QR;

                let base64Img = await this.loadImage(item.img);
                document.querySelector('#sc-b-img').src = base64Img;

                document.querySelector('#sc-b-title').innerText = item.name;
                document.querySelector('#sc-b-sku').innerText = item.sku || '-';
                document.querySelector('#sc-b-log-date').innerText = today; // Just use today as log example
                document.querySelector('#sc-b-issue-date').innerText = today;

                // Child List Loop
                let childHtml = '';
                if(item.children && item.children.length > 0) {
                    for(let i=0; i<item.children.length; i++) {
                        let c = item.children[i];
                        // Async load child image inside loop might be slow, use placeholder or sync load
                        // For speed in this demo, we'll try to load or fallback. 
                        // To properly await, we map promises.
                        let cImg = await this.loadImage(c.img);
                        let cAge = this.calcAge(c.reg_date); // Calculate Age
                        
                        let historyBlock = '';
                        if(c.logs && c.logs.length > 0) {
                            let hItems = '';
                            c.logs.forEach(l => {
                                hItems += `<div class="history-item"><span class="h-date">${l.date}</span><span class="h-desc">${l.detail}</span></div>`;
                            });
                            historyBlock = `<div class="child-history"><div class="history-head">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</div>${hItems}</div>`;
                        }

                        childHtml += `
                        <div class="child-card">
                            <div class="child-img-box"><img src="${cImg}" class="child-img"></div>
                            <div class="child-info">
                                <div class="child-header">
                                    <div>
                                        <div class="child-name">${i+1}. ${c.name}</div>
                                        <div class="child-sku">SKU: ${c.sku || '-'}</div>
                                    </div>
                                    <div class="child-barcode-mini">*${c.sku || 'ITEM'}*</div>
                                </div>
                                <div class="child-stats">
                                    <div class="stat-box">
                                        <div class="stat-label">Serial No.</div>
                                        <div class="stat-val mono">${c.sn}</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-label">Warranty Expired</div>
                                        <div class="stat-val active">${c.exp_date}</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-label">Age</div>
                                        <div class="stat-val active" style="font-size:11px;">${cAge}</div>
                                    </div>
                                </div>
                                ${historyBlock}
                            </div>
                        </div>`;
                    }
                }
                document.querySelector('#sc-b-child-list').innerHTML = childHtml;
            }

            // Wait a bit for rendering
            await new Promise(r => setTimeout(r, 600));
            
            let node = document.querySelector('#' + targetNodeId + ' .cert-wrapper'); // Target the wrapper inside
            html2canvas(node, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true, 
                backgroundColor: null,
                logging: false
            }).then(canvas => {
                let imgData = canvas.toDataURL("image/png");
                let wrapper = document.querySelector('#modal-sales-img-wrap');
                wrapper.innerHTML = `<img src="${imgData}" class="w-full h-auto">`;
                wrapper.classList.remove('hidden');
                let btn = document.querySelector('#btn-download-sc');
                btn.classList.remove('hidden');
                btn.onclick = function() {
                    let link = document.createElement('a');
                    link.download = `DINOCO_CERT_${item.sn}.png`;
                    link.href = imgData;
                    link.click();
                };
                document.querySelector('#modal-sales-loader').classList.add('hidden');
            });
        },

        findUser: function(btnEl) {
            let ph = document.querySelector('#t-phone').value;
            if(ph.replace(/\D/g,'').length < 9) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

            let btn = btnEl;
            let orgText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            btn.disabled = true;

            let fd = new FormData();
            fd.append('action', 'dinoco_v3_find');
            fd.append('phone', ph);
            fd.append('security', DINOCO_CONFIG_V3.nonce);

            fetch('/wp-admin/admin-ajax.php', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(res => {
                btn.innerHTML = orgText;
                btn.disabled = false;
                if(res.success) {
                    this.targetUser = res.data;
                    document.querySelector('#t-result-box').classList.remove('hidden');
                    document.querySelector('#t-pic').src = res.data.pic;
                    document.querySelector('#t-name').innerText = res.data.display_name;
                    document.querySelector('#t-lid').innerText = 'Line: ' + res.data.line_id;
                } else {
                    alert(res.data);
                    document.querySelector('#t-result-box').classList.add('hidden');
                    this.targetUser = null; 
                }
            })
            .catch(err => {
                alert('Connection Error');
                btn.innerHTML = orgText;
                btn.disabled = false;
            });
        },

        confirmTransfer: function() {
            if(!this.targetUser) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
                return;
            }
            document.querySelector('#confirm-receiver-name').innerText = this.targetUser.display_name;
            document.querySelector('#confirm-product-name').innerText = this.data.name;
            document.querySelector('#confirm-receiver-phone').innerText = this.targetUser.phone ? this.targetUser.phone : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';

            let prodImg = document.querySelector('#confirm-product-img');
            if(this.data.img) {
                prodImg.src = this.data.img;
            } else {
                prodImg.src = "https://placehold.co/100?text=No+Img"; 
            }

            document.getElementById('chk-sn').checked = false;
            document.getElementById('chk-role').checked = false;
            document.getElementById('chk-irrev').checked = false;
            this.checkConsent();

            document.getElementById('modal-confirm-transfer').style.display = 'flex';
        },

        checkConsent: function() {
            const c1 = document.getElementById('chk-sn').checked;
            const c2 = document.getElementById('chk-role').checked;
            const c3 = document.getElementById('chk-irrev').checked;
            const btn = document.getElementById('btn-final-confirm');

            if (c1 && c2 && c3) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-slate-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-lg');
            }
        },

        finalConfirm: function() {
            let fd = new FormData();
            fd.append('action', 'dinoco_v3_exec');
            fd.append('post_id', this.data.id);
            fd.append('target_line_id', this.targetUser.line_id);
            fd.append('target_wp_uid', this.targetUser.wp_user_id);
            fd.append('security', DINOCO_CONFIG_V3.nonce);

            let btn = document.getElementById('btn-final-confirm');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
            btn.disabled = true;

            fetch('/wp-admin/admin-ajax.php', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    alert('‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                    window.location.reload();
                } else {
                    alert('Error: ' + res.data);
                    document.getElementById('modal-confirm-transfer').style.display = 'none';
                    btn.innerHTML = '<i class="fa-solid fa-shield-halved"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ)';
                    btn.disabled = false; 
                }
            })
            .catch(err => {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                btn.disabled = false;
            });
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('t-phone');
        if(phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let cursorPosition = this.selectionStart;
                let originalValue = this.value;
                let x = originalValue.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                let newValue = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
                if (newValue !== originalValue) {
                    this.value = newValue;
                }
            });
        }
    });
    </script>
    <?php
    return ob_get_clean();
}
